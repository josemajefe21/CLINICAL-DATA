<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4ade80">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bit√°cora">
  <title>CLINICAL DATA</title>
  <!-- PWA Meta Tags -->
  <meta name="description" content="Bit√°cora para seguimiento de cultivos">
  <!-- Elimino o comento la l√≠nea del manifest y el icono -->
  <!-- <link rel="manifest" href="manifest.json"> -->
  <!-- <link rel="apple-touch-icon" href="icons/icon-192.svg"> -->
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Configuraci√≥n de Firebase -->
  <script src="firebase-config.js"></script>
  <!-- Fuente divertida tipo cartoon -->
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4ade80;
      --secondary-color: #0ea5e9;
      --background-color: #f3f4f6;
      --text-color: #111827;
    }

    body {
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--background-color) 80%, #d1fae5 100%);
      padding: 20px;
      color: var(--text-color);
      min-height: 100vh;
      position: relative;
    }
    h1 {
      font-family: 'Luckiest Guy', cursive;
      font-size: 2.1em;
      margin-bottom: 10px;
      letter-spacing: 1px;
      color: #388e3c;
      text-shadow: 2px 2px 0 #fff, 0 2px 8px #a7f3d0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    h1::before {
      content: 'üå±';
      font-size: 1.2em;
      margin-right: 8px;
      -webkit-filter: drop-shadow(0 2px 2px #a7f3d0);
      filter: drop-shadow(0 2px 2px #a7f3d0);
    }
    h2 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }
    label {
      font-weight: bold;
      color: #388e3c;
      letter-spacing: 0.5px;
    }
    textarea, input[type="text"], input[type="date"] {
      width: 100%;
      margin: 5px 0 12px 0;
      padding: 10px;
      font-size: 15px;
      border-radius: 12px;
      border: 2.5px solid #a7f3d0;
      background: #f0fdf4;
      box-shadow: 0 2px 8px rgba(167, 243, 208, 0.33);
      transition: border 0.2s, box-shadow 0.2s;
    }
    textarea:focus, input[type="text"]:focus, input[type="date"]:focus {
      border: 2.5px solid #4ade80;
      box-shadow: 0 4px 16px rgba(74, 222, 128, 0.33);
      outline: none;
    }
    button {
      margin: 5px 8px 5px 0;
      padding: 8px 14px;
      font-size: 15px;
      border: none;
      border-radius: 10px 18px 10px 18px;
      background-color: #4ade80;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(167, 243, 208, 0.67);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      transition: transform 0.1s, box-shadow 0.2s;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 1px 4px rgba(167, 243, 208, 0.33);
    }
    .stage-btn {
      padding: 8px 10px;
      margin: 4px;
      font-size: 15px;
      border: 2.5px solid transparent;
      border-radius: 12px 20px 12px 20px;
      background-color: #e5e7eb;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
    }
    .stage-selected {
      border-color: #0ea5e9;
      background-color: #bae6fd;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.33);
    }
    .button-small {
      padding: 6px 10px;
      font-size: 13px;
      background-color: #0ea5e9;
      border-radius: 10px 18px 10px 18px;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
    }
    .mood-btn {
      display: inline-block;
      margin-right: 10px;
      padding: 10px 14px;
      border: 2.5px solid transparent;
      border-radius: 16px 24px 16px 24px;
      cursor: pointer;
      font-size: 18px;
      background: #e0f2fe;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      font-family: 'Quicksand', 'Segoe UI', sans-serif;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .mood-selected {
      border-color: #0ea5e9;
      background-color: #e0f2fe;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.33);
    }
    .entry {
      background: #fff;
      padding: 16px 14px 16px 24px;
      margin-bottom: 16px;
      border-radius: 24px 32px 24px 32px;
      box-shadow: 0 4px 24px rgba(167, 243, 208, 0.67), 0 1.5px 0 #4ade80;
      border-left: 8px solid #4ade80;
      position: relative;
      overflow: hidden;
    }
    .entry::before {
      content: 'üåø';
      position: absolute;
      left: 8px;
      top: -10px;
      font-size: 1.5em;
      opacity: 0.25;
      transform: rotate(-20deg);
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 12px;
      max-width: 240px;
      background: #e0f2fe;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(186, 230, 253, 0.53);
      padding: 10px 5px;
    }
    .day {
      width: 32px;
      height: 32px;
      border-radius: 10px 16px 10px 16px;
      text-align: center;
      font-size: 12px;
      line-height: 32px;
      background-color: #e5e7eb;
      color: #000;
      box-shadow: 0 1px 4px rgba(167, 243, 208, 0.33);
      border: 1.5px solid #a7f3d0;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .m1 { background-color: #f87171; }
    .m2 { background-color: #facc15; }
    .m3 { background-color: #4ade80; }
    .m4 { background-color: #22c55e; }
    /* Detalles de hojas en el fondo */
    body::after {
      content: 'üå±üåø';
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 2.5em;
      opacity: 0.13;
      pointer-events: none;
      z-index: 0;
    }
    /* --- INICIO: Estilos responsivos para m√≥vil --- */
    @media (max-width: 600px) {
      body {
        padding: 8px;
        font-size: 15px;
      }
      h1 {
        font-size: 1.3em;
        text-align: center;
      }
      h2 {
        font-size: 1.1em;
      }
      .calendar {
        max-width: 100%;
        gap: 2px;
        padding: 6px 2px;
      }
      .day {
        width: 22px;
        height: 22px;
        font-size: 8px;
        line-height: 22px;
      }
      .entry {
        padding: 10px 7px 10px 14px;
        font-size: 13px;
        border-radius: 16px 20px 16px 20px;
      }
      button, .stage-btn, .button-small {
        font-size: 13px;
        padding: 8px 8px;
        margin: 4px 4px 4px 0;
        border-radius: 10px 16px 10px 16px;
      }
      .mood-btn {
        font-size: 15px;
        padding: 7px 10px;
        margin-right: 5px;
        border-radius: 12px 18px 12px 18px;
      }
      textarea, input[type="text"], input[type="date"] {
        font-size: 13px;
        padding: 7px;
        border-radius: 10px;
      }
      #calendarVisual {
        overflow-x: auto;
      }
      
      /* Estilos responsivos para campos de cepas y luces */
      .bitacora-form-row {
        flex-direction: column;
        gap: 8px;
      }
      
      .bitacora-form-row input[type="text"] {
        flex: 1;
        min-width: 0;
        width: 100%;
      }
      
      .bitacora-form-row input[type="number"] {
        width: 80px;
        min-width: 80px;
      }
      
      .cepa-item, .carpa-item, .luz-item {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        padding: 8px;
      }
      
      .cepa-item input[type="number"], 
      .carpa-item input[type="number"] {
        width: 100%;
        margin-left: 0;
        margin-top: 4px;
      }
      
      .cepa-remove, .carpa-remove, .luz-remove {
        align-self: flex-end;
        margin-left: 0;
        margin-top: 4px;
      }
      
      /* Mejorar el layout de los campos de formulario */
      .bitacora-form-group {
        margin-bottom: 1.5rem;
      }
      
      .bitacora-form-group input[type="text"],
      .bitacora-form-group input[type="number"],
      .bitacora-form-group select {
        font-size: 16px; /* Evita zoom en iOS */
        padding: 12px;
        border-radius: 8px;
      }
      
      /* Hacer los botones m√°s grandes en m√≥vil */
      .bitacora-form-group button,
      .bitacora-form-row button {
        padding: 12px 16px;
        font-size: 16px;
        border-radius: 8px;
        min-height: 44px; /* Tama√±o m√≠nimo para touch */
      }
    }
    /* --- FIN: Estilos responsivos para m√≥vil --- */

    /* Estilos para el modal de edici√≥n */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: 50px auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 24px;
    }

    /* Estilos para el historial */
    .history-entry {
      position: relative;
    }

    .edit-button {
      position: absolute;
      right: 10px;
      top: 10px;
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Actualizar estilos del selector de bit√°coras */
    .bitacora-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 10px;
      background: #f8fafc;
      border-radius: 12px;
    }

    .bitacora-card {
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      font-weight: bold;
      min-width: 120px;
      text-align: center;
      position: relative;
    }

    .bitacora-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bitacora-card:hover .bitacora-actions {
      opacity: 1;
    }

    .action-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: transform 0.2s;
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    .edit-btn { color: #0ea5e9; }
    .delete-btn { color: #f87171; }
    .share-btn { color: #4ade80; }

    /* Modal de edici√≥n de bit√°cora */
    .edit-bitacora-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .edit-bitacora-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      margin: 50px auto;
      position: relative;
    }

    .visibility-selector {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .visibility-selector label {
      font-weight: bold;
      color: #374151;
    }

    .visibility-selector select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background-color: white;
      color: #374151;
      font-size: 14px;
    }

    .visibility-indicator {
      margin-left: 8px;
      font-size: 14px;
      opacity: 0.8;
    }

    .bitacora-card .visibility-indicator {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      opacity: 0.8;
    }

    .new-bitacora {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }

    .new-bitacora.active {
      display: block;
    }

    .new-bitacora input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .color-picker {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: #000;
      transform: scale(1.1);
    }

    .new-bitacora button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
    }

    .backup-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .backup-btn {
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      color: #374151;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .backup-btn:hover {
      background: #f1f5f9;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .backup-btn:active {
      transform: translateY(0);
    }

    .backup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .backup-modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin: 50px auto;
      position: relative;
    }

    .backup-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .backup-item {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backup-item:last-child {
      border-bottom: none;
    }

    .backup-item:hover {
      background: #f8fafc;
    }

    .backup-info {
      font-size: 14px;
      color: #374151;
    }

    .backup-actions {
      display: flex;
      gap: 5px;
    }

    .backup-actions button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      background: #f1f5f9;
      color: #374151;
    }

    .backup-actions button:hover {
      background: #e5e7eb;
    }

    .backup-actions button.restore {
      background: #4ade80;
      color: white;
    }

    .backup-actions button.delete {
      background: #f87171;
      color: white;
    }

    .credits {
      font-family: 'Quicksand', sans-serif;
      font-size: 0.9em;
      color: #4b5563;
      text-align: center;
      margin-top: -5px;
      margin-bottom: 20px;
      font-style: italic;
    }

    .help-question {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .help-question:hover {
      background: rgba(255, 255, 255, 1);
    }

    .bitacora-form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .bitacora-form-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .bitacora-form-group label {
      font-weight: 600;
      color: #388e3c;
    }
    .bitacora-form-group input[type="text"],
    .bitacora-form-group input[type="number"],
    .bitacora-form-group select {
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: 'Quicksand', sans-serif;
    }
    .bitacora-form-group input[type="text"]:focus,
    .bitacora-form-group input[type="number"]:focus,
    .bitacora-form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .bitacora-form-group button,
    .bitacora-form-row button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      transition: all 0.2s;
    }
    .bitacora-form-group button:hover,
    .bitacora-form-row button:hover {
      background-color: var(--secondary-color);
    }
    .bitacora-form-group input[type="checkbox"] {
      accent-color: var(--primary-color);
      width: 1.1em;
      height: 1.1em;
    }
    .cepa-item, .carpa-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    .cepa-item input[type="number"], .carpa-item input[type="number"] {
      width: 60px;
      margin-left: 4px;
    }
    .cepa-remove, .carpa-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    .cepa-remove:hover, .carpa-remove:hover {
      background: #ef4444;
    }
    .bitacora-form-checkboxes label {
      margin-right: 16px;
      font-weight: 500;
      color: #388e3c;
    }
    .luz-btn {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 0.5rem;
      font-size: 1.5rem;
      padding: 0.5rem 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      color: #388e3c;
    }
    .luz-btn.selected, .luz-btn:active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .luz-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    .luz-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    .luz-remove:hover {
      background: #ef4444;
    }

    /* Estilos para mostrar caracter√≠sticas de la bit√°cora */
    .bitacora-info {
      background: #fff;
      padding: 20px;
      border-radius: 16px 24px 16px 24px;
      box-shadow: 0 4px 24px rgba(167, 243, 208, 0.67), 0 1.5px 0 #4ade80;
      border-left: 8px solid #4ade80;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .bitacora-info::before {
      content: 'üìã';
      position: absolute;
      left: 8px;
      top: -10px;
      font-size: 1.5em;
      opacity: 0.25;
      transform: rotate(-20deg);
    }

    .bitacora-info h3 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 15px;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .info-section {
      background: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .info-section h4 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 8px;
      font-size: 0.9em;
      text-shadow: 1px 1px 0 #fff;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9em;
    }

    .info-value {
      color: #6b7280;
      font-size: 0.9em;
      text-align: right;
    }

    .info-value.cepa {
      background: #4ade80;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.luz {
      background: #facc15;
      color: #374151;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.riego {
      background: #0ea5e9;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.interior {
      background: #a78bfa;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.exterior {
      background: #22c55e;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .info-value.invernadero {
      background: #f472b6;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .no-info {
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Responsive para m√≥vil */
    @media (max-width: 600px) {
      .info-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .bitacora-info {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .info-section {
        padding: 10px;
      }
    }

    /* Estilos para el sistema de autenticaci√≥n */
    .auth-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f3f4f6 80%, #d1fae5 100%);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .auth-container.active {
      display: flex;
    }

    .auth-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .auth-card::before {
      content: 'üå±';
      position: absolute;
      top: -15px;
      left: 20px;
      font-size: 3em;
      opacity: 0.1;
      transform: rotate(-15deg);
    }

    .auth-card h2 {
      font-family: 'Luckiest Guy', cursive;
      color: #388e3c;
      margin-bottom: 20px;
      font-size: 1.8em;
      text-shadow: 1px 1px 0 #fff, 0 1px 4px #a7f3d0;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .auth-form input {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Quicksand', sans-serif;
      transition: all 0.3s;
    }

    .auth-form input:focus {
      outline: none;
      border-color: #4ade80;
      box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
    }

    .auth-btn {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Quicksand', sans-serif;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 222, 128, 0.3);
    }

    .auth-btn:active {
      transform: translateY(0);
    }

    .auth-btn.secondary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    .auth-btn.secondary:hover {
      box-shadow: 0 5px 15px rgba(14, 165, 233, 0.3);
    }

    .auth-switch {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }

    .auth-switch a {
      color: #4ade80;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-switch a:hover {
      text-decoration: underline;
    }

    .user-info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 100;
      font-family: 'Quicksand', sans-serif;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .user-details {
      display: flex;
      flex-direction: column;
    }

    .user-email {
      font-size: 12px;
      color: #6b7280;
    }

    .user-name {
      font-weight: 600;
      color: #374151;
    }

    .logout-btn {
      background: #f87171;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #ef4444;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4ade80;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .success-message {
      background: #f0fdf4;
      color: #16a34a;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      margin-bottom: 15px;
      font-size: 14px;
    }

    /* Responsive para m√≥vil */
    @media (max-width: 600px) {
      .auth-card {
        margin: 20px;
        padding: 20px;
      }
      
      .user-info {
        top: 10px;
        left: 10px;
        right: 10px;
        padding: 8px 12px;
      }
    }

    .extractor-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 6px 10px;
      margin-bottom: 4px;
    }
    
    .extractor-remove {
      background: #f87171;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0 10px;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 6px;
    }
    
    .extractor-remove:hover {
      background: #ef4444;
    }

    body.dark-mode {
      background: #18181b !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode label, body.dark-mode .info-label {
      color: #a7f3d0 !important;
      border-color: #4ade80 !important;
      text-shadow: none !important;
    }
    body.dark-mode .entry, body.dark-mode .bitacora-info, body.dark-mode .info-section, body.dark-mode .auth-card, body.dark-mode .user-info, body.dark-mode .modal-content, body.dark-mode .edit-bitacora-content, body.dark-mode .backup-modal-content, body.dark-mode .new-bitacora, body.dark-mode .bitacora-selector, body.dark-mode .calendar, body.dark-mode .day, body.dark-mode .credits {
      background: #22223b !important;
      color: #f3f4f6 !important;
      box-shadow: 0 4px 24px rgba(30,41,59,0.67), 0 1.5px 0 #4ade80;
    }
    body.dark-mode .bitacora-card {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .bitacora-card.active {
      border-color: #facc15 !important;
    }
    body.dark-mode .calendar, body.dark-mode .day {
      background: #22223b !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .m1 { background-color: #b91c1c !important; }
    body.dark-mode .m2 { background-color: #ca8a04 !important; }
    body.dark-mode .m3 { background-color: #16a34a !important; }
    body.dark-mode .m4 { background-color: #166534 !important; }
    body.dark-mode .backup-btn, body.dark-mode button, body.dark-mode .stage-btn, body.dark-mode .button-small {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .backup-btn:hover, body.dark-mode button:hover, body.dark-mode .stage-btn:hover, body.dark-mode .button-small:hover {
      background: #4ade80 !important;
      color: #18181b !important;
    }
    body.dark-mode .modal, body.dark-mode .backup-modal {
      background: rgba(24,24,27,0.85) !important;
    }
    body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
      background: #18181b !important;
      color: #f3f4f6 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode input::placeholder, body.dark-mode textarea::placeholder {
      color: #a7f3d0 !important;
      opacity: 0.7;
    }
    body.dark-mode .extractor-item, body.dark-mode .cepa-item, body.dark-mode .carpa-item, body.dark-mode .luz-item {
      background: #334155 !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .error-message {
      background: #7f1d1d !important;
      color: #fca5a5 !important;
      border-color: #f87171 !important;
    }
    body.dark-mode .success-message {
      background: #14532d !important;
      color: #bbf7d0 !important;
      border-color: #4ade80 !important;
    }
    body.dark-mode .color-option {
      border-color: #4ade80 !important;
    }
    body.dark-mode .color-option.selected {
      border-color: #facc15 !important;
    }
    body.dark-mode .auth-switch a {
      color: #4ade80 !important;
    }
    body.dark-mode .user-avatar {
      background: linear-gradient(135deg, #334155, #4ade80) !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .logout-btn {
      background: #b91c1c !important;
      color: #fff !important;
    }
    body.dark-mode .logout-btn:hover {
      background: #ef4444 !important;
      color: #fff !important;
    }
    body.dark-mode .help-question {
      background: #334155 !important;
      color: #f3f4f6 !important;
      border: 2px solid #4ade80 !important;
    }
    body.dark-mode .modal-content, body.dark-mode .edit-bitacora-content, body.dark-mode .backup-modal-content {
      background: #18181b !important;
      color: #f3f4f6 !important;
    }
    body.dark-mode .info-value {
      color: #bbf7d0 !important;
    }
    body.dark-mode .info-value.cepa {
      background: #16a34a !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.luz {
      background: #facc15 !important;
      color: #22223b !important;
    }
    body.dark-mode .info-value.riego {
      background: #0ea5e9 !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.interior {
      background: #a78bfa !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.exterior {
      background: #22c55e !important;
      color: #fff !important;
    }
    body.dark-mode .info-value.invernadero {
      background: #f472b6 !important;
      color: #fff !important;
    }
    body.dark-mode .no-info {
      color: #a7f3d0 !important;
    }
    .login-input {
      max-width: 300px;
      width: 100%;
      margin: 0 auto 10px auto;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Sistema de Autenticaci√≥n (solo login, sin registro) -->
  <div class="auth-container" id="authContainer">
    <div class="auth-card" id="loginCard">
      <h2>üë®‚Äç‚öïÔ∏è Iniciar Sesi√≥n M√©dico</h2>
      <form class="auth-form" id="loginForm">
        <div id="loginError" class="error-message" style="display: none;"></div>
        <input type="text" id="loginUser" placeholder="Usuario" required style="max-width:220px;width:100%;margin:0 auto 10px auto;display:block;">
        <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
        <button type="submit" class="auth-btn" id="loginBtn">
          <span id="loginBtnText">Iniciar Sesi√≥n</span>
          <span id="loginBtnLoading" class="loading" style="display: none;"></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Informaci√≥n del Usuario -->
  <div class="user-info" id="userInfo" style="display: none;">
    <div class="user-avatar" id="userAvatar">M</div>
    <div class="user-details">
      <div class="user-name" id="userName">M√©dico</div>
      <div class="user-email" id="userEmail">medico@clinicadata.com</div>
    </div>
    <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
  </div>

  <div class="container">
    <h1>CLINICAL DATA ü©∫</h1>
    <div class="credits">Gesti√≥n cl√≠nica de pacientes</div>

    <!-- Secci√≥n de Pacientes -->
    <div class="pacientes-section">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="busquedaPaciente" placeholder="Buscar por nombre, DNI o patolog√≠a..." style="flex:1;" oninput="filtrarPacientes()">
        <button onclick="mostrarFormularioPaciente()">‚ûï Nuevo paciente</button>
      </div>
      <div id="listaPacientes">
        <!-- Aqu√≠ se listar√°n los pacientes -->
      </div>
    </div>

    <!-- Formulario de nuevo/editar paciente (modal) -->
    <div class="modal" id="modalPaciente">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarModalPaciente()">&times;</span>
        <h3 id="tituloModalPaciente">Nuevo Paciente</h3>
        <form id="formPaciente">
          <input type="hidden" id="pacienteId">
          <label>Nombre completo</label>
          <input type="text" id="pacienteNombre" required>
          <label>DNI</label>
          <input type="text" id="pacienteDNI" required>
          <label>Direcci√≥n</label>
          <input type="text" id="pacienteDireccion">
          <label>Tel√©fono</label>
          <input type="text" id="pacienteTelefono">
          <label>Obra social</label>
          <input type="text" id="pacienteObraSocial">
          <label>Patolog√≠a (diagn√≥stico presuntivo)</label>
          <input type="text" id="pacientePatologia">
          <button type="submit">Guardar</button>
        </form>
      </div>
    </div>

    <!-- Ficha cl√≠nica del paciente seleccionado -->
    <div id="fichaPaciente" style="display:none; margin-top:30px;">
      <button onclick="volverAListaPacientes()">‚Üê Volver a pacientes</button>
      <h2 id="nombreFichaPaciente"></h2>
      <div id="datosPaciente"></div>
      <div style="margin-top:20px;">
        <h3>Estudios y Archivos</h3>
        <form id="formEstudio" enctype="multipart/form-data">
          <input type="text" id="nombreEstudio" placeholder="Nombre del estudio">
          <input type="file" id="archivoEstudio" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
          <button type="submit">Subir estudio</button>
        </form>
        <div id="listaEstudios"></div>
      </div>
      <div style="margin-top:20px;">
        <h3>Historial de Visitas</h3>
        <button onclick="mostrarFormularioVisita()">‚ûï Nueva visita</button>
        <div id="estadisticasVisitas"></div>
        <div id="historialVisitas"></div>
      </div>
      <div style="margin-top:20px;">
        <button onclick="exportarHistoriaClinica('json')">Exportar JSON</button>
        <button onclick="exportarHistoriaClinica('pdf')">Exportar PDF</button>
      </div>
    </div>

    <!-- Formulario de nueva/editar visita (modal) -->
    <div class="modal" id="modalVisita">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarModalVisita()">&times;</span>
        <h3 id="tituloModalVisita">Nueva Visita</h3>
        <form id="formVisita">
          <input type="hidden" id="visitaId">
          <label>Fecha</label>
          <input type="date" id="visitaFecha" required>
          <label>Tipo de visita</label>
          <select id="visitaTipo">
            <option value="primera consulta">Primera consulta</option>
            <option value="seguimiento">Seguimiento</option>
            <option value="urgencia">Urgencia</option>
            <option value="control">Control</option>
            <option value="otro">Otro</option>
          </select>
          <label>Estado cl√≠nico</label>
          <select id="visitaEstado">
            <option value="estable">Estable</option>
            <option value="cr√≠tico">Cr√≠tico</option>
            <option value="en observaci√≥n">En observaci√≥n</option>
            <option value="dado de alta">Dado de alta</option>
          </select>
          <label>Observaciones</label>
          <textarea id="visitaObservaciones"></textarea>
          <label>Problemas reportados</label>
          <textarea id="visitaProblemas"></textarea>
          <label>Tratamiento / receta / tareas</label>
          <textarea id="visitaTratamiento"></textarea>
          <button type="submit">Guardar visita</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Variables globales del sistema de autenticaci√≥n
    let currentUser = null;
    let isAuthenticated = false;

    // Registrar el Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registrado:', registration);
          })
          .catch(error => {
            console.log('Error al registrar ServiceWorker:', error);
          });
      });
    }

    // Manejar la instalaci√≥n de la PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Variables globales
    let selectedBitacora = null;
    let selectedMood = null;
    let selectedStage = 'vege';
    let didWater = false;
    let tipoLuz = '';
    let luces = [];
    let extractores = [];

    const moodStates = [
      { value: 1, icon: 'üòû', label: 'Mal d√≠a', color: '#f87171' },
      { value: 2, icon: '‚ö†Ô∏è', label: 'Regular', color: '#facc15' },
      { value: 3, icon: 'üåø', label: 'Bueno', color: '#4ade80' },
      { value: 4, icon: 'üåû', label: 'Muy bueno', color: '#22c55e' }
    ];

    const availableColors = [
      '#4ade80', '#0ea5e9', '#f87171', '#facc15',
      '#a78bfa', '#f472b6', '#60a5fa', '#34d399'
    ];

    // ===== FUNCI√ìN DE GUARDADO AUTOM√ÅTICO =====
    async function autoSave() {
      if (!currentUser || !selectedBitacora) return;
      
      try {
        await saveBitacoraToFirestore(selectedBitacora);
        console.log('Guardado autom√°tico completado');
      } catch (error) {
        console.error('Error en guardado autom√°tico:', error);
      }
    }

    // ===== SISTEMA DE AUTENTICACI√ìN =====

    // Observar cambios en el estado de autenticaci√≥n
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usuario autenticado
        currentUser = user;
        isAuthenticated = true;
        showUserInfo(user);
        hideAuthContainer();
        loadUserData();
      } else {
        // Usuario no autenticado
        currentUser = null;
        isAuthenticated = false;
        hideUserInfo();
        showAuthContainer();
        clearUserData();
      }
    });

    // Funciones de autenticaci√≥n
    function showAuthContainer() {
      document.getElementById('authContainer').classList.add('active');
      document.querySelector('.container').style.display = 'none';
    }

    function hideAuthContainer() {
      document.getElementById('authContainer').classList.remove('active');
      document.querySelector('.container').style.display = 'block';
    }

    function showUserInfo(user) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');

      // Mostrar informaci√≥n del usuario
      userInfo.style.display = 'flex';
      
      // Avatar con iniciales
      const displayName = user.displayName || user.email.split('@')[0];
      userAvatar.textContent = displayName.charAt(0).toUpperCase();
      
      // Nombre y email
      userName.textContent = displayName;
      userEmail.textContent = user.email;
    }

    function hideUserInfo() {
      var el = document.getElementById('userInfo');
      if (el) el.style.display = 'none';
    }

    function showLogin() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('registerCard').style.display = 'none';
      clearAuthErrors();
    }

    function showRegister() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
      clearAuthErrors();
    }

    function clearAuthErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loginBtnLoading = document.getElementById('loginBtnLoading');
      const loginError = document.getElementById('loginError');

      // Mostrar loading
      loginBtn.disabled = true;
      loginBtnText.style.display = 'none';
      loginBtnLoading.style.display = 'inline-block';
      loginError.style.display = 'none';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de login:', error);
        loginError.textContent = getErrorMessage(error.code);
        loginError.style.display = 'block';
      } finally {
        // Ocultar loading
        loginBtn.disabled = false;
        loginBtnText.style.display = 'inline';
        loginBtnLoading.style.display = 'none';
      }
    });

    // Registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      const registerBtn = document.getElementById('registerBtn');
      const registerBtnText = document.getElementById('registerBtnText');
      const registerBtnLoading = document.getElementById('registerBtnLoading');
      const registerError = document.getElementById('registerError');

      // Validar contrase√±as
      if (password !== confirmPassword) {
        registerError.textContent = 'Las contrase√±as no coinciden';
        registerError.style.display = 'block';
        return;
      }

      // Mostrar loading
      registerBtn.disabled = true;
      registerBtnText.style.display = 'none';
      registerBtnLoading.style.display = 'inline-block';
      registerError.style.display = 'none';

      try {
        // Crear usuario
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Actualizar perfil
        await userCredential.user.updateProfile({
          displayName: name
        });

        // Crear documento de usuario en Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Migrar datos locales si existen
        await migrateLocalData(userCredential.user.uid);

      } catch (error) {
        console.error('Error de registro:', error);
        registerError.textContent = getErrorMessage(error.code);
        registerError.style.display = 'block';
      } finally {
        // Ocultar loading
        registerBtn.disabled = false;
        registerBtnText.style.display = 'inline';
        registerBtnLoading.style.display = 'none';
      }
    });

    // Logout
    async function logout() {
      try {
        await auth.signOut();
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de logout:', error);
        alert('Error al cerrar sesi√≥n');
      }
    }

    // Obtener mensaje de error amigable
    function getErrorMessage(errorCode) {
      const errorMessages = {
        'auth/user-not-found': 'No existe una cuenta con este email',
        'auth/wrong-password': 'Contrase√±a incorrecta',
        'auth/email-already-in-use': 'Este email ya est√° registrado',
        'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
        'auth/invalid-email': 'Email inv√°lido',
        'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde',
        'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet'
      };
      return errorMessages[errorCode] || 'Error desconocido. Intenta de nuevo';
    }

    // ===== GESTI√ìN DE DATOS CON FIRESTORE =====

    // Cargar datos del usuario
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
          // Actualizar √∫ltimo login
          await db.collection('users').doc(currentUser.uid).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Cargar bit√°coras del usuario
        await loadUserBitacoras();
        
      } catch (error) {
        console.error('Error al cargar datos del usuario:', error);
      }
    }

    // Cargar bit√°coras del usuario
    async function loadUserBitacoras() {
      if (!currentUser) return;

      try {
        const bitacorasSnapshot = await db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').get();

        const bitacoras = [];
        bitacorasSnapshot.forEach(doc => {
          bitacoras.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Guardar en localStorage para compatibilidad
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        // Renderizar selector de bit√°coras
        renderBitacoraSelector();
        
        // Seleccionar primera bit√°cora si existe
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }

      } catch (error) {
        console.error('Error al cargar bit√°coras:', error);
      }
    }

    // Guardar bit√°cora en Firestore
    async function saveBitacoraToFirestore(bitacora) {
      if (!currentUser) return;

      try {
        const bitacoraRef = db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').doc(bitacora.id);
        
        await bitacoraRef.set({
          ...bitacora,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Bit√°cora guardada en Firestore');
      } catch (error) {
        console.error('Error al guardar bit√°cora:', error);
        throw error;
      }
    }

    // Migrar datos locales a Firestore
    async function migrateLocalData(userId) {
      try {
        const localBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        
        if (localBitacoras.length > 0) {
          const batch = db.batch();
          
          for (const bitacora of localBitacoras) {
            const bitacoraRef = db.collection('users').doc(userId)
              .collection('bitacoras').doc(bitacora.id);
            
            batch.set(bitacoraRef, {
              ...bitacora,
              migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          await batch.commit();
          console.log('Datos migrados exitosamente');
        }
      } catch (error) {
        console.error('Error al migrar datos:', error);
      }
    }

    // Limpiar datos del usuario
    function clearUserData() {
      var el = document.getElementById('userInfo');
      if (el) el.style.display = 'none';
      localStorage.removeItem('bitacoras');
      localStorage.removeItem('bitacora_backups');
      selectedBitacora = null;
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('bitacoraSelector').innerHTML = '';
    }

    // ===== FUNCIONES MODIFICADAS PARA FIRESTORE =====

    // Modificar createNewBitacora para usar Firestore
    async function createNewBitacora() {
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para crear una bit√°cora');
        return;
      }

      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      
      // Verificar si ya existe una bit√°cora con ese nombre
      const existingBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      if (existingBitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar caracter√≠sticas (c√≥digo existente)
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar carpas con metros cuadrados
      const carpas = [];
      document.querySelectorAll('#carpasList .carpa-item input[type="number"]').forEach(input => {
        if (input.value) {
          carpas.push({ metrosCuadrados: parseFloat(input.value) });
        }
      });
      
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        userId: currentUser.uid,
        // Caracter√≠sticas de la bit√°cora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        carpas: carpas,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        extractores: [...extractores],
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        },
        createdAt: new Date().toISOString()
      };

      try {
        // Guardar en Firestore
        await saveBitacoraToFirestore(newBitacora);
        
        // Actualizar localStorage
        existingBitacoras.push(newBitacora);
        localStorage.setItem('bitacoras', JSON.stringify(existingBitacoras));
        
        // Limpiar formulario
        document.getElementById('newBitacoraName').value = '';
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('newBitacoraForm').classList.remove('active');
        
        // Limpiar variables globales
        cepas = [];
        extractores = [];
        luces = [];
        tipoLuz = '';
        
        // Actualizar UI
        renderBitacoraSelector();
        selectBitacora(newBitacora.id);
        
      } catch (error) {
        console.error('Error al crear bit√°cora:', error);
        alert('Error al crear la bit√°cora. Intenta de nuevo.');
      }
    }

    // Modificar saveEntry para usar Firestore
    async function saveEntry() {
      if (!selectedBitacora || !currentUser) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Eleg√≠ fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value,
        createdAt: new Date().toISOString()
      };

      try {
        // Actualizar en localStorage
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        
        if (bitacoraIndex !== -1) {
          let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
          entries.push(entry);
          bitacoras[bitacoraIndex].entries[selectedStage] = entries;
          
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          selectedBitacora = bitacoras[bitacoraIndex];
          
          // Guardar en Firestore
          await saveBitacoraToFirestore(selectedBitacora);
          
          // Actualizar UI
          renderHistory();
          renderCalendar();
          updateWeeklySummary();
        }
      } catch (error) {
        console.error('Error al guardar entrada:', error);
        alert('Error al guardar la entrada. Intenta de nuevo.');
      }
    }

    // Funciones auxiliares
    function getEntries() {
      if (!selectedBitacora) return [];
      return selectedBitacora.entries[selectedStage] || [];
    }

    function updateWeeklySummary() {
      if (!selectedBitacora) return;

      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());

      const weekEntries = getEntries().filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate >= weekStart && entryDate <= today;
      });

      document.getElementById('totalEntries').textContent = weekEntries.length;
      
      const moods = weekEntries.map(e => e.mood).filter(m => m);
      const avgMood = moods.length ? (moods.reduce((a, b) => a + b, 0) / moods.length).toFixed(1) : '-';
      document.getElementById('averageMood').textContent = avgMood;
      
      const wateredDays = weekEntries.filter(e => e.didWater).length;
      document.getElementById('wateredDays').textContent = wateredDays;

      const timeline = document.getElementById('emotionTimeline');
      timeline.innerHTML = weekEntries.map(entry => `
        <div class="emotion-dot" style="background-color: ${moodStates.find(m => m.value === entry.mood)?.color}"
             title="${entry.date}"></div>
      `).join('');
    }

    function renderHistory() {
      const entries = getEntries().sort((a,b) => new Date(b.date) - new Date(a.date));
      const container = document.getElementById('history');
      container.innerHTML = '';
      const floraStart = selectedBitacora?.floraStart;

      entries.forEach(e => {
        let diaFlora = '';
        if (selectedStage === 'flora' && floraStart) {
          const start = new Date(floraStart);
          const actual = new Date(e.date);
          const diff = Math.floor((actual - start) / (1000 * 60 * 60 * 24)) + 1;
          diaFlora = ` ‚Äî D√≠a ${diff} de flora`;
        }

        const moodEmoji = moodStates.find(m => m.value === e.mood)?.icon || '';
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <button class="edit-button" onclick="editEntry('${e.date}')">‚úèÔ∏è</button>
          <strong>${e.date}</strong> ‚Äî ${moodEmoji} ${diaFlora}<br/>
          <b>Tareas:</b> ${e.tasks}<br/>
          <b>Riego:</b> ${e.didWater ? 'S√≠' : 'No'} ${e.didWater ? `
            <br/>üíß ${e.waterAmount} | üß¥ ${e.nutrients} | ‚öóÔ∏è pH: ${e.ph} | üìà EC: ${e.ec}` : ''}
          <br/><b>Problemas:</b> ${e.issues}
          <br/><b>Notas:</b> ${e.notes}`;
        container.appendChild(div);
      });
    }

    function renderCalendar() {
      const entries = getEntries();
      const map = {};
      entries.forEach(e => { map[e.date] = e.mood; });

      const container = document.getElementById('calendarVisual');
      container.innerHTML = '<div class="calendar">';
      for (let i = 34; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        const mood = map[k];
        const cls = mood ? 'm' + mood : '';
        container.innerHTML += `<div class="day ${cls}" title="${k}"></div>`;
      }
      container.innerHTML += '</div>';
    }

    // Funciones de gesti√≥n de bit√°coras
    function createNewBitacora() {
      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      
      if (bitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar todas las caracter√≠sticas de la bit√°cora
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar tipo de riego
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        // Caracter√≠sticas de la bit√°cora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        }
      };

      bitacoras.push(newBitacora);
      localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
      
      document.getElementById('newBitacoraName').value = '';
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('newBitacoraForm').classList.remove('active');
      
      renderBitacoraSelector();
      selectBitacora(newBitacora.id);
    }

    function renderBitacoraSelector() {
      const container = document.getElementById('bitacoraSelector');
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      
      container.innerHTML = '';
      
      const newButton = document.createElement('button');
      newButton.className = 'bitacora-card';
      newButton.style.backgroundColor = '#e5e7eb';
      newButton.style.color = '#374151';
      newButton.innerHTML = '+ Nueva Bit√°cora';
      newButton.id = 'btnNuevaBitacora';
      newButton.onclick = toggleNewBitacoraForm;
      container.appendChild(newButton);
      
      bitacoras.forEach(bitacora => {
        const div = document.createElement('div');
        div.className = `bitacora-card ${bitacora.id === selectedBitacora?.id ? 'active' : ''}`;
        div.style.backgroundColor = bitacora.color;
        div.style.color = '#fff';
        
        // Contenedor para el nombre y estado de visibilidad
        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          ${bitacora.name}
          <span class="visibility-indicator" title="${bitacora.isPublic ? 'P√∫blica: Cualquiera con el enlace puede ver y compartir esta bit√°cora.' : 'Privada: Solo t√∫ puedes ver esta bit√°cora.'}">
            ${bitacora.isPublic ? 'üåê' : 'üîí'}
          </span>
        `;
        div.appendChild(nameDiv);
        
        // Contenedor para los botones de acci√≥n
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'bitacora-actions';
        
        // Bot√≥n de editar
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditBitacoraModal(bitacora);
        };
        
        // Bot√≥n de eliminar
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('¬øEst√°s seguro de que quieres eliminar esta bit√°cora?')) {
            deleteBitacora(bitacora.id);
          }
        };
        
        // Bot√≥n de compartir
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share-btn';
        shareBtn.innerHTML = 'üì§';
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          if (!bitacora.isPublic) {
            alert('Esta bit√°cora es privada. C√°mbiala a p√∫blica para poder compartirla.');
            return;
          }
          shareBitacora(bitacora);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsDiv.appendChild(shareBtn);
        div.appendChild(actionsDiv);
        
        div.onclick = () => selectBitacora(bitacora.id);
        container.appendChild(div);
      });
    }

    function showNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      form.classList.add('active');
      document.getElementById('newBitacoraName').value = '';
      renderColorPicker();
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      
      // Limpiar cepas
      cepas = [];
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      
      // Limpiar tipo de cultivo
      document.getElementById('tipoCultivo').value = '';
      document.getElementById('interiorFields').style.display = 'none';
      document.getElementById('numCarpas').value = 0;
      document.getElementById('soloSala').checked = false;
      document.getElementById('carpasList').innerHTML = '';
      
      // Limpiar equipamiento interior
      document.getElementById('lamparasVege').value = 0;
      document.getElementById('wattsVege').value = '';
      document.getElementById('lamparasFlora').value = 0;
      document.getElementById('wattsFlora').value = '';
      document.getElementById('ventiladores').value = 0;
      document.getElementById('pulgadasVentilador').value = '';
      
      // Limpiar extractores
      extractores = [];
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      
      document.getElementById('filtroAire').value = 'no';
      document.getElementById('aireAcondicionado').value = 'no';
      document.getElementById('frigorias').value = '';
      document.getElementById('frigorias').style.display = 'none';
      
      // Limpiar riego
      document.querySelectorAll('#riegoOptions input[type=checkbox]').forEach(cb => cb.checked = false);
      document.getElementById('detalleRiego').value = '';
      document.getElementById('sustrato').value = '';
      
      // Limpiar luces
      tipoLuz = '';
      luces = [];
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
    }

    function renderColorPicker() {
      const colorPicker = document.getElementById('colorPicker');
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option" style="background-color: ${color}" onclick="selectColor(this)"></div>
      `).join('');
    }

    function selectColor(element) {
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
    }

    let cepas = [];
    function addCepa() {
      const nombre = document.getElementById('cepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('cepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('cepaTipo').value;
      const germinacion = document.getElementById('cepaGerminacion').value;
      
      if (!nombre) return;
      
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      
      cepas.push(cepa);
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      document.getElementById('cepaNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function removeCepa(index) {
      cepas.splice(index, 1);
      renderCepasList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function renderCepasList() {
      const list = document.getElementById('cepasList');
      list.innerHTML = '';
      cepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo})`;
        if (cepa.germinacion) {
          info += ` - Germinaci√≥n: ${cepa.germinacion}`;
        }
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Funciones para extractores
    function addExtractor() {
      const cantidad = parseInt(document.getElementById('extractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('extractorPulgadas').value.trim();
      
      if (!pulgadas) return;
      
      extractores.push({ cantidad, pulgadas });
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      document.getElementById('extractorPulgadas').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function removeExtractor(index) {
      extractores.splice(index, 1);
      renderExtractoresList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function renderExtractoresList() {
      const list = document.getElementById('extractoresList');
      list.innerHTML = '';
      extractores.forEach((extractor, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${extractor.cantidad} de ${extractor.pulgadas}"</span> <button class='extractor-remove' onclick='removeExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function selectBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      selectedBitacora = bitacoras.find(b => b.id === id);
      
      if (selectedBitacora) {
        document.getElementById('mainContent').style.display = 'block';
        renderBitacoraSelector();
        setStage('vege');
        renderMoodButtons();
        renderHistory();
        renderCalendar();
        updateWeeklySummary();
      }
    }

    // Funciones de estado y renderizado
    function setStage(stage) {
      selectedStage = stage;
      document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('stage-selected'));
      document.getElementById('btn-' + stage).classList.add('stage-selected');
      
      
      // Mostrar/ocultar elementos seg√∫n la etapa
      const floraStartContainer = document.getElementById('floraStartContainer');
      const bitacoraInfo = document.getElementById('bitacoraInfo');
      const entryForm = document.getElementById('entryForm');
      
      floraStartContainer.style.display = stage === 'flora' ? 'block' : 'none';
      
      if (stage === 'general') {
        bitacoraInfo.style.display = 'block';
        if (entryForm) entryForm.style.display = 'none';
        renderBitacoraInfo();
      } else {
        bitacoraInfo.style.display = 'none';
        if (entryForm) entryForm.style.display = 'block';
      }
      
      renderHistory();
      renderCalendar();
      updateWeeklySummary();
    }

    function setMood(m) {
      selectedMood = m;
      renderMoodButtons();
    }

    function renderMoodButtons() {
      const div = document.getElementById('moodOptions');
      div.innerHTML = '';
      moodStates.forEach(state => {
        const span = document.createElement('span');
        span.className = 'mood-btn' + (selectedMood === state.value ? ' mood-selected' : '');
        span.innerText = `${state.icon} ${state.label}`;
        span.onclick = () => setMood(state.value);
        div.appendChild(span);
      });
    }

    function setWater(val) {
      didWater = val;
      document.getElementById('waterDetails').style.display = val ? 'block' : 'none';
    }

    function setFloraStart() {
      if (selectedBitacora) {
        selectedBitacora.floraStart = document.getElementById('floraStart').value;
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const index = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        if (index !== -1) {
          bitacoras[index] = selectedBitacora;
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        }
      }
    }

    function saveEntry() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Eleg√≠ fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value
      };

      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
      
      if (bitacoraIndex !== -1) {
        let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
      entries.push(entry);
        bitacoras[bitacoraIndex].entries[selectedStage] = entries;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        selectedBitacora = bitacoras[bitacoraIndex];
        
      renderHistory();
      renderCalendar();
        updateWeeklySummary();
      }
    }

    function editEntry(date) {
      const modal = document.getElementById('editModal');
      modal.style.display = 'block';
      
      document.getElementById('editPassword').value = '';
      document.getElementById('editForm').style.display = 'none';
    }

    function verifyEditPassword() {
      const password = document.getElementById('editPassword').value;
      if (password === 'FUCK I MISS') {
        document.getElementById('editForm').style.display = 'block';
        // Aqu√≠ cargar√≠amos los datos de la entrada para editar
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function exportData() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }
      
      const data = {
        bitacora: selectedBitacora,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bitacora_${selectedBitacora.name}_export.json`;
      a.click();
    }

    function showEditBitacoraModal(bitacora) {
      const modal = document.getElementById('editBitacoraModal');
      const nameInput = document.getElementById('editBitacoraName');
      const colorPicker = document.getElementById('editColorPicker');
      
      nameInput.value = bitacora.name;
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option ${color === bitacora.color ? 'selected' : ''}" 
             style="background-color: ${color}" 
             onclick="selectEditColor(this)"></div>
      `).join('');

      // Agregar el selector de visibilidad
      const visibilityDiv = document.createElement('div');
      visibilityDiv.className = 'visibility-selector';
      visibilityDiv.innerHTML = `
        <label>Visibilidad:</label>
        <select id="editBitacoraVisibility">
          <option value="false" ${!bitacora.isPublic ? 'selected' : ''}>Privada</option>
          <option value="true" ${bitacora.isPublic ? 'selected' : ''}>P√∫blica</option>
        </select>
      `;
      modal.querySelector('.edit-bitacora-content').insertBefore(
        visibilityDiv,
        modal.querySelector('.edit-bitacora-content button')
      );
      
      modal.dataset.bitacoraId = bitacora.id;
      modal.style.display = 'block';
    }

    function closeEditBitacoraModal() {
      document.getElementById('editBitacoraModal').style.display = 'none';
    }

    function selectEditColor(element) {
      document.querySelectorAll('#editColorPicker .color-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }

    function saveBitacoraEdit() {
      const modal = document.getElementById('editBitacoraModal');
      const bitacoraId = modal.dataset.bitacoraId;
      const newName = document.getElementById('editBitacoraName').value.trim();
      const selectedColor = document.querySelector('#editColorPicker .color-option.selected');
      const isPublic = document.getElementById('editBitacoraVisibility').value === 'true';
      
      if (!newName) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }
      
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const index = bitacoras.findIndex(b => b.id === bitacoraId);
      
      if (index !== -1) {
        // Verificar si el nuevo nombre ya existe
        if (bitacoras.some(b => b.id !== bitacoraId && b.name.toLowerCase() === newName.toLowerCase())) {
          alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
          return;
        }
        
        bitacoras[index].name = newName;
        bitacoras[index].color = selectedColor.style.backgroundColor;
        bitacoras[index].isPublic = isPublic;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        if (selectedBitacora?.id === bitacoraId) {
          selectedBitacora = bitacoras[index];
        }
        
        renderBitacoraSelector();
        closeEditBitacoraModal();
      }
    }

    function deleteBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const newBitacoras = bitacoras.filter(b => b.id !== id);
      
      localStorage.setItem('bitacoras', JSON.stringify(newBitacoras));
      
      if (selectedBitacora?.id === id) {
        selectedBitacora = null;
        document.getElementById('mainContent').style.display = 'none';
      }
      
      renderBitacoraSelector();
    }

    function shareBitacora(bitacora) {
      // Crear un objeto con los datos necesarios para compartir
      const shareData = {
        id: bitacora.id,
        name: bitacora.name,
        entries: bitacora.entries
      };
      
      // Convertir a base64 para el link
      const encodedData = btoa(JSON.stringify(shareData));
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
      
      // Crear el mensaje para WhatsApp
      const message = `¬°Mira mi bit√°cora "${bitacora.name}"!\n${shareUrl}`;
      
      // Abrir WhatsApp con el mensaje
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Inicializaci√≥n
    (function init() {
      renderBitacoraSelector();
      
      // Verificar si hay un link compartido
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('share');
      
      if (sharedData) {
        try {
          const decodedData = JSON.parse(atob(sharedData));
          // Crear una nueva bit√°cora con los datos compartidos
          const newBitacora = {
            id: Date.now().toString(),
            name: `${decodedData.name} (Compartida)`,
            color: availableColors[Math.floor(Math.random() * availableColors.length)],
            floraStart: null,
            isPublic: true,
            entries: decodedData.entries
          };
          
          const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
          bitacoras.push(newBitacora);
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          
          // Limpiar la URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Seleccionar la nueva bit√°cora
          selectBitacora(newBitacora.id);
        } catch (error) {
          console.error('Error al procesar datos compartidos:', error);
        }
      } else {
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }
      }
    })();

    // Funciones de respaldo
    function createBackup() {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const backup = {
        timestamp: new Date().toISOString(),
        data: bitacoras
      };
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.unshift(backup);
      
      // Mantener solo los √∫ltimos 10 respaldos
      if (backups.length > 10) {
        backups.pop();
      }
      
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      alert('Respaldo creado exitosamente');
    }

    function showBackups() {
      const modal = document.getElementById('backupModal');
      const backupList = document.getElementById('backupList');
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      
      backupList.innerHTML = backups.map((backup, index) => {
        const date = new Date(backup.timestamp);
        const formattedDate = date.toLocaleString();
        const bitacoraCount = backup.data.length;
        
        return `
          <div class="backup-item">
            <div class="backup-info">
              <div>${formattedDate}</div>
              <div>${bitacoraCount} bit√°cora${bitacoraCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="backup-actions">
              <button class="restore" onclick="restoreBackup(${index})">Restaurar</button>
              <button class="delete" onclick="deleteBackup(${index})">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
      
      modal.style.display = 'block';
    }

    function closeBackupModal() {
      document.getElementById('backupModal').style.display = 'none';
    }

    function restoreBackup(index) {
      if (!confirm('¬øEst√°s seguro de que quieres restaurar este respaldo? Se perder√°n los cambios no guardados.')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      const backup = backups[index];
      
      if (backup) {
        localStorage.setItem('bitacoras', JSON.stringify(backup.data));
        selectedBitacora = null;
        renderBitacoraSelector();
        closeBackupModal();
        
        // Seleccionar la primera bit√°cora si existe
        if (backup.data.length > 0) {
          selectBitacora(backup.data[0].id);
        } else {
          showNewBitacoraForm();
        }
        
        alert('Respaldo restaurado exitosamente');
      }
    }

    function deleteBackup(index) {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar este respaldo?')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.splice(index, 1);
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      
      showBackups(); // Actualizar la lista
    }

    function showHelpModal() {
      document.getElementById('helpModal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // L√≥gica para tipo de luz
    function selectLuz(tipo) {
      tipoLuz = tipo;
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      if (tipo === 'sol') {
        document.getElementById('luzSolBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
      } else if (tipo === 'luz') {
        document.getElementById('luzArtificialBtn').classList.add('selected');
        document.getElementById('luzArtificialFields').style.display = 'block';
      } else if (tipo === 'mixto') {
        document.getElementById('luzMixtoBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
        document.getElementById('luzArtificialFields').style.display = 'block';
      }
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.tipoLuz = tipoLuz;
        autoSave();
      }
    }

    // Funci√≥n para mostrar/ocultar campo de germinaci√≥n
    function toggleGerminacionField() {
      const tipo = document.getElementById('cepaTipo').value;
      const semillaFields = document.getElementById('semillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }

    function addLuz() {
      const nombre = document.getElementById('luzNombre').value.trim();
      const cantidad = parseInt(document.getElementById('luzCantidad').value, 10) || 1;
      const watts = parseInt(document.getElementById('luzWatts').value, 10) || 0;
      if (!nombre || !watts) return;
      luces.push({ nombre, cantidad, watts });
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
      document.getElementById('luzNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function removeLuz(index) {
      luces.splice(index, 1);
      renderLucesList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function renderLucesList() {
      const list = document.getElementById('lucesList');
      list.innerHTML = '';
      luces.forEach((luz, idx) => {
        const div = document.createElement('div');
        div.className = 'luz-item';
        div.innerHTML = `<span>${luz.nombre}</span> <span>x${luz.cantidad}</span> <span>${luz.watts}W</span> <button class='luz-remove' onclick='removeLuz(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function renderBitacoraInfo() {
      if (!selectedBitacora) return;
      
      const container = document.getElementById('bitacoraInfoContent');
      container.innerHTML = '';
      
      // Verificar si la bit√°cora tiene caracter√≠sticas guardadas
      if (!selectedBitacora.cepas && !selectedBitacora.tipoCultivo) {
        container.innerHTML = '<div class="no-info">Esta bit√°cora no tiene caracter√≠sticas guardadas. Edita la bit√°cora para agregar informaci√≥n.</div>';
        return;
      }
      
      const infoGrid = document.createElement('div');
      infoGrid.className = 'info-grid';
      
      // Secci√≥n de Cepas
      if (selectedBitacora.cepas && selectedBitacora.cepas.length > 0) {
        const cepasSection = document.createElement('div');
        cepasSection.className = 'info-section';
        cepasSection.innerHTML = '<h4>üå± Cepas</h4>';
        selectedBitacora.cepas.forEach(cepa => {
          const item = document.createElement('div');
          item.className = 'info-item';
          let info = `<span class='info-label'>${cepa.nombre}</span> <span class='info-value cepa'>x${cepa.cantidad}</span> <span class='info-value'>(${cepa.tipo}`;
          if (cepa.tipo === 'semilla' && cepa.germinacion) {
            info += `, germinaci√≥n: ${cepa.germinacion}`;
          }
          info += ")</span>";
          item.innerHTML = info;
          cepasSection.appendChild(item);
        });
        infoGrid.appendChild(cepasSection);
      }
      
      // Secci√≥n de Tipo de Cultivo
      if (selectedBitacora.tipoCultivo) {
        const cultivoSection = document.createElement('div');
        cultivoSection.className = 'info-section';
        cultivoSection.innerHTML = '<h4>üè† Tipo de Cultivo</h4>';
        const cultivoItem = document.createElement('div');
        cultivoItem.className = 'info-item';
        const cultivoText = selectedBitacora.tipoCultivo.charAt(0).toUpperCase() + selectedBitacora.tipoCultivo.slice(1);
        cultivoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value ${selectedBitacora.tipoCultivo}">${cultivoText}</span>
        `;
        cultivoSection.appendChild(cultivoItem);
        // Informaci√≥n adicional para cultivo interior/invernadero
        if ((selectedBitacora.tipoCultivo === 'interior' || selectedBitacora.tipoCultivo === 'invernadero')) {
          if (selectedBitacora.numCarpas > 0) {
            const carpasItem = document.createElement('div');
            carpasItem.className = 'info-item';
            let carpasInfo = `${selectedBitacora.numCarpas}`;
            if (selectedBitacora.carpas && selectedBitacora.carpas.length > 0) {
              carpasInfo += ' (' + selectedBitacora.carpas.map((c, i) => `Carpa ${i+1}: ${c.metrosCuadrados} m¬≤`).join(', ') + ')';
            }
            carpasItem.innerHTML = `
              <span class="info-label">Carpas</span>
              <span class="info-value">${carpasInfo}</span>
            `;
            cultivoSection.appendChild(carpasItem);
          }
          if (selectedBitacora.soloSala) {
            const salaItem = document.createElement('div');
            salaItem.className = 'info-item';
            let salaInfo = 'Solo sala';
            if (selectedBitacora.carpas && selectedBitacora.carpas.length === 1) {
              salaInfo += ` (${selectedBitacora.carpas[0].metrosCuadrados} m¬≤)`;
            }
            salaItem.innerHTML = `
              <span class="info-label">Configuraci√≥n</span>
              <span class="info-value">${salaInfo}</span>
            `;
            cultivoSection.appendChild(salaItem);
          }
        }
        infoGrid.appendChild(cultivoSection);
      }
      // Secci√≥n de Extractores
      if (selectedBitacora.extractores && selectedBitacora.extractores.length > 0) {
        const extSection = document.createElement('div');
        extSection.className = 'info-section';
        extSection.innerHTML = '<h4>üí® Extractores</h4>';
        selectedBitacora.extractores.forEach((ext, idx) => {
          const extItem = document.createElement('div');
          extItem.className = 'info-item';
          extItem.innerHTML = `<span class='info-label'>Extractor ${idx+1}</span> <span class='info-value'>x${ext.cantidad} de ${ext.pulgadas}"</span>`;
          extSection.appendChild(extItem);
        });
        infoGrid.appendChild(extSection);
      }
      
      // Secci√≥n de Iluminaci√≥n
      if (selectedBitacora.tipoLuz || (selectedBitacora.luces && selectedBitacora.luces.length > 0)) {
        const luzSection = document.createElement('div');
        luzSection.className = 'info-section';
        luzSection.innerHTML = '<h4>üí° Iluminaci√≥n</h4>';
        
        if (selectedBitacora.tipoLuz) {
          const tipoLuzItem = document.createElement('div');
          tipoLuzItem.className = 'info-item';
          let tipoLuzText = '';
          switch (selectedBitacora.tipoLuz) {
            case 'sol': tipoLuzText = '‚òÄÔ∏è Sol'; break;
            case 'luz': tipoLuzText = 'üí° Artificial'; break;
            case 'mixto': tipoLuzText = 'üîÑ Mixto'; break;
          }
          tipoLuzItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value luz">${tipoLuzText}</span>
          `;
          luzSection.appendChild(tipoLuzItem);
        }
        
        if (selectedBitacora.luces && selectedBitacora.luces.length > 0) {
          selectedBitacora.luces.forEach(luz => {
            const luzItem = document.createElement('div');
            luzItem.className = 'info-item';
            luzItem.innerHTML = `
              <span class="info-label">${luz.nombre}</span>
              <span class="info-value">x${luz.cantidad} (${luz.watts}W)</span>
            `;
            luzSection.appendChild(luzItem);
          });
        }
        
        // Informaci√≥n de l√°mparas para cultivo interior
        if (selectedBitacora.tipoCultivo === 'interior') {
          if (selectedBitacora.lamparasVege > 0) {
            const vegeItem = document.createElement('div');
            vegeItem.className = 'info-item';
            vegeItem.innerHTML = `
              <span class="info-label">L√°mparas Vegetaci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasVege}${selectedBitacora.wattsVege ? ` (${selectedBitacora.wattsVege})` : ''}</span>
            `;
            luzSection.appendChild(vegeItem);
          }
          
          if (selectedBitacora.lamparasFlora > 0) {
            const floraItem = document.createElement('div');
            floraItem.className = 'info-item';
            floraItem.innerHTML = `
              <span class="info-label">L√°mparas Floraci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasFlora}${selectedBitacora.wattsFlora ? ` (${selectedBitacora.wattsFlora})` : ''}</span>
            `;
            luzSection.appendChild(floraItem);
          }
        }
        
        infoGrid.appendChild(luzSection);
      }
      
      // Secci√≥n de Riego
      if (selectedBitacora.riegoOptions && selectedBitacora.riegoOptions.length > 0) {
        const riegoSection = document.createElement('div');
        riegoSection.className = 'info-section';
        riegoSection.innerHTML = '<h4>üíß Riego</h4>';
        
        selectedBitacora.riegoOptions.forEach(riego => {
          const riegoItem = document.createElement('div');
          riegoItem.className = 'info-item';
          let riegoText = '';
          switch (riego) {
            case 'manual': riegoText = 'üëã Manual'; break;
            case 'goteo': riegoText = 'üíß Goteo'; break;
            case 'hidroponica': riegoText = 'üåä Hidrop√≥nica'; break;
          }
          riegoItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value riego">${riegoText}</span>
          `;
          riegoSection.appendChild(riegoItem);
        });
        
        if (selectedBitacora.detalleRiego) {
          const detalleItem = document.createElement('div');
          detalleItem.className = 'info-item';
          detalleItem.innerHTML = `
            <span class="info-label">Detalles</span>
            <span class="info-value">${selectedBitacora.detalleRiego}</span>
          `;
          riegoSection.appendChild(detalleItem);
        }
        
        infoGrid.appendChild(riegoSection);
      }
      
      // Secci√≥n de Sustrato
      if (selectedBitacora.sustrato) {
        const sustratoSection = document.createElement('div');
        sustratoSection.className = 'info-section';
        sustratoSection.innerHTML = '<h4>üå± Sustrato</h4>';
        
        const sustratoItem = document.createElement('div');
        sustratoItem.className = 'info-item';
        sustratoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value">${selectedBitacora.sustrato}</span>
        `;
        sustratoSection.appendChild(sustratoItem);
        
        infoGrid.appendChild(sustratoSection);
      }
      
      // Secci√≥n de Equipamiento (solo para cultivo interior)
      if (selectedBitacora.tipoCultivo === 'interior') {
        const equipamientoSection = document.createElement('div');
        equipamientoSection.className = 'info-section';
        equipamientoSection.innerHTML = '<h4>‚öôÔ∏è Equipamiento</h4>';
        
        if (selectedBitacora.ventiladores > 0) {
          const ventiladoresItem = document.createElement('div');
          ventiladoresItem.className = 'info-item';
          ventiladoresItem.innerHTML = `
            <span class="info-label">Ventiladores</span>
            <span class="info-value">${selectedBitacora.ventiladores}${selectedBitacora.pulgadasVentilador ? ` (${selectedBitacora.pulgadasVentilador}")` : ''}</span>
          `;
          equipamientoSection.appendChild(ventiladoresItem);
        }
        
        if (selectedBitacora.filtroAire === 'si') {
          const filtroItem = document.createElement('div');
          filtroItem.className = 'info-item';
          filtroItem.innerHTML = `
            <span class="info-label">Filtro de Aire</span>
            <span class="info-value">‚úÖ S√≠</span>
          `;
          equipamientoSection.appendChild(filtroItem);
        }
        
        if (selectedBitacora.aireAcondicionado === 'si') {
          const aireItem = document.createElement('div');
          aireItem.className = 'info-item';
          aireItem.innerHTML = `
            <span class="info-label">Aire Acondicionado</span>
            <span class="info-value">‚úÖ S√≠${selectedBitacora.frigorias ? ` (${selectedBitacora.frigorias})` : ''}</span>
          `;
          equipamientoSection.appendChild(aireItem);
        }
        
        if (equipamientoSection.children.length > 1) { // M√°s de 1 porque incluye el h4
          infoGrid.appendChild(equipamientoSection);
        }
      }
      
      container.appendChild(infoGrid);
    }

    // Mostrar la fecha del √∫ltimo respaldo
    function setUltimoRespaldo(fecha) {
      const el = document.getElementById('ultimoRespaldo');
      if (fecha) {
        el.textContent = '√öltimo respaldo: ' + fecha;
        localStorage.setItem('ultimoRespaldo', fecha);
      } else {
        const guardado = localStorage.getItem('ultimoRespaldo');
        el.textContent = '√öltimo respaldo: ' + (guardado || '-');
      }
    }
    // Llamar al cargar la p√°gina
    setUltimoRespaldo();
    // Modificar createBackup para actualizar la fecha
    const originalCreateBackup = window.createBackup;
    window.createBackup = function() {
      if (originalCreateBackup) originalCreateBackup();
      const fecha = new Date().toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
      setUltimoRespaldo(fecha);
    }

    // Funciones auxiliares para el formulario
    function toggleInteriorFields() {
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const interiorFields = document.getElementById('interiorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleCarpasFields() {
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const carpasList = document.getElementById('carpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleFrigorias() {
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de bit√°cora
    function toggleEditInteriorFields() {
      const tipoCultivo = document.getElementById('editTipoCultivo').value;
      const interiorFields = document.getElementById('editInteriorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleEditCarpasFields() {
      const numCarpas = parseInt(document.getElementById('editNumCarpas').value) || 0;
      const soloSala = document.getElementById('editSoloSala').checked;
      const carpasList = document.getElementById('editCarpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleEditFrigorias() {
      const aireAcondicionado = document.getElementById('editAireAcondicionado').value;
      const frigorias = document.getElementById('editFrigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de cepas en modal de edici√≥n
    let editCepas = [];
    function addEditCepa() {
      const nombre = document.getElementById('editCepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('editCepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('editCepaTipo').value;
      const germinacion = document.getElementById('editCepaGerminacion').value;
      if (!nombre) return;
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      editCepas.push(cepa);
      renderEditCepasList();
      document.getElementById('editCepaNombre').value = '';
      document.getElementById('editCepaCantidad').value = 1;
      document.getElementById('editCepaTipo').value = 'clon';
      document.getElementById('editCepaGerminacion').value = '';
      document.getElementById('editSemillaFields').style.display = 'none';
    }
    function removeEditCepa(index) {
      editCepas.splice(index, 1);
      renderEditCepasList();
    }
    function renderEditCepasList() {
      const list = document.getElementById('editCepasList');
      list.innerHTML = '';
      editCepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo}`;
        if (cepa.tipo === 'semilla' && cepa.germinacion) {
          info += `, germinaci√≥n: ${cepa.germinacion}`;
        }
        info += ")";
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeEditCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }
    function toggleEditGerminacionField() {
      const tipo = document.getElementById('editCepaTipo').value;
      const semillaFields = document.getElementById('editSemillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }
    // Funciones para extractores en edici√≥n
    let editExtractores = [];
    function addEditExtractor() {
      const cantidad = parseInt(document.getElementById('editExtractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('editExtractorPulgadas').value.trim();
      if (!pulgadas) return;
      editExtractores.push({ cantidad, pulgadas });
      renderEditExtractoresList();
      document.getElementById('editExtractorCantidad').value = 1;
      document.getElementById('editExtractorPulgadas').value = '';
    }
    function removeEditExtractor(index) {
      editExtractores.splice(index, 1);
      renderEditExtractoresList();
    }
    function renderEditExtractoresList() {
      const list = document.getElementById('editExtractoresList');
      list.innerHTML = '';
      editExtractores.forEach((ext, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${ext.cantidad} de ${ext.pulgadas}"</span> <button class='extractor-remove' onclick='removeEditExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Modo nocturno
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      const btn = document.getElementById('toggleDarkMode');
      if (body.classList.contains('dark-mode')) {
        btn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('darkMode', '1');
      } else {
        btn.textContent = 'üåô';
        localStorage.setItem('darkMode', '0');
      }
    }
    // Al cargar, aplicar modo guardado
    if (localStorage.getItem('darkMode') === '1') {
      document.body.classList.add('dark-mode');
      document.getElementById('toggleDarkMode').textContent = '‚òÄÔ∏è';
    }

    // Alternar formulario de nueva bit√°cora
    function toggleNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      const btn = document.getElementById('btnNuevaBitacora');
      if (form.style.display === 'block' || form.classList.contains('active')) {
        form.style.display = 'none';
        form.classList.remove('active');
        if (btn) btn.textContent = '+ Nueva Bit√°cora';
      } else {
        form.style.display = 'block';
        form.classList.add('active');
        if (btn) btn.textContent = 'Cerrar';
        showNewBitacoraForm();
      }
    }
  </script>
</body>
</html>

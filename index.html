<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f5f7fa">
  <title>CLINICAL DATA</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --background: #f5f7fa;
      --surface: #fff;
      --border: #e5e7eb;
      --text: #222;
      --text-light: #6b7280;
      --radius: 18px;
      --shadow: 0 2px 16px rgba(0,0,0,0.06);
    }
    body {
      font-family: 'Roboto', 'San Francisco', Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 420px;
      margin: 40px auto 0 auto;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px 24px 24px 24px;
      border: 1px solid var(--border);
    }
    h1 {
      font-size: 2.1em;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--primary);
      letter-spacing: 0.5px;
      text-align: center;
    }
    h2, h3 {
      color: var(--primary-light);
      font-weight: 500;
      margin-bottom: 10px;
      text-align: center;
    }
    label {
      font-weight: 500;
      color: var(--text-light);
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius);
      border: 1.5px solid var(--border);
      background: #f9fafb;
      font-size: 1em;
      margin-bottom: 18px;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input:focus, textarea:focus {
      border: 1.5px solid var(--primary-light);
      outline: none;
    }
    button {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius);
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 1.1em;
      font-weight: 500;
      margin-top: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(37,99,235,0.08);
      transition: background 0.2s;
    }
    button:hover {
      background: var(--primary-light);
    }
    .form-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px 18px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    .center {
      text-align: center;
    }
    .link {
      color: var(--primary-light);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.98em;
    }
    .error-message {
      background: #fee2e2;
      color: #b91c1c;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid #fecaca;
      margin-bottom: 15px;
      font-size: 14px;
      text-align: center;
    }
    .success-message {
      background: #d1fae5;
      color: #065f46;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid #bbf7d0;
      margin-bottom: 15px;
      font-size: 14px;
      text-align: center;
    }
    .pacientes-section, #fichaPaciente {
      margin-top: 24px;
    }
    .paciente-card {
      background: #f9fafb;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px 14px;
      margin-bottom: 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .paciente-card:hover {
      box-shadow: 0 2px 12px rgba(37,99,235,0.10);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.18);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 32px 24px;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
    }
    .close-modal {
      position: absolute;
      right: 16px;
      top: 16px;
      cursor: pointer;
      font-size: 1.5em;
      color: var(--text-light);
      background: none;
      border: none;
    }
    @media (max-width: 600px) {
      .container { padding: 12px 2px; }
      .modal-content { padding: 18px 6px; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <h1>CLINICAL DATA</h1>
    <div id="loginCard" class="form-card">
      <h2>Iniciar Sesión</h2>
      <form id="loginForm">
        <div id="loginError" class="error-message" style="display:none;"></div>
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required autocomplete="username">
        <label for="loginPassword">Contraseña</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
        <button type="submit">Entrar</button>
      </form>
      <div class="center">
        <span class="link" onclick="showRegister()">¿No tienes cuenta? Regístrate</span>
      </div>
    </div>
    <div id="registerCard" class="form-card" style="display:none;">
      <h2>Crear Cuenta</h2>
      <form id="registerForm">
        <div id="registerError" class="error-message" style="display:none;"></div>
        <label for="registerName">Nombre completo</label>
        <input type="text" id="registerName" required>
        <label for="registerEmail">Email</label>
        <input type="email" id="registerEmail" required autocomplete="username">
        <label for="registerPassword">Contraseña</label>
        <input type="password" id="registerPassword" required autocomplete="new-password">
        <button type="submit">Crear cuenta</button>
      </form>
      <div class="center">
        <span class="link" onclick="showLogin()">¿Ya tienes cuenta? Inicia sesión</span>
      </div>
    </div>
  </div>

  <script>
    // Variables globales del sistema de autenticación
    let currentUser = null;
    let isAuthenticated = false;

    // Manejar la instalación de la PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Variables globales
    let selectedBitacora = null;
    let selectedMood = null;
    let selectedStage = 'vege';
    let didWater = false;
    let tipoLuz = '';
    let luces = [];
    let extractores = [];

    const moodStates = [
      { value: 1, icon: '😞', label: 'Mal día', color: '#f87171' },
      { value: 2, icon: '⚠️', label: 'Regular', color: '#facc15' },
      { value: 3, icon: '🌿', label: 'Bueno', color: '#4ade80' },
      { value: 4, icon: '🌞', label: 'Muy bueno', color: '#22c55e' }
    ];

    const availableColors = [
      '#4ade80', '#0ea5e9', '#f87171', '#facc15',
      '#a78bfa', '#f472b6', '#60a5fa', '#34d399'
    ];

    // ===== FUNCIÓN DE GUARDADO AUTOMÁTICO =====
    async function autoSave() {
      if (!currentUser || !selectedBitacora) return;
      
      try {
        await saveBitacoraToFirestore(selectedBitacora);
        console.log('Guardado automático completado');
      } catch (error) {
        console.error('Error en guardado automático:', error);
      }
    }

    // ===== SISTEMA DE AUTENTICACIÓN =====

    // Observar cambios en el estado de autenticación
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usuario autenticado
        currentUser = user;
        isAuthenticated = true;
        showUserInfo(user);
        hideAuthContainer();
        loadUserData();
      } else {
        // Usuario no autenticado
        currentUser = null;
        isAuthenticated = false;
        hideUserInfo();
        showAuthContainer();
        clearUserData();
      }
    });

    // Funciones de autenticación
    function showAuthContainer() {
      const el = document.getElementById('authContainer');
      if (el) el.classList.add('active');
      document.querySelector('.container').style.display = 'none';
    }

    function hideAuthContainer() {
      const el = document.getElementById('authContainer');
      if (el) el.classList.remove('active');
      document.querySelector('.container').style.display = 'block';
    }

    function showUserInfo(user) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');

      // Mostrar información del usuario
      userInfo.style.display = 'flex';
      
      // Avatar con iniciales
      const displayName = user.displayName || user.email.split('@')[0];
      userAvatar.textContent = displayName.charAt(0).toUpperCase();
      
      // Nombre y email
      userName.textContent = displayName;
      userEmail.textContent = user.email;
    }

    function hideUserInfo() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
    }

    function showLogin() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('registerCard').style.display = 'none';
      clearAuthErrors();
    }

    function showRegister() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
      clearAuthErrors();
    }

    function clearAuthErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }

    // Login
    document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      var userInput = document.getElementById('loginUser');
      var passInput = document.getElementById('loginPassword');
      if (!userInput || !passInput) return;
      var username = userInput.value.trim();
      var password = passInput.value;
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loginBtnLoading = document.getElementById('loginBtnLoading');
      const loginError = document.getElementById('loginError');

      // Mostrar loading
      loginBtn.disabled = true;
      loginBtnText.style.display = 'none';
      loginBtnLoading.style.display = 'inline-block';
      loginError.style.display = 'none';

      try {
        await auth.signInWithEmailAndPassword(username, password);
        // El onAuthStateChanged se encargará del resto
      } catch (error) {
        console.error('Error de login:', error);
        loginError.textContent = getErrorMessage(error.code);
        loginError.style.display = 'block';
      } finally {
        // Ocultar loading
        loginBtn.disabled = false;
        loginBtnText.style.display = 'inline';
        loginBtnLoading.style.display = 'none';
      }
    });

    // Registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      const registerBtn = document.getElementById('registerBtn');
      const registerBtnText = document.getElementById('registerBtnText');
      const registerBtnLoading = document.getElementById('registerBtnLoading');
      const registerError = document.getElementById('registerError');

      // Validar contraseñas
      if (password !== confirmPassword) {
        registerError.textContent = 'Las contraseñas no coinciden';
        registerError.style.display = 'block';
        return;
      }

      // Mostrar loading
      registerBtn.disabled = true;
      registerBtnText.style.display = 'none';
      registerBtnLoading.style.display = 'inline-block';
      registerError.style.display = 'none';

      try {
        // Crear usuario
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Actualizar perfil
        await userCredential.user.updateProfile({
          displayName: name
        });

        // Crear documento de usuario en Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Migrar datos locales si existen
        await migrateLocalData(userCredential.user.uid);

      } catch (error) {
        console.error('Error de registro:', error);
        registerError.textContent = getErrorMessage(error.code);
        registerError.style.display = 'block';
      } finally {
        // Ocultar loading
        registerBtn.disabled = false;
        registerBtnText.style.display = 'inline';
        registerBtnLoading.style.display = 'none';
      }
    });

    // Logout
    async function logout() {
      try {
        await auth.signOut();
        // El onAuthStateChanged se encargará del resto
      } catch (error) {
        console.error('Error de logout:', error);
        alert('Error al cerrar sesión');
      }
    }

    // Obtener mensaje de error amigable
    function getErrorMessage(errorCode) {
      const errorMessages = {
        'auth/user-not-found': 'No existe una cuenta con este email',
        'auth/wrong-password': 'Contraseña incorrecta',
        'auth/email-already-in-use': 'Este email ya está registrado',
        'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres',
        'auth/invalid-email': 'Email inválido',
        'auth/too-many-requests': 'Demasiados intentos. Intenta más tarde',
        'auth/network-request-failed': 'Error de conexión. Verifica tu internet'
      };
      return errorMessages[errorCode] || 'Error desconocido. Intenta de nuevo';
    }

    // ===== GESTIÓN DE DATOS CON FIRESTORE =====

    // Cargar datos del usuario
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
          // Actualizar último login
          await db.collection('users').doc(currentUser.uid).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Cargar bitácoras del usuario
        await loadUserBitacoras();
        
      } catch (error) {
        console.error('Error al cargar datos del usuario:', error);
      }
    }

    // Cargar bitácoras del usuario
    async function loadUserBitacoras() {
      if (!currentUser) return;

      try {
        const bitacorasSnapshot = await db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').get();

        const bitacoras = [];
        bitacorasSnapshot.forEach(doc => {
          bitacoras.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Guardar en localStorage para compatibilidad
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        // Renderizar selector de bitácoras
        renderBitacoraSelector();
        
        // Seleccionar primera bitácora si existe
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          // Solo mostrar formulario si el elemento existe
          if (document.getElementById('newBitacoraForm')) {
            showNewBitacoraForm();
          }
        }

      } catch (error) {
        console.error('Error al cargar bitácoras:', error);
      }
    }

    // Guardar bitácora en Firestore
    async function saveBitacoraToFirestore(bitacora) {
      if (!currentUser) return;

      try {
        const bitacoraRef = db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').doc(bitacora.id);
        
        await bitacoraRef.set({
          ...bitacora,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Bitácora guardada en Firestore');
      } catch (error) {
        console.error('Error al guardar bitácora:', error);
        throw error;
      }
    }

    // Migrar datos locales a Firestore
    async function migrateLocalData(userId) {
      try {
        const localBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        
        if (localBitacoras.length > 0) {
          const batch = db.batch();
          
          for (const bitacora of localBitacoras) {
            const bitacoraRef = db.collection('users').doc(userId)
              .collection('bitacoras').doc(bitacora.id);
            
            batch.set(bitacoraRef, {
              ...bitacora,
              migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          await batch.commit();
          console.log('Datos migrados exitosamente');
        }
      } catch (error) {
        console.error('Error al migrar datos:', error);
      }
    }

    // Limpiar datos del usuario
    function clearUserData() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
      localStorage.removeItem('bitacoras');
      localStorage.removeItem('bitacora_backups');
      selectedBitacora = null;
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('bitacoraSelector').innerHTML = '';
    }

    // ===== FUNCIONES MODIFICADAS PARA FIRESTORE =====

    // Modificar createNewBitacora para usar Firestore
    async function createNewBitacora() {
      if (!currentUser) {
        alert('Debes iniciar sesión para crear una bitácora');
        return;
      }

      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bitácora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bitácora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      
      // Verificar si ya existe una bitácora con ese nombre
      const existingBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      if (existingBitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bitácora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar características (código existente)
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar carpas con metros cuadrados
      const carpas = [];
      document.querySelectorAll('#carpasList .carpa-item input[type="number"]').forEach(input => {
        if (input.value) {
          carpas.push({ metrosCuadrados: parseFloat(input.value) });
        }
      });
      
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        userId: currentUser.uid,
        // Características de la bitácora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        carpas: carpas,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        extractores: [...extractores],
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        },
        createdAt: new Date().toISOString()
      };

      try {
        // Guardar en Firestore
        await saveBitacoraToFirestore(newBitacora);
        
        // Actualizar localStorage
        existingBitacoras.push(newBitacora);
        localStorage.setItem('bitacoras', JSON.stringify(existingBitacoras));
        
        // Limpiar formulario
        const nameInput = document.getElementById('newBitacoraName');
        if (nameInput) nameInput.value = '';
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        const formElement = document.getElementById('newBitacoraForm');
        if (formElement) formElement.classList.remove('active');
        
        // Limpiar variables globales
        cepas = [];
        extractores = [];
        luces = [];
        tipoLuz = '';
        
        // Actualizar UI
        renderBitacoraSelector();
        selectBitacora(newBitacora.id);
        
      } catch (error) {
        console.error('Error al crear bitácora:', error);
        alert('Error al crear la bitácora. Intenta de nuevo.');
      }
    }

    // Modificar saveEntry para usar Firestore
    async function saveEntry() {
      if (!selectedBitacora || !currentUser) {
        alert('Por favor, selecciona una bitácora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Elegí fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value,
        createdAt: new Date().toISOString()
      };

      try {
        // Actualizar en localStorage
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        
        if (bitacoraIndex !== -1) {
          let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
          entries.push(entry);
          bitacoras[bitacoraIndex].entries[selectedStage] = entries;
          
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          selectedBitacora = bitacoras[bitacoraIndex];
          
          // Guardar en Firestore
          await saveBitacoraToFirestore(selectedBitacora);
          
          // Actualizar UI
          renderHistory();
          renderCalendar();
          updateWeeklySummary();
        }
      } catch (error) {
        console.error('Error al guardar entrada:', error);
        alert('Error al guardar la entrada. Intenta de nuevo.');
      }
    }

    // Funciones auxiliares
    function getEntries() {
      if (!selectedBitacora) return [];
      return selectedBitacora.entries[selectedStage] || [];
    }

    function updateWeeklySummary() {
      if (!selectedBitacora) return;

      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());

      const weekEntries = getEntries().filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate >= weekStart && entryDate <= today;
      });

      const totalEntriesEl = document.getElementById('totalEntries');
      if (totalEntriesEl) totalEntriesEl.textContent = weekEntries.length;
      
      const moods = weekEntries.map(e => e.mood).filter(m => m);
      const avgMood = moods.length ? (moods.reduce((a, b) => a + b, 0) / moods.length).toFixed(1) : '-';
      const avgMoodEl = document.getElementById('averageMood');
      if (avgMoodEl) avgMoodEl.textContent = avgMood;
      
      const wateredDays = weekEntries.filter(e => e.didWater).length;
      const wateredDaysEl = document.getElementById('wateredDays');
      if (wateredDaysEl) wateredDaysEl.textContent = wateredDays;

      const timeline = document.getElementById('emotionTimeline');
      if (timeline) {
        timeline.innerHTML = weekEntries.map(entry => `
          <div class="emotion-dot" style="background-color: ${moodStates.find(m => m.value === entry.mood)?.color}"
               title="${entry.date}"></div>
        `).join('');
      }
    }

    function renderHistory() {
      const entries = getEntries().sort((a,b) => new Date(b.date) - new Date(a.date));
      const container = document.getElementById('history');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '';
      const floraStart = selectedBitacora?.floraStart;

      entries.forEach(e => {
        let diaFlora = '';
        if (selectedStage === 'flora' && floraStart) {
          const start = new Date(floraStart);
          const actual = new Date(e.date);
          const diff = Math.floor((actual - start) / (1000 * 60 * 60 * 24)) + 1;
          diaFlora = ` — Día ${diff} de flora`;
        }

        const moodEmoji = moodStates.find(m => m.value === e.mood)?.icon || '';
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <button class="edit-button" onclick="editEntry('${e.date}')">✏️</button>
          <strong>${e.date}</strong> — ${moodEmoji} ${diaFlora}<br/>
          <b>Tareas:</b> ${e.tasks}<br/>
          <b>Riego:</b> ${e.didWater ? 'Sí' : 'No'} ${e.didWater ? `
            <br/>💧 ${e.waterAmount} | 🧴 ${e.nutrients} | ⚗️ pH: ${e.ph} | 📈 EC: ${e.ec}` : ''}
          <br/><b>Problemas:</b> ${e.issues}
          <br/><b>Notas:</b> ${e.notes}`;
        container.appendChild(div);
      });
    }

    function renderCalendar() {
      const entries = getEntries();
      const map = {};
      entries.forEach(e => { map[e.date] = e.mood; });

      const container = document.getElementById('calendarVisual');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '<div class="calendar">';
      for (let i = 34; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        const mood = map[k];
        const cls = mood ? 'm' + mood : '';
        container.innerHTML += `<div class="day ${cls}" title="${k}"></div>`;
      }
      container.innerHTML += '</div>';
    }

    // Funciones de gestión de bitácoras
    function createNewBitacora() {
      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bitácora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bitácora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      
      if (bitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bitácora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar todas las características de la bitácora
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar tipo de riego
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        // Características de la bitácora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        }
      };

      bitacoras.push(newBitacora);
      localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
      
      const nameInput = document.getElementById('newBitacoraName');
      if (nameInput) nameInput.value = '';
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      const formElement = document.getElementById('newBitacoraForm');
      if (formElement) formElement.classList.remove('active');
      
      renderBitacoraSelector();
      selectBitacora(newBitacora.id);
    }

    function renderBitacoraSelector() {
      const container = document.getElementById('bitacoraSelector');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      container.innerHTML = '';
      
      const newButton = document.createElement('button');
      newButton.className = 'bitacora-card';
      newButton.style.backgroundColor = '#e5e7eb';
      newButton.style.color = '#374151';
      newButton.innerHTML = '+ Nueva Bitácora';
      newButton.id = 'btnNuevaBitacora';
      newButton.onclick = toggleNewBitacoraForm;
      container.appendChild(newButton);
      
      bitacoras.forEach(bitacora => {
        const div = document.createElement('div');
        div.className = `bitacora-card ${bitacora.id === selectedBitacora?.id ? 'active' : ''}`;
        div.style.backgroundColor = bitacora.color;
        div.style.color = '#fff';
        
        // Contenedor para el nombre y estado de visibilidad
        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          ${bitacora.name}
          <span class="visibility-indicator" title="${bitacora.isPublic ? 'Pública: Cualquiera con el enlace puede ver y compartir esta bitácora.' : 'Privada: Solo tú puedes ver esta bitácora.'}">
            ${bitacora.isPublic ? '🌐' : '🔒'}
          </span>
        `;
        div.appendChild(nameDiv);
        
        // Contenedor para los botones de acción
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'bitacora-actions';
        
        // Botón de editar
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '✏️';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditBitacoraModal(bitacora);
        };
        
        // Botón de eliminar
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn delete-btn';
        deleteBtn.innerHTML = '🗑️';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('¿Estás seguro de que quieres eliminar esta bitácora?')) {
            deleteBitacora(bitacora.id);
          }
        };
        
        // Botón de compartir
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share-btn';
        shareBtn.innerHTML = '📤';
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          if (!bitacora.isPublic) {
            alert('Esta bitácora es privada. Cámbiala a pública para poder compartirla.');
            return;
          }
          shareBitacora(bitacora);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsDiv.appendChild(shareBtn);
        div.appendChild(actionsDiv);
        
        div.onclick = () => selectBitacora(bitacora.id);
        container.appendChild(div);
      });
    }

    function showNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      if (!form) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      form.classList.add('active');
      const nameInput = document.getElementById('newBitacoraName');
      if (nameInput) nameInput.value = '';
      renderColorPicker();
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      
      // Limpiar cepas
      cepas = [];
      renderCepasList();
      const cepaNombre = document.getElementById('cepaNombre');
      if (cepaNombre) cepaNombre.value = '';
      const cepaCantidad = document.getElementById('cepaCantidad');
      if (cepaCantidad) cepaCantidad.value = 1;
      const cepaTipo = document.getElementById('cepaTipo');
      if (cepaTipo) cepaTipo.value = 'clon';
      const cepaGerminacion = document.getElementById('cepaGerminacion');
      if (cepaGerminacion) cepaGerminacion.value = '';
      const semillaFields = document.getElementById('semillaFields');
      if (semillaFields) semillaFields.style.display = 'none';
      
      // Limpiar tipo de cultivo
      document.getElementById('tipoCultivo').value = '';
      document.getElementById('interiorFields').style.display = 'none';
      document.getElementById('numCarpas').value = 0;
      document.getElementById('soloSala').checked = false;
      document.getElementById('carpasList').innerHTML = '';
      
      // Limpiar equipamiento interior
      document.getElementById('lamparasVege').value = 0;
      document.getElementById('wattsVege').value = '';
      document.getElementById('lamparasFlora').value = 0;
      document.getElementById('wattsFlora').value = '';
      document.getElementById('ventiladores').value = 0;
      document.getElementById('pulgadasVentilador').value = '';
      
      // Limpiar extractores
      extractores = [];
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      
      document.getElementById('filtroAire').value = 'no';
      document.getElementById('aireAcondicionado').value = 'no';
      document.getElementById('frigorias').value = '';
      document.getElementById('frigorias').style.display = 'none';
      
      // Limpiar riego
      document.querySelectorAll('#riegoOptions input[type=checkbox]').forEach(cb => cb.checked = false);
      document.getElementById('detalleRiego').value = '';
      document.getElementById('sustrato').value = '';
      
      // Limpiar luces
      tipoLuz = '';
      luces = [];
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
    }

    function renderColorPicker() {
      const colorPicker = document.getElementById('colorPicker');
      if (!colorPicker) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option" style="background-color: ${color}" onclick="selectColor(this)"></div>
      `).join('');
    }

    function selectColor(element) {
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
    }

    let cepas = [];
    function addCepa() {
      const nombre = document.getElementById('cepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('cepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('cepaTipo').value;
      const germinacion = document.getElementById('cepaGerminacion').value;
      
      if (!nombre) return;
      
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      
      cepas.push(cepa);
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      document.getElementById('cepaNombre').focus();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function removeCepa(index) {
      cepas.splice(index, 1);
      renderCepasList();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function renderCepasList() {
      const list = document.getElementById('cepasList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      cepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo})`;
        if (cepa.germinacion) {
          info += ` - Germinación: ${cepa.germinacion}`;
        }
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeCepa(${idx})'>🗑️</button>`;
        list.appendChild(div);
      });
    }

    // Funciones para extractores
    function addExtractor() {
      const cantidad = parseInt(document.getElementById('extractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('extractorPulgadas').value.trim();
      
      if (!pulgadas) return;
      
      extractores.push({ cantidad, pulgadas });
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      document.getElementById('extractorPulgadas').focus();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function removeExtractor(index) {
      extractores.splice(index, 1);
      renderExtractoresList();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function renderExtractoresList() {
      const list = document.getElementById('extractoresList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      extractores.forEach((extractor, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${extractor.cantidad} de ${extractor.pulgadas}"</span> <button class='extractor-remove' onclick='removeExtractor(${idx})'>🗑️</button>`;
        list.appendChild(div);
      });
    }

    function selectBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      selectedBitacora = bitacoras.find(b => b.id === id);
      
      if (selectedBitacora) {
        document.getElementById('mainContent').style.display = 'block';
        renderBitacoraSelector();
        setStage('vege');
        renderMoodButtons();
        renderHistory();
        renderCalendar();
        updateWeeklySummary();
      }
    }

    // Funciones de estado y renderizado
    function setStage(stage) {
      selectedStage = stage;
      document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('stage-selected'));
      document.getElementById('btn-' + stage).classList.add('stage-selected');
      
      
      // Mostrar/ocultar elementos según la etapa
      const floraStartContainer = document.getElementById('floraStartContainer');
      const bitacoraInfo = document.getElementById('bitacoraInfo');
      const entryForm = document.getElementById('entryForm');
      
      floraStartContainer.style.display = stage === 'flora' ? 'block' : 'none';
      
      if (stage === 'general') {
        bitacoraInfo.style.display = 'block';
        if (entryForm) entryForm.style.display = 'none';
        renderBitacoraInfo();
      } else {
        bitacoraInfo.style.display = 'none';
        if (entryForm) entryForm.style.display = 'block';
      }
      
      renderHistory();
      renderCalendar();
      updateWeeklySummary();
    }

    function setMood(m) {
      selectedMood = m;
      renderMoodButtons();
    }

    function renderMoodButtons() {
      const div = document.getElementById('moodOptions');
      if (!div) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      div.innerHTML = '';
      moodStates.forEach(state => {
        const span = document.createElement('span');
        span.className = 'mood-btn' + (selectedMood === state.value ? ' mood-selected' : '');
        span.innerText = `${state.icon} ${state.label}`;
        span.onclick = () => setMood(state.value);
        div.appendChild(span);
      });
    }

    function setWater(val) {
      didWater = val;
      document.getElementById('waterDetails').style.display = val ? 'block' : 'none';
    }

    function setFloraStart() {
      if (selectedBitacora) {
        selectedBitacora.floraStart = document.getElementById('floraStart').value;
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const index = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        if (index !== -1) {
          bitacoras[index] = selectedBitacora;
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        }
      }
    }

    function saveEntry() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bitácora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Elegí fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value
      };

      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
      
      if (bitacoraIndex !== -1) {
        let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
      entries.push(entry);
        bitacoras[bitacoraIndex].entries[selectedStage] = entries;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        selectedBitacora = bitacoras[bitacoraIndex];
        
      renderHistory();
      renderCalendar();
        updateWeeklySummary();
      }
    }

    function editEntry(date) {
      const modal = document.getElementById('editModal');
      modal.style.display = 'block';
      
      document.getElementById('editPassword').value = '';
      document.getElementById('editForm').style.display = 'none';
    }

    function verifyEditPassword() {
      const password = document.getElementById('editPassword').value;
      if (password === 'FUCK I MISS') {
        document.getElementById('editForm').style.display = 'block';
        // Aquí cargaríamos los datos de la entrada para editar
      } else {
        alert('Contraseña incorrecta');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function exportData() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bitácora primero.');
        return;
      }
      
      const data = {
        bitacora: selectedBitacora,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bitacora_${selectedBitacora.name}_export.json`;
      a.click();
    }

    function showEditBitacoraModal(bitacora) {
      const modal = document.getElementById('editBitacoraModal');
      const nameInput = document.getElementById('editBitacoraName');
      const colorPicker = document.getElementById('editColorPicker');
      
      nameInput.value = bitacora.name;
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option ${color === bitacora.color ? 'selected' : ''}" 
             style="background-color: ${color}" 
             onclick="selectEditColor(this)"></div>
      `).join('');

      // Agregar el selector de visibilidad
      const visibilityDiv = document.createElement('div');
      visibilityDiv.className = 'visibility-selector';
      visibilityDiv.innerHTML = `
        <label>Visibilidad:</label>
        <select id="editBitacoraVisibility">
          <option value="false" ${!bitacora.isPublic ? 'selected' : ''}>Privada</option>
          <option value="true" ${bitacora.isPublic ? 'selected' : ''}>Pública</option>
        </select>
      `;
      modal.querySelector('.edit-bitacora-content').insertBefore(
        visibilityDiv,
        modal.querySelector('.edit-bitacora-content button')
      );
      
      modal.dataset.bitacoraId = bitacora.id;
      modal.style.display = 'block';
    }

    function closeEditBitacoraModal() {
      document.getElementById('editBitacoraModal').style.display = 'none';
    }

    function selectEditColor(element) {
      document.querySelectorAll('#editColorPicker .color-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }

    function saveBitacoraEdit() {
      const modal = document.getElementById('editBitacoraModal');
      const bitacoraId = modal.dataset.bitacoraId;
      const newName = document.getElementById('editBitacoraName').value.trim();
      const selectedColor = document.querySelector('#editColorPicker .color-option.selected');
      const isPublic = document.getElementById('editBitacoraVisibility').value === 'true';
      
      if (!newName) {
        alert('Por favor, ingresa un nombre para la bitácora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bitácora.');
        return;
      }
      
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const index = bitacoras.findIndex(b => b.id === bitacoraId);
      
      if (index !== -1) {
        // Verificar si el nuevo nombre ya existe
        if (bitacoras.some(b => b.id !== bitacoraId && b.name.toLowerCase() === newName.toLowerCase())) {
          alert('Ya existe una bitácora con ese nombre. Por favor, elige otro.');
          return;
        }
        
        bitacoras[index].name = newName;
        bitacoras[index].color = selectedColor.style.backgroundColor;
        bitacoras[index].isPublic = isPublic;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        if (selectedBitacora?.id === bitacoraId) {
          selectedBitacora = bitacoras[index];
        }
        
        renderBitacoraSelector();
        closeEditBitacoraModal();
      }
    }

    function deleteBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const newBitacoras = bitacoras.filter(b => b.id !== id);
      
      localStorage.setItem('bitacoras', JSON.stringify(newBitacoras));
      
      if (selectedBitacora?.id === id) {
        selectedBitacora = null;
        document.getElementById('mainContent').style.display = 'none';
      }
      
      renderBitacoraSelector();
    }

    function shareBitacora(bitacora) {
      // Crear un objeto con los datos necesarios para compartir
      const shareData = {
        id: bitacora.id,
        name: bitacora.name,
        entries: bitacora.entries
      };
      
      // Convertir a base64 para el link
      const encodedData = btoa(JSON.stringify(shareData));
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
      
      // Crear el mensaje para WhatsApp
      const message = `¡Mira mi bitácora "${bitacora.name}"!\n${shareUrl}`;
      
      // Abrir WhatsApp con el mensaje
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Inicialización
    (function init() {
      renderBitacoraSelector();
      
      // Verificar si hay un link compartido
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('share');
      
      if (sharedData) {
        try {
          const decodedData = JSON.parse(atob(sharedData));
          // Crear una nueva bitácora con los datos compartidos
          const newBitacora = {
            id: Date.now().toString(),
            name: `${decodedData.name} (Compartida)`,
            color: availableColors[Math.floor(Math.random() * availableColors.length)],
            floraStart: null,
            isPublic: true,
            entries: decodedData.entries
          };
          
          const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
          bitacoras.push(newBitacora);
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          
          // Limpiar la URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Seleccionar la nueva bitácora
          selectBitacora(newBitacora.id);
        } catch (error) {
          console.error('Error al procesar datos compartidos:', error);
        }
      } else {
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }
      }
    })();

    // Funciones de respaldo
    function createBackup() {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const backup = {
        timestamp: new Date().toISOString(),
        data: bitacoras
      };
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.unshift(backup);
      
      // Mantener solo los últimos 10 respaldos
      if (backups.length > 10) {
        backups.pop();
      }
      
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      alert('Respaldo creado exitosamente');
    }

    function showBackups() {
      const modal = document.getElementById('backupModal');
      const backupList = document.getElementById('backupList');
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      
      backupList.innerHTML = backups.map((backup, index) => {
        const date = new Date(backup.timestamp);
        const formattedDate = date.toLocaleString();
        const bitacoraCount = backup.data.length;
        
        return `
          <div class="backup-item">
            <div class="backup-info">
              <div>${formattedDate}</div>
              <div>${bitacoraCount} bitácora${bitacoraCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="backup-actions">
              <button class="restore" onclick="restoreBackup(${index})">Restaurar</button>
              <button class="delete" onclick="deleteBackup(${index})">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
      
      modal.style.display = 'block';
    }

    function closeBackupModal() {
      document.getElementById('backupModal').style.display = 'none';
    }

    function restoreBackup(index) {
      if (!confirm('¿Estás seguro de que quieres restaurar este respaldo? Se perderán los cambios no guardados.')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      const backup = backups[index];
      
      if (backup) {
        localStorage.setItem('bitacoras', JSON.stringify(backup.data));
        selectedBitacora = null;
        renderBitacoraSelector();
        closeBackupModal();
        
        // Seleccionar la primera bitácora si existe
        if (backup.data.length > 0) {
          selectBitacora(backup.data[0].id);
        } else {
          // Solo mostrar formulario si el elemento existe
          if (document.getElementById('newBitacoraForm')) {
            showNewBitacoraForm();
          }
        }
        
        alert('Respaldo restaurado exitosamente');
      }
    }

    function deleteBackup(index) {
      if (!confirm('¿Estás seguro de que quieres eliminar este respaldo?')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.splice(index, 1);
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      
      showBackups(); // Actualizar la lista
    }

    function showHelpModal() {
      document.getElementById('helpModal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // Lógica para tipo de luz
    function selectLuz(tipo) {
      tipoLuz = tipo;
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      if (tipo === 'sol') {
        document.getElementById('luzSolBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
      } else if (tipo === 'luz') {
        document.getElementById('luzArtificialBtn').classList.add('selected');
        document.getElementById('luzArtificialFields').style.display = 'block';
      } else if (tipo === 'mixto') {
        document.getElementById('luzMixtoBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
        document.getElementById('luzArtificialFields').style.display = 'block';
      }
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.tipoLuz = tipoLuz;
        autoSave();
      }
    }

    // Función para mostrar/ocultar campo de germinación
    function toggleGerminacionField() {
      const tipo = document.getElementById('cepaTipo').value;
      const semillaFields = document.getElementById('semillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }

    function addLuz() {
      const nombre = document.getElementById('luzNombre').value.trim();
      const cantidad = parseInt(document.getElementById('luzCantidad').value, 10) || 1;
      const watts = parseInt(document.getElementById('luzWatts').value, 10) || 0;
      if (!nombre || !watts) return;
      luces.push({ nombre, cantidad, watts });
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
      document.getElementById('luzNombre').focus();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function removeLuz(index) {
      luces.splice(index, 1);
      renderLucesList();
      
      // Guardado automático
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function renderLucesList() {
      const list = document.getElementById('lucesList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      luces.forEach((luz, idx) => {
        const div = document.createElement('div');
        div.className = 'luz-item';
        div.innerHTML = `<span>${luz.nombre}</span> <span>x${luz.cantidad}</span> <span>${luz.watts}W</span> <button class='luz-remove' onclick='removeLuz(${idx})'>🗑️</button>`;
        list.appendChild(div);
      });
    }

    function renderBitacoraInfo() {
      if (!selectedBitacora) return;
      
      const container = document.getElementById('bitacoraInfoContent');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '';
      
      // Verificar si la bitácora tiene características guardadas
      if (!selectedBitacora.cepas && !selectedBitacora.tipoCultivo) {
        container.innerHTML = '<div class="no-info">Esta bitácora no tiene características guardadas. Edita la bitácora para agregar información.</div>';
        return;
      }
      
      const infoGrid = document.createElement('div');
      infoGrid.className = 'info-grid';
      
      // Sección de Cepas
      if (selectedBitacora.cepas && selectedBitacora.cepas.length > 0) {
        const cepasSection = document.createElement('div');
        cepasSection.className = 'info-section';
        cepasSection.innerHTML = '<h4>🌱 Cepas</h4>';
        selectedBitacora.cepas.forEach(cepa => {
          const item = document.createElement('div');
          item.className = 'info-item';
          let info = `<span class='info-label'>${cepa.nombre}</span> <span class='info-value cepa'>x${cepa.cantidad}</span> <span class='info-value'>(${cepa.tipo}`;
          if (cepa.tipo === 'semilla' && cepa.germinacion) {
            info += `, germinación: ${cepa.germinacion}`;
          }
          info += ")</span>";
          item.innerHTML = info;
          cepasSection.appendChild(item);
        });
        infoGrid.appendChild(cepasSection);
      }
      
      // Sección de Tipo de Cultivo
      if (selectedBitacora.tipoCultivo) {
        const cultivoSection = document.createElement('div');
        cultivoSection.className = 'info-section';
        cultivoSection.innerHTML = '<h4>🏠 Tipo de Cultivo</h4>';
        const cultivoItem = document.createElement('div');
        cultivoItem.className = 'info-item';
        const cultivoText = selectedBitacora.tipoCultivo.charAt(0).toUpperCase() + selectedBitacora.tipoCultivo.slice(1);
        cultivoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value ${selectedBitacora.tipoCultivo}">${cultivoText}</span>
        `;
        cultivoSection.appendChild(cultivoItem);
        // Información adicional para cultivo interior/invernadero
        if ((selectedBitacora.tipoCultivo === 'interior' || selectedBitacora.tipoCultivo === 'invernadero')) {
          if (selectedBitacora.numCarpas > 0) {
            const carpasItem = document.createElement('div');
            carpasItem.className = 'info-item';
            let carpasInfo = `${selectedBitacora.numCarpas}`;
            if (selectedBitacora.carpas && selectedBitacora.carpas.length > 0) {
              carpasInfo += ' (' + selectedBitacora.carpas.map((c, i) => `Carpa ${i+1}: ${c.metrosCuadrados} m²`).join(', ') + ')';
            }
            carpasItem.innerHTML = `
              <span class="info-label">Carpas</span>
              <span class="info-value">${carpasInfo}</span>
            `;
            cultivoSection.appendChild(carpasItem);
          }
          if (selectedBitacora.soloSala) {
            const salaItem = document.createElement('div');
            salaItem.className = 'info-item';
            let salaInfo = 'Solo sala';
            if (selectedBitacora.carpas && selectedBitacora.carpas.length === 1) {
              salaInfo += ` (${selectedBitacora.carpas[0].metrosCuadrados} m²)`;
            }
            salaItem.innerHTML = `
              <span class="info-label">Configuración</span>
              <span class="info-value">${salaInfo}</span>
            `;
            cultivoSection.appendChild(salaItem);
          }
        }
        infoGrid.appendChild(cultivoSection);
      }
      // Sección de Extractores
      if (selectedBitacora.extractores && selectedBitacora.extractores.length > 0) {
        const extSection = document.createElement('div');
        extSection.className = 'info-section';
        extSection.innerHTML = '<h4>💨 Extractores</h4>';
        selectedBitacora.extractores.forEach((ext, idx) => {
          const extItem = document.createElement('div');
          extItem.className = 'info-item';
          extItem.innerHTML = `<span class='info-label'>Extractor ${idx+1}</span> <span class='info-value'>x${ext.cantidad} de ${ext.pulgadas}"</span>`;
          extSection.appendChild(extItem);
        });
        infoGrid.appendChild(extSection);
      }
      
      // Sección de Iluminación
      if (selectedBitacora.tipoLuz || (selectedBitacora.luces && selectedBitacora.luces.length > 0)) {
        const luzSection = document.createElement('div');
        luzSection.className = 'info-section';
        luzSection.innerHTML = '<h4>💡 Iluminación</h4>';
        
        if (selectedBitacora.tipoLuz) {
          const tipoLuzItem = document.createElement('div');
          tipoLuzItem.className = 'info-item';
          let tipoLuzText = '';
          switch (selectedBitacora.tipoLuz) {
            case 'sol': tipoLuzText = '☀️ Sol'; break;
            case 'luz': tipoLuzText = '💡 Artificial'; break;
            case 'mixto': tipoLuzText = '🔄 Mixto'; break;
          }
          tipoLuzItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value luz">${tipoLuzText}</span>
          `;
          luzSection.appendChild(tipoLuzItem);
        }
        
        if (selectedBitacora.luces && selectedBitacora.luces.length > 0) {
          selectedBitacora.luces.forEach(luz => {
            const luzItem = document.createElement('div');
            luzItem.className = 'info-item';
            luzItem.innerHTML = `
              <span class="info-label">${luz.nombre}</span>
              <span class="info-value">x${luz.cantidad} (${luz.watts}W)</span>
            `;
            luzSection.appendChild(luzItem);
          });
        }
        
        // Información de lámparas para cultivo interior
        if (selectedBitacora.tipoCultivo === 'interior') {
          if (selectedBitacora.lamparasVege > 0) {
            const vegeItem = document.createElement('div');
            vegeItem.className = 'info-item';
            vegeItem.innerHTML = `
              <span class="info-label">Lámparas Vegetación</span>
              <span class="info-value">${selectedBitacora.lamparasVege}${selectedBitacora.wattsVege ? ` (${selectedBitacora.wattsVege})` : ''}</span>
            `;
            luzSection.appendChild(vegeItem);
          }
          
          if (selectedBitacora.lamparasFlora > 0) {
            const floraItem = document.createElement('div');
            floraItem.className = 'info-item';
            floraItem.innerHTML = `
              <span class="info-label">Lámparas Floración</span>
              <span class="info-value">${selectedBitacora.lamparasFlora}${selectedBitacora.wattsFlora ? ` (${selectedBitacora.wattsFlora})` : ''}</span>
            `;
            luzSection.appendChild(floraItem);
          }
        }
        
        infoGrid.appendChild(luzSection);
      }
      
      // Sección de Riego
      if (selectedBitacora.riegoOptions && selectedBitacora.riegoOptions.length > 0) {
        const riegoSection = document.createElement('div');
        riegoSection.className = 'info-section';
        riegoSection.innerHTML = '<h4>💧 Riego</h4>';
        
        selectedBitacora.riegoOptions.forEach(riego => {
          const riegoItem = document.createElement('div');
          riegoItem.className = 'info-item';
          let riegoText = '';
          switch (riego) {
            case 'manual': riegoText = '👋 Manual'; break;
            case 'goteo': riegoText = '💧 Goteo'; break;
            case 'hidroponica': riegoText = '🌊 Hidropónica'; break;
          }
          riegoItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value riego">${riegoText}</span>
          `;
          riegoSection.appendChild(riegoItem);
        });
        
        if (selectedBitacora.detalleRiego) {
          const detalleItem = document.createElement('div');
          detalleItem.className = 'info-item';
          detalleItem.innerHTML = `
            <span class="info-label">Detalles</span>
            <span class="info-value">${selectedBitacora.detalleRiego}</span>
          `;
          riegoSection.appendChild(detalleItem);
        }
        
        infoGrid.appendChild(riegoSection);
      }
      
      // Sección de Sustrato
      if (selectedBitacora.sustrato) {
        const sustratoSection = document.createElement('div');
        sustratoSection.className = 'info-section';
        sustratoSection.innerHTML = '<h4>🌱 Sustrato</h4>';
        
        const sustratoItem = document.createElement('div');
        sustratoItem.className = 'info-item';
        sustratoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value">${selectedBitacora.sustrato}</span>
        `;
        sustratoSection.appendChild(sustratoItem);
        
        infoGrid.appendChild(sustratoSection);
      }
      
      // Sección de Equipamiento (solo para cultivo interior)
      if (selectedBitacora.tipoCultivo === 'interior') {
        const equipamientoSection = document.createElement('div');
        equipamientoSection.className = 'info-section';
        equipamientoSection.innerHTML = '<h4>⚙️ Equipamiento</h4>';
        
        if (selectedBitacora.ventiladores > 0) {
          const ventiladoresItem = document.createElement('div');
          ventiladoresItem.className = 'info-item';
          ventiladoresItem.innerHTML = `
            <span class="info-label">Ventiladores</span>
            <span class="info-value">${selectedBitacora.ventiladores}${selectedBitacora.pulgadasVentilador ? ` (${selectedBitacora.pulgadasVentilador}")` : ''}</span>
          `;
          equipamientoSection.appendChild(ventiladoresItem);
        }
        
        if (selectedBitacora.filtroAire === 'si') {
          const filtroItem = document.createElement('div');
          filtroItem.className = 'info-item';
          filtroItem.innerHTML = `
            <span class="info-label">Filtro de Aire</span>
            <span class="info-value">✅ Sí</span>
          `;
          equipamientoSection.appendChild(filtroItem);
        }
        
        if (selectedBitacora.aireAcondicionado === 'si') {
          const aireItem = document.createElement('div');
          aireItem.className = 'info-item';
          aireItem.innerHTML = `
            <span class="info-label">Aire Acondicionado</span>
            <span class="info-value">✅ Sí${selectedBitacora.frigorias ? ` (${selectedBitacora.frigorias})` : ''}</span>
          `;
          equipamientoSection.appendChild(aireItem);
        }
        
        if (equipamientoSection.children.length > 1) { // Más de 1 porque incluye el h4
          infoGrid.appendChild(equipamientoSection);
        }
      }
      
      container.appendChild(infoGrid);
    }

    // Mostrar la fecha del último respaldo
    function setUltimoRespaldo(fecha) {
      const el = document.getElementById('ultimoRespaldo');
      if (!el) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      if (fecha) {
        el.textContent = 'Último respaldo: ' + fecha;
        localStorage.setItem('ultimoRespaldo', fecha);
      } else {
        const guardado = localStorage.getItem('ultimoRespaldo');
        el.textContent = 'Último respaldo: ' + (guardado || '-');
      }
    }
    // Llamar al cargar la página solo si el elemento existe
    if (document.getElementById('ultimoRespaldo')) {
      setUltimoRespaldo();
    }
    // Modificar createBackup para actualizar la fecha
    const originalCreateBackup = window.createBackup;
    window.createBackup = function() {
      if (originalCreateBackup) originalCreateBackup();
      const fecha = new Date().toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
      setUltimoRespaldo(fecha);
    }

    // Funciones auxiliares para el formulario
    function toggleInteriorFields() {
      const tipoCultivo = document.getElementById('tipoCultivo');
      const interiorFields = document.getElementById('interiorFields');
      if (!tipoCultivo || !interiorFields) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      interiorFields.style.display = tipoCultivo.value === 'interior' ? 'block' : 'none';
    }

    function toggleCarpasFields() {
      const numCarpasEl = document.getElementById('numCarpas');
      const soloSalaEl = document.getElementById('soloSala');
      const carpasList = document.getElementById('carpasList');
      
      if (!numCarpasEl || !soloSalaEl || !carpasList) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      
      const numCarpas = parseInt(numCarpasEl.value) || 0;
      const soloSala = soloSalaEl.checked;
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>🗑️</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala única</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>🗑️</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleFrigorias() {
      const aireAcondicionadoEl = document.getElementById('aireAcondicionado');
      const frigoriasList = document.getElementById('frigorias');
      
      if (!aireAcondicionadoEl || !frigoriasList) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      
      frigoriasList.style.display = aireAcondicionadoEl.value === 'si' ? 'block' : 'none';
    }

    // Funciones para edición de bitácora
    function toggleEditInteriorFields() {
      const tipoCultivo = document.getElementById('editTipoCultivo').value;
      const interiorFields = document.getElementById('editInteriorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleEditCarpasFields() {
      const numCarpas = parseInt(document.getElementById('editNumCarpas').value) || 0;
      const soloSala = document.getElementById('editSoloSala').checked;
      const carpasList = document.getElementById('editCarpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>🗑️</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala única</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>🗑️</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleEditFrigorias() {
      const aireAcondicionado = document.getElementById('editAireAcondicionado').value;
      const frigorias = document.getElementById('editFrigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edición de cepas en modal de edición
    let editCepas = [];
    function addEditCepa() {
      const nombre = document.getElementById('editCepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('editCepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('editCepaTipo').value;
      const germinacion = document.getElementById('editCepaGerminacion').value;
      if (!nombre) return;
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      editCepas.push(cepa);
      renderEditCepasList();
      document.getElementById('editCepaNombre').value = '';
      document.getElementById('editCepaCantidad').value = 1;
      document.getElementById('editCepaTipo').value = 'clon';
      document.getElementById('editCepaGerminacion').value = '';
      document.getElementById('editSemillaFields').style.display = 'none';
    }
    function removeEditCepa(index) {
      editCepas.splice(index, 1);
      renderEditCepasList();
    }
    function renderEditCepasList() {
      const list = document.getElementById('editCepasList');
      list.innerHTML = '';
      editCepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo}`;
        if (cepa.tipo === 'semilla' && cepa.germinacion) {
          info += `, germinación: ${cepa.germinacion}`;
        }
        info += ")";
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeEditCepa(${idx})'>🗑️</button>`;
        list.appendChild(div);
      });
    }
    function toggleEditGerminacionField() {
      const tipo = document.getElementById('editCepaTipo').value;
      const semillaFields = document.getElementById('editSemillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }
    // Funciones para extractores en edición
    let editExtractores = [];
    function addEditExtractor() {
      const cantidad = parseInt(document.getElementById('editExtractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('editExtractorPulgadas').value.trim();
      if (!pulgadas) return;
      editExtractores.push({ cantidad, pulgadas });
      renderEditExtractoresList();
      document.getElementById('editExtractorCantidad').value = 1;
      document.getElementById('editExtractorPulgadas').value = '';
    }
    function removeEditExtractor(index) {
      editExtractores.splice(index, 1);
      renderEditExtractoresList();
    }
    function renderEditExtractoresList() {
      const list = document.getElementById('editExtractoresList');
      list.innerHTML = '';
      editExtractores.forEach((ext, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${ext.cantidad} de ${ext.pulgadas}"</span> <button class='extractor-remove' onclick='removeEditExtractor(${idx})'>🗑️</button>`;
        list.appendChild(div);
      });
    }

    // Modo nocturno
    function toggleDarkMode() {
      const body = document.body;
      const btn = document.getElementById('toggleDarkMode');
      if (!btn) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      body.classList.toggle('dark-mode');
      if (body.classList.contains('dark-mode')) {
        btn.textContent = '☀️';
        localStorage.setItem('darkMode', '1');
      } else {
        btn.textContent = '🌙';
        localStorage.setItem('darkMode', '0');
      }
    }
    // Al cargar, aplicar modo guardado
    if (localStorage.getItem('darkMode') === '1') {
      document.body.classList.add('dark-mode');
      const toggleBtn = document.getElementById('toggleDarkMode');
      if (toggleBtn) toggleBtn.textContent = '☀️';
    }

    // Alternar formulario de nueva bitácora
    function toggleNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      if (!form) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      const btn = document.getElementById('btnNuevaBitacora');
      if (form.style.display === 'block' || form.classList.contains('active')) {
        form.style.display = 'none';
        form.classList.remove('active');
        if (btn) btn.textContent = '+ Nueva Bitácora';
      } else {
        form.style.display = 'block';
        form.classList.add('active');
        if (btn) btn.textContent = 'Cerrar';
        showNewBitacoraForm();
      }
    }

    var formPaciente = document.getElementById('formPaciente');
    if (formPaciente) {
      formPaciente.addEventListener('submit', function(e) {
        e.preventDefault();
        var nombreInput = document.getElementById('pacienteNombre');
        var dniInput = document.getElementById('pacienteDNI');
        if (!nombreInput || !dniInput) return;
        var nombre = nombreInput.value.trim();
        var dni = dniInput.value.trim();
        // ... resto del código ...
      });
    }

    var loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var userInput = document.getElementById('loginUser');
        var passInput = document.getElementById('loginPassword');
        if (!userInput || !passInput) return;
        var username = userInput.value.trim();
        var password = passInput.value;
        // ... resto del código ...
      });
    }

    window.mostrarFormularioPaciente = function() {
      var modal = document.getElementById('modalPaciente');
      if (modal) modal.style.display = 'block';
    };
    window.filtrarPacientes = function() {
      // Aquí deberías poner la lógica de filtrado de pacientes
      // Por ejemplo, si tienes una función cargarPacientes(filtro)
      var input = document.getElementById('busquedaPaciente');
      if (!input) return;
      var filtro = input.value;
      if (typeof cargarPacientes === 'function') cargarPacientes(filtro);
    };
    function clearUserData() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
      localStorage.removeItem('bitacoras');
      localStorage.removeItem('bitacora_backups');
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f5f7fa">
  <title>CLINICAL DATA - Sistema de Gesti√≥n M√©dica</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    :root {
      /* Colores principales */
      --primary: #667eea;
      --primary-light: #764ba2;
      --primary-dark: #5a67d8;
      --accent: #4facfe;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
      
      /* Modo claro */
      --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --surface: #ffffff;
      --surface-secondary: #f7fafc;
      --surface-tertiary: #edf2f7;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text: #2d3748;
      --text-light: #718096;
      --text-muted: #a0aec0;
      
      /* Sombras modernas */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Efectos glassmorphism */
      --glass: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      
      /* Radio y espaciado */
      --radius: 16px;
      --radius-lg: 20px;
      --radius-xl: 24px;
    }

    /* Modo nocturno */
    .dark-mode {
      --background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      --surface: #2d3748;
      --surface-secondary: #4a5568;
      --surface-tertiary: #718096;
      --border: #4a5568;
      --border-light: #718096;
      --text: #f7fafc;
      --text-light: #e2e8f0;
      --text-muted: #cbd5e0;
      --glass: rgba(45, 55, 72, 0.25);
      --glass-border: rgba(45, 55, 72, 0.18);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    }
    body {
      font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      line-height: 1.6;
      transition: all 0.3s ease;
      overflow-x: hidden;
    }

    /* Fondo animado con part√≠culas sutiles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background);
      z-index: -1;
      opacity: 0.1;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .container {
      max-width: 450px;
      margin: 20px auto;
      background: var(--surface);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      padding: 40px 32px;
      border: 1px solid var(--glass-border);
      position: relative;
      transition: all 0.3s ease;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--glass);
      border-radius: var(--radius-xl);
      z-index: -1;
    }
    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
      text-align: center;
      line-height: 1.2;
    }

    h2, h3 {
      color: var(--text);
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.5rem;
    }

    h4 {
      color: var(--primary);
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      display: block;
      font-size: 0.875rem;
      letter-spacing: 0.025em;
    }

    input[type="text"], 
    input[type="email"], 
    input[type="password"], 
    input[type="date"], 
    input[type="time"],
    input[type="tel"],
    textarea, 
    select {
      width: 100%;
      padding: 16px;
      border-radius: var(--radius);
      border: 2px solid var(--border);
      background: var(--surface-secondary);
      font-size: 1rem;
      margin-bottom: 20px;
      box-sizing: border-box;
      transition: all 0.3s ease;
      font-family: inherit;
      color: var(--text);
      backdrop-filter: blur(10px);
    }

    input:focus, 
    textarea:focus, 
    select:focus {
      border-color: var(--primary);
      background: var(--surface);
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    button {
      width: 100%;
      padding: 16px 24px;
      border-radius: var(--radius);
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      font-size: 1rem;
      font-weight: 600;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.025em;
      box-shadow: var(--shadow);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    button:hover::before {
      left: 100%;
    }

    button:active {
      transform: translateY(0);
    }
    .form-card {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 32px 24px;
      margin-bottom: 24px;
      border: 1px solid var(--glass-border);
      position: relative;
      overflow: hidden;
    }

    .form-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--glass);
      z-index: -1;
    }

    .center {
      text-align: center;
    }

    .link {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }

    .link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -2px;
      left: 0;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    .link:hover::after {
      width: 100%;
    }

    .error-message {
      background: rgba(254, 226, 226, 0.9);
      color: #b91c1c;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid #fecaca;
      margin-bottom: 20px;
      font-size: 0.875rem;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .success-message {
      background: rgba(209, 250, 229, 0.9);
      color: #065f46;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid #bbf7d0;
      margin-bottom: 20px;
      font-size: 0.875rem;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    .pacientes-section, #fichaPaciente {
      margin-top: 24px;
    }
    .paciente-card {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      border: 1px solid var(--glass-border);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .paciente-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--glass);
      z-index: -1;
    }

    .paciente-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 40px 32px;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      margin: 20px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--glass-border);
      position: relative;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--glass);
      border-radius: var(--radius-xl);
      z-index: -1;
    }
    .close-modal {
      position: absolute;
      right: 16px;
      top: 16px;
      cursor: pointer;
      font-size: 1.5em;
      color: var(--text-light);
      background: none;
      border: none;
    }
    @media (max-width: 600px) {
      .container { padding: 12px 2px; }
      .modal-content { padding: 18px 6px; }
    }
    
    /* Estilos espec√≠ficos para sistema m√©dico */
    .form-section {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--glass);
      z-index: -1;
    }

    .form-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      width: 100%;
      margin: 8px 0;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.025em;
      box-shadow: var(--shadow);
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:hover::before {
      left: 100%;
    }
    
    .btn-secondary {
      background: var(--surface-secondary);
      color: var(--text);
      border: 2px solid var(--border);
      padding: 12px 20px;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      flex: 1;
      backdrop-filter: blur(10px);
    }
    
    .btn-secondary:hover {
      background: var(--surface);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      flex: 1;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    input[type="file"] {
      display: none;
    }
    
    label[for="archivoEstudio"] {
      display: inline-block;
      background: var(--bg-secondary);
      border: 2px dashed var(--border-light);
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      color: var(--text-light);
      transition: all 0.2s ease;
      width: 100%;
      margin-top: 8px;
    }
    
    label[for="archivoEstudio"]:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    #estadoSelect {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    
    #visitTime {
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      margin: 8px 0;
    }
    
    /* Estilos para calendario */
    #calendarioGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin: 16px 0;
      background: var(--border-light);
      border-radius: 8px;
      padding: 4px;
    }
    
    .calendar-day {
      background: var(--bg);
      padding: 8px;
      text-align: center;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 4px;
    }
    
    .calendar-day:hover {
      background: var(--bg-secondary);
    }
    
    .calendar-day.today {
      background: var(--primary);
      color: white;
      font-weight: bold;
    }
    
    .calendar-day.has-cita {
      background: var(--primary);
      color: white;
    }
    
    .calendar-day.other-month {
      color: var(--text-light);
      background: var(--bg-tertiary);
    }
    
    .cita-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      margin-top: 2px;
    }
    
    /* Estilos para recordatorios */
    .recordatorio-item {
      background: var(--bg);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .recordatorio-item.urgent {
      border-color: #dc2626;
      background: #fef2f2;
    }
    
    .recordatorio-item.today {
      border-color: var(--primary);
      background: #eff6ff;
    }
    
    /* Canvas para gr√°ficos */
    #chartEvolucion {
      max-width: 100%;
      height: auto;
    }
    
    /* Estilos para citas */
    .cita-item {
      background: var(--bg);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      border-left: 4px solid var(--primary);
    }
    
    .cita-item.past {
      opacity: 0.7;
      border-left-color: var(--text-light);
    }
    
    .cita-item.today {
      border-left-color: #dc2626;
      background: #fef2f2;
    }

    /* Estilos adicionales para bot√≥n modo nocturno */
    #toggleDarkMode:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    /* Mejoras para el authContainer */
    #authContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
    }

    #userInfo {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 200px;
    }

    #userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    #userName {
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #userEmail {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mejoras para responsive */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 24px 20px;
      }
      
      h1 {
        font-size: 2rem;
      }

      #toggleDarkMode {
        bottom: 16px;
        right: 16px;
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
      }

      /* Arreglar authContainer en m√≥vil */
      #authContainer {
        position: relative;
        top: auto;
        right: auto;
        margin: 0 10px 16px 10px;
        z-index: 999;
      }

      #userInfo {
        position: relative;
        top: auto;
        right: auto;
        margin: 0;
        width: 100%;
        min-width: auto;
        padding: 12px;
        gap: 8px;
        border-radius: var(--radius);
      }

      #userAvatar {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }

      #userName {
        font-size: 0.8rem;
        max-width: 120px;
      }

      #userEmail {
        font-size: 0.7rem;
        max-width: 120px;
      }

      /* Arreglar botones en m√≥vil */
      .btn-secondary, .btn-primary {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 12px 8px;
        font-size: 0.8rem;
        line-height: 1.2;
      }

      /* Arreglar el contenedor de b√∫squeda en m√≥vil */
      #searchContainer .btn-secondary {
        min-height: 44px;
        white-space: nowrap;
        overflow: hidden;
      }

      .modal-content {
        margin: 10px;
        padding: 24px 20px;
        max-width: calc(100vw - 20px);
      }

      /* Espaciado adicional para evitar que el userInfo tape contenido */
      #mainContent {
        margin-top: 10px;
      }

      /* Bot√≥n logout en m√≥vil */
      #logoutBtn {
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
        min-width: 50px;
        width: auto !important;
        margin: 0 !important;
      }

      /* Mejoras adicionales para texto en botones m√≥vil */
      #searchContainer div {
        flex-wrap: wrap;
        gap: 6px;
      }

      #searchContainer .btn-secondary,
      #searchContainer .btn-primary {
        flex: 1;
        min-width: 0;
        padding: 12px 6px;
        font-size: 0.75rem;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
  <!-- Firebase v9 SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, enableNetwork, disableNetwork, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDpwMc60IPAJiBwYU6PPc0QHrHSqhKjE8s",
      authDomain: "clinical-70644.firebaseapp.com",
      projectId: "clinical-70644",
      storageBucket: "clinical-70644.firebasestorage.app",
      messagingSenderId: "166670165939",
      appId: "1:166670165939:web:05e9352a1a96dbd2a58dc6"
    };
    window.firebaseConfig = firebaseConfig;

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Configuraci√≥n avanzada para Firebase v9 - MEJORAR CONECTIVIDAD
    try {
      // Intentar habilitar red si est√° deshabilitada
      await enableNetwork(db);
      console.log('üåê Red Firebase habilitada');
    } catch (e) {
      console.warn('‚ö†Ô∏è No se pudo habilitar red Firebase:', e);
    }

    // Make globally available
    window.auth = auth;
    window.db = db;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signOut = signOut;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.doc = doc;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;

    // Inicializar onAuthStateChanged inmediatamente
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('‚úÖ Usuario autenticado:', user.email);
        window.currentUser = user;
        window.isAuthenticated = true;
        
        // Mostrar interfaz de usuario autenticado
        const authContainer = document.querySelector('.container');
        const mainContent = document.getElementById('mainContent');
        if (authContainer) authContainer.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';
        
        // CARGAR DATOS DEL USUARIO AUTOM√ÅTICAMENTE
        try {
          console.log('üîÑ Cargando datos del usuario...');
          
          // Cargar pacientes desde Firebase
          const pacientesSnapshot = await getDocs(collection(db, 'users', user.uid, 'pacientes'));
          window.allPacientes = [];
          pacientesSnapshot.forEach(doc => {
            window.allPacientes.push({ id: doc.id, ...doc.data() });
          });
          
          // Cargar recordatorios
          const recordatoriosSnapshot = await getDocs(collection(db, 'users', user.uid, 'recordatorios'));
          window.allRecordatorios = [];
          recordatoriosSnapshot.forEach(doc => {
            window.allRecordatorios.push({ id: doc.id, ...doc.data() });
          });
          
          // Cargar citas
          const citasSnapshot = await getDocs(collection(db, 'users', user.uid, 'citas'));
          window.allCitas = [];
          citasSnapshot.forEach(doc => {
            window.allCitas.push({ id: doc.id, ...doc.data() });
          });
          
          console.log('‚úÖ Datos cargados:', {
            pacientes: window.allPacientes.length,
            recordatorios: window.allRecordatorios.length,
            citas: window.allCitas.length
          });

          // DETECTOR AUTOM√ÅTICO - Si no hay datos en Firebase, usar localStorage DIRECTO
          if (window.allPacientes.length === 0 && window.allRecordatorios.length === 0 && window.allCitas.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron datos en Firebase, verificando localStorage...');
            
            // CARGAR DIRECTAMENTE DESDE localStorage (m√©todo m√°s confiable)
            try {
              const localPacientes = localStorage.getItem('allPacientes');
              const localRecordatorios = localStorage.getItem('allRecordatorios');
              const localCitas = localStorage.getItem('allCitas');
              
              if (localPacientes) {
                window.allPacientes = JSON.parse(localPacientes) || [];
                console.log(`üì¶ Pacientes cargados desde localStorage: ${window.allPacientes.length}`);
              }
              if (localRecordatorios) {
                window.allRecordatorios = JSON.parse(localRecordatorios) || [];
                console.log(`üì¶ Recordatorios cargados desde localStorage: ${window.allRecordatorios.length}`);
              }
              if (localCitas) {
                window.allCitas = JSON.parse(localCitas) || [];
                console.log(`üì¶ Citas cargadas desde localStorage: ${window.allCitas.length}`);
              }
              
              // Tambi√©n intentar backup unificado como fallback
              if (window.allPacientes.length === 0) {
                const backupData = localStorage.getItem('clinicalDataBackup');
                if (backupData) {
                  const parsed = JSON.parse(backupData);
                  if (parsed.pacientes && parsed.pacientes.length > 0) {
                    window.allPacientes = parsed.pacientes || [];
                    window.allRecordatorios = parsed.recordatorios || [];
                    window.allCitas = parsed.citas || [];
                    console.log('üì¶ Datos restaurados desde backup unificado');
                  }
                }
              }
              
              console.log('‚úÖ Datos finales cargados:', {
                pacientes: window.allPacientes.length,
                recordatorios: window.allRecordatorios.length,
                citas: window.allCitas.length
              });
            } catch (e) {
              console.error('‚ùå Error al cargar desde localStorage:', e);
              // Inicializar arrays vac√≠os si hay error
              window.allPacientes = [];
              window.allRecordatorios = [];
              window.allCitas = [];
            }
          }
          
          // Actualizar interfaz FORZADO
          setTimeout(() => {
            if (window.renderPacienteSelector) {
              window.renderPacienteSelector();
            }
            // ACTUALIZAR INTERFAZ SIEMPRE (con o sin datos)
            const pacienteSelector = document.getElementById('pacienteSelector');
            if (pacienteSelector) {
              console.log('üîÑ Actualizando selector de pacientes...');
              let html = '<h3>Pacientes</h3>';
              
              if (window.allPacientes && window.allPacientes.length > 0) {
                window.allPacientes.forEach(paciente => {
                  html += `
                    <div class="paciente-card" onclick="window.selectPaciente('${paciente.id}')">
                      <h4>${paciente.nombre}</h4>
                      <p>DNI: ${paciente.dni}</p>
                      <p>${paciente.patologia || 'Sin patolog√≠a especificada'}</p>
                    </div>
                  `;
                });
                console.log(`‚úÖ Mostrando ${window.allPacientes.length} pacientes`);
              } else {
                html += '<p style="color: white; font-style: italic; text-align: center; margin: 20px 0; font-size: 16px;">No hay pacientes registrados</p>';
                console.log('‚ÑπÔ∏è No hay pacientes para mostrar');
              }
              
              pacienteSelector.innerHTML = html;
              console.log('‚úÖ Selector de pacientes actualizado');
            }
          }, 500);
          
          // Backup local
          if (window.backupAfterAction) {
            window.backupAfterAction({
              pacientes: window.allPacientes,
              recordatorios: window.allRecordatorios,
              citas: window.allCitas
            });
          }
          
        } catch (error) {
          console.error('‚ùå Error al cargar datos del usuario:', error);
          // Cargar desde backup local como fallback
          if (window.restoreFromBackupIfNeeded) {
            window.restoreFromBackupIfNeeded();
          }
        }
        
      } else {
        console.log('‚ùå Usuario no autenticado');
        window.currentUser = null;
        window.isAuthenticated = false;
        
        // Limpiar datos
        window.allPacientes = [];
        window.allRecordatorios = [];
        window.allCitas = [];
        
        // Mostrar interfaz de login
        const authContainer = document.querySelector('.container');
        const mainContent = document.getElementById('mainContent');
        if (authContainer) authContainer.style.display = 'block';
        if (mainContent) mainContent.style.display = 'none';
      }
    });

    // Funci√≥n UNIFICADA para seleccionar paciente
    window.selectPaciente = function(pacienteParam) {
      console.log('üîÑ Intentando seleccionar paciente:', pacienteParam);
      
      let paciente = null;
      
      // Si es un string (ID), buscar el paciente
      if (typeof pacienteParam === 'string') {
        const allPacientesArray = window.allPacientes || allPacientes || [];
        paciente = allPacientesArray.find(p => p.id === pacienteParam);
        console.log('üîç Buscando paciente por ID:', pacienteParam, 'Encontrado:', !!paciente);
      } 
      // Si es un objeto (paciente completo), usarlo directamente
      else if (typeof pacienteParam === 'object' && pacienteParam.id) {
        paciente = pacienteParam;
        console.log('üìã Usando objeto paciente directo:', paciente.nombre);
      }
      
      if (paciente) {
        // Sincronizar variables globales
        window.selectedPaciente = paciente;
        selectedPaciente = paciente;
        
        console.log('‚úÖ Paciente seleccionado exitosamente:', paciente.nombre);
        
        // Ocultar selectores
        const pacienteSelector = document.getElementById('pacienteSelector');
        const newPacienteForm = document.getElementById('newPacienteForm');
        
        if (pacienteSelector) pacienteSelector.style.display = 'none';
        if (newPacienteForm) newPacienteForm.style.display = 'none';
        
        // Mostrar ficha cl√≠nica
        showFichaClinica();
        setStage('primera'); // Inicializar en primera consulta
        
      } else {
        console.error('‚ùå No se pudo encontrar el paciente:', pacienteParam);
        alert('‚ùå Error: No se pudo seleccionar el paciente');
      }
    };

    console.log('‚úÖ Firebase v9 inicializado correctamente');
    console.log('‚úÖ Auth disponible:', !!window.auth);
    console.log('‚úÖ Firestore disponible:', !!window.db);
    </script>

  <!-- Firebase v9 compat (para soportar db.collection y API estilo v8) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    (function(){
      try {
        if (typeof firebase === 'undefined') return;

        // Obtener o inicializar app compat usando la misma configuraci√≥n
        var compatApp;
        try {
          compatApp = firebase.app();
        } catch (e) {
          if (window.firebaseConfig) {
            compatApp = firebase.initializeApp(window.firebaseConfig);
          }
        }

        var authCompat = firebase.auth(compatApp);
        var dbCompat = firebase.firestore(compatApp);

        // Preferir compat globalmente para soportar llamadas db.collection(...)
        window.auth = authCompat;
        window.db = dbCompat;

        // Wrappers para compatibilizar llamadas estilo modular usadas en algunos puntos
        function refFromSegments(segments) {
          var ref = dbCompat;
          for (var i = 0; i < segments.length; i += 2) {
            var coll = segments[i];
            var id = segments[i + 1];
            if (id === undefined) {
              ref = ref.collection(coll);
            } else {
              ref = ref.collection(coll).doc(id);
            }
          }
          return ref;
        }

        window.doc = function(_dbIgnored) {
          var segments = Array.prototype.slice.call(arguments, 1);
          return { _segments: segments };
        };
        window.setDoc = async function(refObj, data, options) {
          var ref = refFromSegments(refObj._segments || []);
          return ref.set(data, options);
        };
        window.deleteDoc = async function(refObj) {
          var ref = refFromSegments(refObj._segments || []);
          return ref.delete();
        };
        window.collection = function(_dbIgnored) {
          var segments = Array.prototype.slice.call(arguments, 1);
          return { _collectionSegments: segments };
        };
        window.getDocs = async function(collectionRef) {
          var ref = refFromSegments(collectionRef._collectionSegments || []);
          return ref.get();
        };

        // Reexponer helpers de auth estilo modular para no romper referencias
        window.signInWithEmailAndPassword = function(_authIgnored, email, password) {
          return authCompat.signInWithEmailAndPassword(email, password);
        };
        window.createUserWithEmailAndPassword = function(_authIgnored, email, password) {
          return authCompat.createUserWithEmailAndPassword(email, password);
        };
        window.onAuthStateChanged = function(_authIgnored, cb) {
          return authCompat.onAuthStateChanged(cb);
        };
        window.signOut = function(_authIgnored) {
          return authCompat.signOut();
        };

        console.log('üîÅ Firebase compat activado: db.collection() disponible');
      } catch (e) {
        console.warn('‚ö†Ô∏è No se pudo activar compat:', e);
      }
    })();
  </script>
  
  <!-- Librer√≠as UMD sin conflictos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- Servicio de sincronizaci√≥n alternativo -->
  <script src="sync-service.js"></script>
    
  </head>
<body>
  <div class="container">
    <h1>üìã CLINICAL DATA</h1>
    <p style="text-align: center; color: var(--text-light); margin-bottom: 16px;">Sistema de Gesti√≥n de Pacientes</p>
    
    <!-- Bot√≥n de ayuda m√©dica -->
    <div style="text-align: center; margin-bottom: 24px;">
      <button onclick="showSoftwareInfo()" style="
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
      " 
      onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 20px rgba(79, 70, 229, 0.4)'"
      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(79, 70, 229, 0.3)'"
      title="¬øQu√© puede hacer este software?">ü©∫‚ùì</button>
      <p style="color: var(--text-light); font-size: 0.85rem; margin-top: 8px;">¬øQu√© puede hacer este software?</p>
    </div>
    
    <!-- Bot√≥n de acceso directo (bypass temporal) -->
    <div style="text-align: center; margin-bottom: 16px;">
      <button onclick="bypassAuth()" style="
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        transition: all 0.3s ease;
      " 
      onmouseover="this.style.transform='scale(1.05)'"
      onmouseout="this.style.transform='scale(1)'">
        üö® ACCESO DIRECTO (Firebase roto)
      </button>
      <p style="color: var(--text-light); font-size: 0.8rem; margin-top: 4px;">Usar mientras se arregla Firebase</p>
    </div>
    
    <div id="loginCard" class="form-card">
      <h2>Iniciar Sesi√≥n</h2>
      <form id="loginForm">
        <div id="loginError" class="error-message" style="display:none;"></div>
        <div id="loginConfigHelp" class="error-message" style="display:none; background:#fef3c7; color:#92400e; border-color:#fbbf24;">
          <strong>üîß Configuraci√≥n Requerida:</strong><br>
          <a href="https://console.firebase.google.com/project/clinical-70644/authentication/providers" target="_blank" style="color:#92400e; text-decoration:underline;">
            Click aqu√≠ para configurar Firebase Authentication
          </a><br>
          <small>1. Ve a Authentication ‚Üí Sign-in method<br>2. Habilita Email/Password<br>3. Guarda cambios</small>
        </div>
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required autocomplete="username">
        <label for="loginPassword">Contrase√±a</label>
        <input type="password" id="loginPassword" required autocomplete="current-password">
        <button type="submit">Entrar</button>
      </form>
      <div class="center">
        <span class="link" onclick="showRegister()">¬øNo tienes cuenta? Reg√≠strate</span>
      </div>
    </div>
    <div id="registerCard" class="form-card" style="display:none;">
      <h2>Crear Cuenta</h2>
      <form id="registerForm">
        <div id="registerError" class="error-message" style="display:none;"></div>
        <div id="firebaseConfigHelp" class="error-message" style="display:none; background:#fef3c7; color:#92400e; border-color:#fbbf24;">
          <strong>üîß Configuraci√≥n Requerida:</strong><br>
          <a href="https://console.firebase.google.com/project/clinical-70644/authentication/providers" target="_blank" style="color:#92400e; text-decoration:underline;">
            Click aqu√≠ para configurar Firebase Authentication
          </a><br>
          <small>1. Ve a Authentication ‚Üí Sign-in method<br>2. Habilita Email/Password<br>3. Guarda cambios</small>
        </div>
        <label for="registerName">Nombre completo</label>
        <input type="text" id="registerName" required>
        <label for="registerEmail">Email</label>
        <input type="email" id="registerEmail" required autocomplete="username">
        <label for="registerPassword">Contrase√±a</label>
        <input type="password" id="registerPassword" required autocomplete="new-password">
        <button type="submit">Crear cuenta</button>
      </form>
      <div class="center">
        <span class="link" onclick="showLogin()">¬øYa tienes cuenta? Inicia sesi√≥n</span>
      </div>
    </div>
  </div>

  <!-- Estructura principal de la aplicaci√≥n (oculta inicialmente) -->
  <div id="authContainer" style="display: none;">
    <div id="userInfo" style="display: none;">
      <div id="userAvatar"></div>
      <div style="flex: 1; min-width: 0;">
        <div id="userName"></div>
        <div id="userEmail"></div>
      </div>
      <button onclick="logout()" id="logoutBtn" style="
        padding: 8px 12px;
        margin: 0;
        width: auto;
        font-size: 0.8rem;
        border-radius: 8px;
        background: var(--danger);
        flex-shrink: 0;
      ">Salir</button>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <!-- Barra de b√∫squeda de pacientes -->
    <div id="searchContainer" class="form-section">
      <h4>üîç Buscar Pacientes</h4>
      <input type="text" id="searchInput" placeholder="Buscar por nombre, DNI o diagn√≥stico..." oninput="searchPacientes()">
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button onclick="showNewPacienteForm()" class="btn-primary" style="flex: 1;">‚ûï Nuevo Paciente</button>
        <button onclick="showRecordatorios()" class="btn-secondary" style="flex: 1;">‚è∞ Recordatorios</button>
        <button onclick="showCalendario()" class="btn-secondary" style="flex: 1;">üìÖ Calendario</button>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button onclick="window.forceSyncData()" class="btn-secondary" style="flex: 1; background: linear-gradient(135deg, #4f46e5, #7c3aed);">üåê Sincronizar Datos</button>
        <button onclick="window.location.reload()" class="btn-secondary" style="flex: 1;">üîÑ Recargar App</button>
      </div>
    </div>
    
    <!-- Selector de Pacientes -->
    <div id="pacienteSelector"></div>
    
    <!-- Ficha Cl√≠nica del Paciente -->
    <div id="fichaClinica" style="display: none;">
      <div class="form-section">
        <h4>üë§ Ficha Cl√≠nica</h4>
        <div id="pacienteInfo"></div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
          <button onclick="editPaciente()" class="btn-secondary">‚úèÔ∏è Editar</button>
          <button onclick="exportHistoriaJSON()" class="btn-secondary">üìÑ JSON</button>
          <button onclick="exportHistoriaPDF()" class="btn-secondary">üìã PDF</button>
          <button onclick="deletePaciente()" class="btn-danger">üóëÔ∏è Eliminar</button>
        </div>
      </div>
      
      <div class="form-section">
        <h4>üìä Estad√≠sticas</h4>
        <div id="estadisticasPaciente"></div>
      </div>
      
      <div class="form-section">
        <h4>üìà Evoluci√≥n del Paciente</h4>
        <canvas id="chartEvolucion" width="400" height="200"></canvas>
      </div>
      
      <div class="form-section">
        <h4>üîî Pr√≥ximos Recordatorios</h4>
        <div id="proximosRecordatorios"></div>
      </div>
    </div>
    
    <!-- Formulario Nuevo Paciente -->
    <div id="newPacienteForm" style="display: none;">
      <h3>üìù Nuevo Paciente</h3>
      
      <!-- Datos Personales -->
      <div class="form-section">
        <h4>üë§ Datos Personales</h4>
        <input type="text" id="pacienteNombre" placeholder="Nombre completo" required>
        <input type="text" id="pacienteDNI" placeholder="DNI" required>
        <input type="text" id="pacienteDireccion" placeholder="Direcci√≥n">
        <input type="tel" id="pacienteTelefono" placeholder="N√∫mero de tel√©fono">
        <input type="text" id="pacienteObraSocial" placeholder="Obra social">
        <textarea id="pacientePatologia" placeholder="Diagn√≥stico presuntivo / Patolog√≠a"></textarea>
      </div>
      
      <div id="colorPicker"></div>
             
       <button onclick="createNewPaciente()" class="btn-primary">üë§ Crear Paciente</button>
    </div>
    
    <!-- Botones de Etapa -->
    <div>
      <button id="btn-primera" class="stage-btn" onclick="setStage('primera')">ü©∫ Consulta</button>
      <button id="btn-seguimiento" class="stage-btn" onclick="setStage('seguimiento')">üìã Seguimiento</button>
      <button id="btn-urgencia" class="stage-btn" onclick="setStage('urgencia')">üö® Urgencia</button>
      <button id="btn-control" class="stage-btn" onclick="setStage('control')">‚úÖ Control</button>
    </div>
    
    <!-- Contenido seg√∫n etapa -->
    <div id="floraStartContainer" style="display: none;">
      <input type="date" id="floraStart" onchange="setFloraStart()">
    </div>
    
    <div id="bitacoraInfo" style="display: none;">
      <div id="bitacoraInfoContent"></div>
    </div>
    
    <div id="visitForm">
      <div class="form-section">
        <h4>üìÖ Datos de la Visita</h4>
        <input type="date" id="date">
        <input type="time" id="visitTime" value="09:00">
        
        <!-- Estados Cl√≠nicos -->
        <div id="estadoClinico">
          <h5>üè• Estado Cl√≠nico</h5>
          <select id="estadoSelect">
            <option value="estable">‚úÖ Estable</option>
            <option value="critico">üö® Cr√≠tico</option>
            <option value="observacion">üëÅÔ∏è En Observaci√≥n</option>
            <option value="mejoria">üìà En Mejor√≠a</option>
            <option value="alta">üè† Dado de Alta</option>
          </select>
        </div>
      </div>
      
      <div class="form-section">
        <h4>ü©∫ Informaci√≥n Cl√≠nica</h4>
        <textarea id="sintomas" placeholder="S√≠ntomas y problemas actuales reportados"></textarea>
        <textarea id="observaciones" placeholder="Observaciones cl√≠nicas"></textarea>
        <textarea id="tratamiento" placeholder="Tratamiento / Receta m√©dica / Tareas pendientes"></textarea>
      </div>
      
      <div class="form-section">
        <h4>üìä Estudios y Archivos</h4>
        <textarea id="estudios" placeholder="Resultados de estudios y an√°lisis (texto)"></textarea>
        
        <!-- Secci√≥n de carga de archivos mejorada -->
        <div style="border: 2px dashed var(--primary); border-radius: 8px; padding: 16px; margin-top: 12px; background: var(--bg-secondary);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <input type="file" id="archivoEstudio" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" multiple style="display: none;">
            <button type="button" onclick="document.getElementById('archivoEstudio').click()" style="
              background: var(--primary);
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            ">üìé Seleccionar Archivos</button>
            <span id="fileCount" style="color: var(--text-light); font-size: 14px;">Ning√∫n archivo seleccionado</span>
          </div>
          
          <!-- Lista de archivos seleccionados -->
          <div id="selectedFiles" style="display: none;">
            <h5 style="margin: 8px 0; color: var(--text);">üìÑ Archivos seleccionados:</h5>
            <div id="fileList" style="max-height: 120px; overflow-y: auto;"></div>
          </div>
          
          <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
            ‚úÖ Formatos soportados: PDF, DOC, DOCX, JPG, JPEG, PNG, TXT<br>
            üìè Tama√±o m√°ximo por archivo: 10MB
          </div>
        </div>
        
        <!-- Archivos guardados anteriormente -->
        <div id="savedFiles" style="margin-top: 16px;">
          <h5 style="margin: 8px 0; color: var(--text);">üíæ Archivos guardados:</h5>
          <div id="savedFilesList" style="max-height: 120px; overflow-y: auto;">
            <p style="color: var(--text-light); font-style: italic;">No hay archivos guardados</p>
          </div>
        </div>
      </div>
      
      <button onclick="saveVisit()" class="btn-primary">üíæ Guardar Visita</button>
    </div>
    
    <!-- Resumen Semanal -->
    <div>
      <div id="totalEntries"></div>
      <div id="averageMood"></div>
      <div id="wateredDays"></div>
      <div id="emotionTimeline"></div>
    </div>
    
    <!-- Historial y Calendario -->
    <div id="history"></div>
    
    <!-- Calendario de Citas -->
    <div id="calendarioSection" style="display: none;">
      <div class="form-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4>üìÖ Calendario de Citas</h4>
          <button onclick="backToPacientes()" class="btn-secondary">‚¨ÖÔ∏è Volver a Pacientes</button>
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="date" id="citaFecha">
          <input type="time" id="citaHora" value="09:00">
          <select id="citaPaciente">
            <option value="">Seleccionar paciente...</option>
          </select>
          <button onclick="crearCita()" class="btn-primary">‚ûï Nueva Cita</button>
        </div>
        <div id="calendarioGrid"></div>
        <div id="citasList"></div>
      </div>
    </div>
    
    <div id="calendarVisual"></div>
    
    <!-- Elementos adicionales -->
    <div id="ultimoRespaldo"></div>
    
    <!-- Bot√≥n de modo nocturno flotante mejorado -->
    <button id="toggleDarkMode" onclick="toggleDarkMode()" style="
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    ">üåô</button>
  </div>

  <!-- Modales -->
  <div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button onclick="closeEditModal()">‚úï</button>
      <input type="password" id="editPassword" placeholder="Contrase√±a">
      <button onclick="verifyEditPassword()">Verificar</button>
      <div id="editForm" style="display: none;">
        <!-- Formulario de edici√≥n -->
      </div>
    </div>
  </div>
  
  <div id="editBitacoraModal" class="modal" style="display: none;">
    <div class="modal-content edit-bitacora-content">
      <button onclick="closeEditBitacoraModal()">‚úï</button>
      <input type="text" id="editBitacoraName" placeholder="Nombre">
      <div id="editColorPicker"></div>
      <button onclick="saveBitacoraEdit()">Guardar</button>
    </div>
  </div>
  
  <div id="backupModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button onclick="closeBackupModal()">‚úï</button>
      <div id="backupList"></div>
    </div>
  </div>
  
  <div id="helpModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button onclick="closeHelpModal()">‚úï</button>
      <h3>Ayuda</h3>
      <p>Instrucciones de uso...</p>
    </div>
  </div>

  <!-- Modal de Edici√≥n de Paciente -->
  <div id="editPacienteModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button onclick="closeEditPacienteModal()">‚úï</button>
      <h3>‚úèÔ∏è Editar Paciente</h3>
      
      <div class="form-section">
        <h4>üë§ Datos Personales</h4>
        <input type="text" id="editPacienteNombre" placeholder="Nombre completo" required>
        <input type="text" id="editPacienteDNI" placeholder="DNI" required readonly>
        <input type="text" id="editPacienteDireccion" placeholder="Direcci√≥n">
        <input type="tel" id="editPacienteTelefono" placeholder="N√∫mero de tel√©fono">
        <input type="text" id="editPacienteObraSocial" placeholder="Obra social">
        <textarea id="editPacientePatologia" placeholder="Diagn√≥stico presuntivo / Patolog√≠a"></textarea>
      </div>
      
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button onclick="saveEditPaciente()" class="btn-primary">üíæ Guardar Cambios</button>
        <button onclick="closeEditPacienteModal()" class="btn-secondary">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Recordatorios -->
  <div id="recordatoriosModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button onclick="closeRecordatoriosModal()">‚úï</button>
      <h3>‚è∞ Recordatorios</h3>
      
      <div class="form-section">
        <h4>Nuevo Recordatorio</h4>
        <select id="recordatorioPaciente">
          <option value="">Seleccionar paciente...</option>
        </select>
        <input type="date" id="recordatorioFecha">
        <input type="time" id="recordatorioHora" value="09:00">
        <textarea id="recordatorioNota" placeholder="Nota del recordatorio"></textarea>
        <button onclick="crearRecordatorio()" class="btn-primary">‚ûï Crear Recordatorio</button>
      </div>
      
      <div class="form-section">
        <h4>üìã Recordatorios Pendientes</h4>
        <div id="recordatoriosList"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Informaci√≥n del Software -->
  <div id="softwareInfoModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <button onclick="closeSoftwareInfoModal()">‚úï</button>
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: var(--primary); margin-bottom: 8px;">ü©∫ CLINICAL DATA</h2>
        <p style="color: var(--text-light); font-size: 1.1rem;">Sistema Integral de Gesti√≥n M√©dica</p>
      </div>
      
      <div class="form-section">
        <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">üë®‚Äç‚öïÔ∏è ¬øQu√© puede hacer este software?</h3>
        
        <div style="display: grid; gap: 16px; margin-top: 16px;">
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #4ade80;">
            <h4>üë§ Gesti√≥n Completa de Pacientes</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li>Registro de datos personales completos</li>
              <li>B√∫squeda por nombre, DNI o diagn√≥stico</li>
              <li>Historial m√©dico completo</li>
              <li>Estad√≠sticas autom√°ticas de cada paciente</li>
            </ul>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
            <h4>ü©∫ Sistema de Visitas M√©dicas</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li><strong>Primera Consulta:</strong> Evaluaci√≥n inicial del paciente</li>
              <li><strong>Seguimiento:</strong> Control y evoluci√≥n del tratamiento</li>
              <li><strong>Urgencia:</strong> Atenci√≥n m√©dica urgente</li>
              <li><strong>Control:</strong> Revisiones programadas</li>
            </ul>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #f87171;">
            <h4>üìä An√°lisis y Reportes</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li>Gr√°ficos de evoluci√≥n del estado cl√≠nico</li>
              <li>Estad√≠sticas de visitas y tratamientos</li>
              <li>Exportaci√≥n de historias cl√≠nicas en PDF</li>
              <li>Respaldo de datos en formato JSON</li>
            </ul>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #facc15;">
            <h4>‚è∞ Sistema de Recordatorios</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li>Notificaciones autom√°ticas del navegador</li>
              <li>Recordatorios por paciente</li>
              <li>Clasificaci√≥n por urgencia (urgentes, hoy, pendientes)</li>
              <li>Gesti√≥n completa de tareas m√©dicas</li>
            </ul>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #a78bfa;">
            <h4>üìÖ Calendario de Citas</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li>Vista de calendario mensual interactiva</li>
              <li>Programaci√≥n de citas por paciente</li>
              <li>Indicadores visuales de d√≠as ocupados</li>
              <li>Gesti√≥n completa de agenda m√©dica</li>
            </ul>
          </div>
          
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; border-left: 4px solid #f472b6;">
            <h4>üîê Seguridad y Sincronizaci√≥n</h4>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-light);">
              <li>Autenticaci√≥n segura con Firebase</li>
              <li>Sincronizaci√≥n autom√°tica en la nube</li>
              <li>Datos protegidos por usuario</li>
              <li>Acceso desde cualquier dispositivo</li>
            </ul>
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); padding: 16px; border-radius: 12px; margin-top: 20px; text-align: center; color: white;">
          <h4 style="margin: 0 0 8px 0;">‚ú® Dise√±o Moderno y Responsive</h4>
          <p style="margin: 0; opacity: 0.9;">Interfaz elegante con modo nocturno, efectos glassmorphism y optimizada para m√≥viles</p>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
          <p style="color: var(--text-light); font-size: 0.9rem;">
            üí° <strong>¬øListo para comenzar?</strong><br>
            Crea tu cuenta e inicia la gesti√≥n profesional de tus pacientes
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales del sistema de autenticaci√≥n
    let currentUser = null;
    let isAuthenticated = false;

    // Manejar la instalaci√≥n de la PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Variables globales para sistema m√©dico
    let selectedPaciente = null;
    let selectedVisitType = 'primera';
    let allPacientes = [];
    let allRecordatorios = [];
    let allCitas = [];
    let currentChart = null;

    const visitTypes = [
      { value: 'primera', label: 'Primera Consulta', icon: 'ü©∫', color: '#4ade80' },
      { value: 'seguimiento', label: 'Seguimiento', icon: 'üìã', color: '#0ea5e9' },
      { value: 'urgencia', label: 'Urgencia', icon: 'üö®', color: '#f87171' },
      { value: 'control', label: 'Control', icon: '‚úÖ', color: '#22c55e' }
    ];

    const estadosClinicosColors = {
      'estable': '#22c55e',
      'critico': '#dc2626',
      'observacion': '#facc15',
      'mejoria': '#4ade80',
      'alta': '#6b7280'
    };

    const availableColors = [
      '#4ade80', '#0ea5e9', '#f87171', '#facc15',
      '#a78bfa', '#f472b6', '#60a5fa', '#34d399'
    ];

    // ===== FUNCI√ìN DE GUARDADO AUTOM√ÅTICO =====
    async function autoSave() {
      if (!currentUser || !selectedPaciente) return;
      
      try {
        await savePacienteToFirestore(selectedPaciente);
        console.log('Guardado autom√°tico completado');
      } catch (error) {
        console.error('Error en guardado autom√°tico:', error);
      }
    }

    // ===== SISTEMA DE AUTENTICACI√ìN MEJORADO =====

    // Sistema de autenticaci√≥n robusto con fallbacks
    console.log('üîê Inicializando sistema de autenticaci√≥n...');

    // Variables de autenticaci√≥n
    let authInitialized = false;
    let authRetryCount = 0;
    const MAX_AUTH_RETRIES = 3;

    // Funci√≥n para inicializar autenticaci√≥n con reintentos
    async function initializeAuthWithRetry() {
      if (authInitialized) return;
      
      try {
        console.log(`üîÑ Intento de inicializaci√≥n de auth: ${authRetryCount + 1}/${MAX_AUTH_RETRIES}`);

      if (!window.auth) {
          throw new Error('Firebase Auth no disponible');
        }

        // Configurar listener de estado de autenticaci√≥n
        window.auth.onAuthStateChanged((user) => {
          console.log('üîê Estado de autenticaci√≥n cambi√≥:', !!user);
          
          if (user) {
            console.log('‚úÖ Usuario autenticado exitosamente:', user.email);
            currentUser = user;
            isAuthenticated = true;
            
            // Mostrar interfaz principal
            const authContainer = document.querySelector('.container');
            const mainContent = document.getElementById('mainContent');
            const userInfo = document.getElementById('userInfo');
            
            if (authContainer) authContainer.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            if (userInfo) userInfo.style.display = 'flex';
            
            // Cargar datos del usuario
            loadUserData();
            
          } else {
            console.log('‚ùå Usuario no autenticado');
            currentUser = null;
            isAuthenticated = false;
            
            // Mostrar interfaz de login
            const authContainer = document.querySelector('.container');
            const mainContent = document.getElementById('mainContent');
            const userInfo = document.getElementById('userInfo');
            
            if (authContainer) authContainer.style.display = 'block';
            if (mainContent) mainContent.style.display = 'none';
            if (userInfo) userInfo.style.display = 'none';
            
            // Limpiar datos
            allPacientes = [];
            allRecordatorios = [];
            allCitas = [];
          }
        });

        authInitialized = true;
        console.log('‚úÖ Sistema de autenticaci√≥n inicializado correctamente');
        
      } catch (error) {
        console.error(`‚ùå Error inicializando auth (intento ${authRetryCount + 1}):`, error);
        authRetryCount++;
        
        if (authRetryCount < MAX_AUTH_RETRIES) {
          console.log(`üîÑ Reintentando en 2 segundos...`);
          setTimeout(initializeAuthWithRetry, 2000);
        } else {
          console.error('‚ùå Fall√≥ inicializaci√≥n de auth despu√©s de todos los reintentos');
          alert('‚ùå Error en sistema de autenticaci√≥n. Recarga la p√°gina.');
        }
      }
    }

    // Funci√≥n de bypass temporal para acceso directo
    window.bypassAuth = function() {
      console.log('üö® ACTIVANDO BYPASS DE AUTENTICACI√ìN...');
      
      // Crear usuario mock
      currentUser = {
        uid: 'bypass_user_' + Date.now(),
        email: 'corraljosemaria@hotmail.com',
        displayName: 'Usuario Bypass',
        getIdToken: () => Promise.resolve('bypass_token')
      };
      
      isAuthenticated = true;
      
      console.log('‚úÖ Usuario bypass creado:', currentUser.email);
      
      // Mostrar interfaz principal
      const authContainer = document.querySelector('.container');
      const mainContent = document.getElementById('mainContent');
      const userInfo = document.getElementById('userInfo');
      
      if (authContainer) authContainer.style.display = 'none';
      if (mainContent) mainContent.style.display = 'block';
      if (userInfo) {
        userInfo.style.display = 'flex';
        
        // Actualizar info del usuario
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        if (userName) userName.textContent = 'Usuario Bypass';
        if (userEmail) userEmail.textContent = 'corraljosemaria@hotmail.com';
      }
      
      // Cargar datos locales inmediatamente
      console.log('üì¶ Cargando datos en modo bypass...');
      loadLocalData();
      renderPacienteSelector();
      
      alert('‚úÖ ACCESO DIRECTO ACTIVADO\n\nüì± Ahora puedes usar la aplicaci√≥n normalmente.\nüíæ Los datos se guardan localmente.\nüåê Usa "Sincronizar Datos" para compartir entre dispositivos.');
    };

    // Inicializar autenticaci√≥n cuando Firebase est√© listo
    setTimeout(initializeAuthWithRetry, 1000);
      
      // Funci√≥n de prueba para verificar conectividad
      window.testFirebaseConnection = async function() {
        try {
          console.log('Probando conexi√≥n a Firebase...');
          console.log('Auth domain:', window.auth.app.options.authDomain);
          console.log('Project ID:', window.auth.app.options.projectId);
          return true;
        } catch (error) {
          console.error('Error al probar conexi√≥n:', error);
          return false;
        }
      };
      
      // Funci√≥n de prueba para crear usuario de prueba
      window.testUserCreation = async function() {
        try {
          const testEmail = 'test' + Date.now() + '@test.com';
          const testPassword = 'test123456';
          console.log('Probando creaci√≥n de usuario con:', testEmail);
          
          const userCredential = await window.auth.createUserWithEmailAndPassword(testEmail, testPassword);
          console.log('Usuario de prueba creado exitosamente:', userCredential.user.uid);
          
          // Eliminar usuario de prueba
          await userCredential.user.delete();
          console.log('Usuario de prueba eliminado');
          
          return true;
        } catch (error) {
          console.error('Error en prueba de creaci√≥n:', error);
          return false;
        }
      };

      // Observar cambios en el estado de autenticaci√≥n
      // onAuthStateChanged ya est√° configurado en Firebase v9 module

    // Inicializar cuando la p√°gina est√© cargada
    // Firebase v9 ya est√° inicializado autom√°ticamente

    // Funciones de autenticaci√≥n
    function showAuthContainer() {
      const loginContainer = document.querySelector('.container');
      const mainContent = document.getElementById('mainContent');
      const authContainer = document.getElementById('authContainer');
      
      if (loginContainer) loginContainer.style.display = 'block';
      if (mainContent) mainContent.style.display = 'none';
      if (authContainer) authContainer.style.display = 'none';
    }

    function hideAuthContainer() {
      const loginContainer = document.querySelector('.container');
      const mainContent = document.getElementById('mainContent');
      const authContainer = document.getElementById('authContainer');
      
      if (loginContainer) loginContainer.style.display = 'none';
      if (mainContent) mainContent.style.display = 'block';
      if (authContainer) authContainer.style.display = 'block';
    }

    function showUserInfo(user) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');

      if (!userInfo) return;

      // Mostrar informaci√≥n del usuario
      userInfo.style.display = 'flex';
      
      // Avatar con iniciales
      const displayName = user.displayName || user.email.split('@')[0];
      if (userAvatar) userAvatar.textContent = displayName.charAt(0).toUpperCase();
      
      // Nombre y email
      if (userName) userName.textContent = displayName;
      if (userEmail) userEmail.textContent = user.email;
    }

    function hideUserInfo() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
    }

    function showLogin() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('registerCard').style.display = 'none';
      clearAuthErrors();
    }

    function showRegister() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
      clearAuthErrors();
    }

    function clearAuthErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }

    // Login
    document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const userInput = document.getElementById('loginEmail');
      const passInput = document.getElementById('loginPassword');
      const loginError = document.getElementById('loginError');
      
      if (!userInput || !passInput) {
        console.error('Elementos de login no encontrados');
        return;
      }
      
      const email = userInput.value?.trim();
      const password = passInput.value;

      // Limpiar errores previos
      if (loginError) loginError.style.display = 'none';
      const loginConfigHelp = document.getElementById('loginConfigHelp');
      if (loginConfigHelp) loginConfigHelp.style.display = 'none';

      // Validaciones b√°sicas
      if (!email) {
        if (loginError) {
          loginError.textContent = 'Por favor ingresa tu email';
          loginError.style.display = 'block';
        }
        return;
      }

      if (!password) {
        if (loginError) {
          loginError.textContent = 'Por favor ingresa tu contrase√±a';
          loginError.style.display = 'block';
        }
        return;
      }

      try {
        console.log('Intentando iniciar sesi√≥n con:', email);
        await window.signInWithEmailAndPassword(window.auth, email, password);
        console.log('Login exitoso');
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de login:', error);
        
        const loginConfigHelp = document.getElementById('loginConfigHelp');
        
        // Mostrar ayuda espec√≠fica para error de configuraci√≥n
        if (error.message && error.message.includes('CONFIGURATION_NOT_FOUND')) {
          if (loginConfigHelp) loginConfigHelp.style.display = 'block';
          if (loginError) loginError.style.display = 'none';
        } else {
          if (loginConfigHelp) loginConfigHelp.style.display = 'none';
          if (loginError) {
            loginError.textContent = getErrorMessage(error);
            loginError.style.display = 'block';
          }
        }
      }
    });

    // Registro
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('registerName').value?.trim();
      const email = document.getElementById('registerEmail').value?.trim();
      const password = document.getElementById('registerPassword').value;
      const registerError = document.getElementById('registerError');

      // Limpiar errores previos
      if (registerError) registerError.style.display = 'none';
      const firebaseConfigHelp = document.getElementById('firebaseConfigHelp');
      if (firebaseConfigHelp) firebaseConfigHelp.style.display = 'none';

      // Validaciones b√°sicas
      if (!name) {
        if (registerError) {
          registerError.textContent = 'Por favor ingresa tu nombre completo';
          registerError.style.display = 'block';
        }
        return;
      }

      if (!email) {
        if (registerError) {
          registerError.textContent = 'Por favor ingresa un email v√°lido';
          registerError.style.display = 'block';
        }
        return;
      }

      if (!password || password.length < 6) {
        if (registerError) {
          registerError.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
          registerError.style.display = 'block';
        }
        return;
      }

      try {
        console.log('Intentando crear usuario con:', { email, password: '***', name });
        
        // Crear usuario
        const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
        console.log('Usuario creado exitosamente:', userCredential.user.uid);
        
        // Actualizar perfil
        await userCredential.user.updateProfile({
          displayName: name
        });
        console.log('Perfil actualizado exitosamente');

        // Crear documento de usuario en Firestore
        try {
          await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('Documento de usuario creado en Firestore');
        } catch (firestoreError) {
          console.warn('Error al crear documento en Firestore (no cr√≠tico):', firestoreError);
        }

        // Migrar datos locales si existen
        try {
          await migrateLocalData(userCredential.user.uid);
        } catch (migrationError) {
          console.warn('Error en migraci√≥n de datos (no cr√≠tico):', migrationError);
        }

        console.log('Registro completado exitosamente');

      } catch (error) {
        console.error('Error de registro:', error);
        
        const firebaseConfigHelp = document.getElementById('firebaseConfigHelp');
        
        // Mostrar ayuda espec√≠fica para error de configuraci√≥n
        if (error.message && error.message.includes('CONFIGURATION_NOT_FOUND')) {
          if (firebaseConfigHelp) firebaseConfigHelp.style.display = 'block';
          if (registerError) registerError.style.display = 'none';
        } else {
          if (firebaseConfigHelp) firebaseConfigHelp.style.display = 'none';
          if (registerError) {
            registerError.textContent = getErrorMessage(error);
            registerError.style.display = 'block';
          }
        }
      }
    });

    // Logout
    async function logout() {
      try {
        await window.signOut(window.auth);
        // El onAuthStateChanged se encargar√° del resto
      } catch (error) {
        console.error('Error de logout:', error);
        alert('Error al cerrar sesi√≥n');
      }
    }

    // Obtener mensaje de error amigable
    function getErrorMessage(error) {
      // Si es un objeto error completo
      if (typeof error === 'object' && error.code) {
        const errorMessages = {
          'auth/user-not-found': 'No existe una cuenta con este email',
          'auth/wrong-password': 'Contrase√±a incorrecta',
          'auth/email-already-in-use': 'Este email ya est√° registrado',
          'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
          'auth/invalid-email': 'Email inv√°lido',
          'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde',
          'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet',
          'auth/user-disabled': 'Esta cuenta ha sido deshabilitada',
          'auth/operation-not-allowed': 'Operaci√≥n no permitida',
          'auth/requires-recent-login': 'Necesitas volver a iniciar sesi√≥n',
          'auth/invalid-credential': 'Credenciales inv√°lidas',
          'auth/internal-error': 'Error de configuraci√≥n de Firebase - Contacta al administrador',
          'auth/configuration-not-found': 'Firebase Authentication no est√° configurado correctamente'
        };
        // Chequeo espec√≠fico para CONFIGURATION_NOT_FOUND
        if (error.message && error.message.includes('CONFIGURATION_NOT_FOUND')) {
          return 'Firebase Authentication no est√° habilitado. Ve a Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Habilita Email/Password';
        }
        
        return errorMessages[error.code] || `Error: ${error.message || error.code}`;
      }
      
              // Si es solo un c√≥digo string
        if (typeof error === 'string') {
          // Chequeo espec√≠fico para CONFIGURATION_NOT_FOUND
          if (error.includes('CONFIGURATION_NOT_FOUND')) {
            return 'Firebase Authentication no est√° habilitado. Ve a Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Habilita Email/Password';
          }
          
          const errorMessages = {
            'auth/user-not-found': 'No existe una cuenta con este email',
            'auth/wrong-password': 'Contrase√±a incorrecta',
            'auth/email-already-in-use': 'Este email ya est√° registrado',
            'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
            'auth/invalid-email': 'Email inv√°lido',
            'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde',
            'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet'
          };
          return errorMessages[error] || `Error: ${error}`;
        }
      
      return 'Error desconocido. Verifica tu conexi√≥n e intenta de nuevo';
    }

    // ===== GESTI√ìN DE DATOS CON FIRESTORE =====

    // Cargar datos del usuario
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
          // Actualizar √∫ltimo login
          await db.collection('users').doc(currentUser.uid).update({
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Cargar bit√°coras del usuario
        await loadUserBitacoras();
        
      } catch (error) {
        console.error('Error al cargar datos del usuario:', error);
      }
    }

    // Cargar bit√°coras del usuario
    async function loadUserBitacoras() {
      if (!currentUser) return;

      try {
        const bitacorasSnapshot = await db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').get();

        const bitacoras = [];
        bitacorasSnapshot.forEach(doc => {
          bitacoras.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Guardar en localStorage para compatibilidad
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        // Renderizar selector de bit√°coras
        renderBitacoraSelector();
        
        // Seleccionar primera bit√°cora si existe
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          // Solo mostrar formulario si el elemento existe
          if (document.getElementById('newBitacoraForm')) {
            showNewBitacoraForm();
          }
        }

      } catch (error) {
        console.error('Error al cargar bit√°coras:', error);
      }
    }

    // Guardar bit√°cora en Firestore
    async function saveBitacoraToFirestore(bitacora) {
      if (!currentUser) return;

      try {
        const bitacoraRef = db.collection('users').doc(currentUser.uid)
          .collection('bitacoras').doc(bitacora.id);
        
        await bitacoraRef.set({
          ...bitacora,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('Bit√°cora guardada en Firestore');
      } catch (error) {
        console.error('Error al guardar bit√°cora:', error);
        throw error;
      }
    }

    // Migrar datos locales a Firestore
    async function migrateLocalData(userId) {
      try {
        const localBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        
        if (localBitacoras.length > 0) {
          const batch = db.batch();
          
          for (const bitacora of localBitacoras) {
            const bitacoraRef = db.collection('users').doc(userId)
              .collection('bitacoras').doc(bitacora.id);
            
            batch.set(bitacoraRef, {
              ...bitacora,
              migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          await batch.commit();
          console.log('Datos migrados exitosamente');
        }
      } catch (error) {
        console.error('Error al migrar datos:', error);
      }
    }

    // Limpiar datos del usuario
    function clearUserData() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
      localStorage.removeItem('bitacoras');
      localStorage.removeItem('bitacora_backups');
      selectedBitacora = null;
      
      const mainContent = document.getElementById('mainContent');
      if (mainContent) mainContent.style.display = 'none';
      
      const bitacoraSelector = document.getElementById('bitacoraSelector');
      if (bitacoraSelector) bitacoraSelector.innerHTML = '';
    }

    // ===== FUNCIONES MODIFICADAS PARA FIRESTORE =====

    // Modificar createNewBitacora para usar Firestore
    async function createNewBitacora() {
      if (!currentUser) {
        alert('Debes iniciar sesi√≥n para crear una bit√°cora');
        return;
      }

      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      
      // Verificar si ya existe una bit√°cora con ese nombre
      const existingBitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      if (existingBitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar caracter√≠sticas (c√≥digo existente)
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar carpas con metros cuadrados
      const carpas = [];
      document.querySelectorAll('#carpasList .carpa-item input[type="number"]').forEach(input => {
        if (input.value) {
          carpas.push({ metrosCuadrados: parseFloat(input.value) });
        }
      });
      
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        userId: currentUser.uid,
        // Caracter√≠sticas de la bit√°cora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        carpas: carpas,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        extractores: [...extractores],
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        },
        createdAt: new Date().toISOString()
      };

      try {
        // Guardar en Firestore
        await saveBitacoraToFirestore(newBitacora);
        
        // Actualizar localStorage
        existingBitacoras.push(newBitacora);
        localStorage.setItem('bitacoras', JSON.stringify(existingBitacoras));
        
        // Limpiar formulario
        const nameInput = document.getElementById('newBitacoraName');
        if (nameInput) nameInput.value = '';
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        const formElement = document.getElementById('newBitacoraForm');
        if (formElement) formElement.classList.remove('active');
        
        // Limpiar variables globales
        cepas = [];
        extractores = [];
        luces = [];
        tipoLuz = '';
        
        // Actualizar UI
        renderBitacoraSelector();
        selectBitacora(newBitacora.id);
        
      } catch (error) {
        console.error('Error al crear bit√°cora:', error);
        alert('Error al crear la bit√°cora. Intenta de nuevo.');
      }
    }

    // Modificar saveEntry para usar Firestore
    async function saveEntry() {
      if (!selectedBitacora || !currentUser) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Eleg√≠ fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value,
        createdAt: new Date().toISOString()
      };

      try {
        // Actualizar en localStorage
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        
        if (bitacoraIndex !== -1) {
          let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
          entries.push(entry);
          bitacoras[bitacoraIndex].entries[selectedStage] = entries;
          
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          selectedBitacora = bitacoras[bitacoraIndex];
          
          // Guardar en Firestore
          await saveBitacoraToFirestore(selectedBitacora);
          
          // Actualizar UI
          renderHistory();
          renderCalendar();
          updateWeeklySummary();
        }
      } catch (error) {
        console.error('Error al guardar entrada:', error);
        alert('Error al guardar la entrada. Intenta de nuevo.');
      }
    }

    // Funciones auxiliares
    function getEntries() {
      if (!selectedBitacora) return [];
      return selectedBitacora.entries[selectedStage] || [];
    }

    function updateWeeklySummary() {
      if (!selectedBitacora) return;

      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());

      const weekEntries = getEntries().filter(entry => {
        const entryDate = new Date(entry.date);
        return entryDate >= weekStart && entryDate <= today;
      });

      const totalEntriesEl = document.getElementById('totalEntries');
      if (totalEntriesEl) totalEntriesEl.textContent = weekEntries.length;
      
      const moods = weekEntries.map(e => e.mood).filter(m => m);
      const avgMood = moods.length ? (moods.reduce((a, b) => a + b, 0) / moods.length).toFixed(1) : '-';
      const avgMoodEl = document.getElementById('averageMood');
      if (avgMoodEl) avgMoodEl.textContent = avgMood;
      
      const wateredDays = weekEntries.filter(e => e.didWater).length;
      const wateredDaysEl = document.getElementById('wateredDays');
      if (wateredDaysEl) wateredDaysEl.textContent = wateredDays;

      const timeline = document.getElementById('emotionTimeline');
      if (timeline) {
        timeline.innerHTML = weekEntries.map(entry => `
          <div class="emotion-dot" style="background-color: ${moodStates.find(m => m.value === entry.mood)?.color}"
               title="${entry.date}"></div>
        `).join('');
      }
    }

    function renderHistory() {
      const entries = getEntries().sort((a,b) => new Date(b.date) - new Date(a.date));
      const container = document.getElementById('history');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '';
      const floraStart = selectedBitacora?.floraStart;

      entries.forEach(e => {
        let diaFlora = '';
        if (selectedStage === 'flora' && floraStart) {
          const start = new Date(floraStart);
          const actual = new Date(e.date);
          const diff = Math.floor((actual - start) / (1000 * 60 * 60 * 24)) + 1;
          diaFlora = ` ‚Äî D√≠a ${diff} de flora`;
        }

        const moodEmoji = moodStates.find(m => m.value === e.mood)?.icon || '';
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <button class="edit-button" onclick="editEntry('${e.date}')">‚úèÔ∏è</button>
          <strong>${e.date}</strong> ‚Äî ${moodEmoji} ${diaFlora}<br/>
          <b>Tareas:</b> ${e.tasks}<br/>
          <b>Riego:</b> ${e.didWater ? 'S√≠' : 'No'} ${e.didWater ? `
            <br/>üíß ${e.waterAmount} | üß¥ ${e.nutrients} | ‚öóÔ∏è pH: ${e.ph} | üìà EC: ${e.ec}` : ''}
          <br/><b>Problemas:</b> ${e.issues}
          <br/><b>Notas:</b> ${e.notes}`;
        container.appendChild(div);
      });
    }

    function renderCalendar() {
      const entries = getEntries();
      const map = {};
      entries.forEach(e => { map[e.date] = e.mood; });

      const container = document.getElementById('calendarVisual');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '<div class="calendar">';
      for (let i = 34; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const k = d.toISOString().split('T')[0];
        const mood = map[k];
        const cls = mood ? 'm' + mood : '';
        container.innerHTML += `<div class="day ${cls}" title="${k}"></div>`;
      }
      container.innerHTML += '</div>';
    }

    // Funciones de gesti√≥n de bit√°coras
    function createNewBitacora() {
      const name = document.getElementById('newBitacoraName').value.trim();
      const selectedColor = document.querySelector('.color-option.selected');
      
      if (!name) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }

      const color = selectedColor.style.backgroundColor;
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      
      if (bitacoras.some(b => b.name.toLowerCase() === name.toLowerCase())) {
        alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
        return;
      }

      // Recopilar todas las caracter√≠sticas de la bit√°cora
      const tipoCultivo = document.getElementById('tipoCultivo').value;
      const numCarpas = parseInt(document.getElementById('numCarpas').value) || 0;
      const soloSala = document.getElementById('soloSala').checked;
      const lamparasVege = parseInt(document.getElementById('lamparasVege').value) || 0;
      const wattsVege = document.getElementById('wattsVege').value;
      const lamparasFlora = parseInt(document.getElementById('lamparasFlora').value) || 0;
      const wattsFlora = document.getElementById('wattsFlora').value;
      const ventiladores = parseInt(document.getElementById('ventiladores').value) || 0;
      const pulgadasVentilador = document.getElementById('pulgadasVentilador').value;
      const filtroAire = document.getElementById('filtroAire').value;
      const aireAcondicionado = document.getElementById('aireAcondicionado').value;
      const frigorias = document.getElementById('frigorias').value;
      
      // Recopilar tipo de riego
      const riegoOptions = [];
      document.querySelectorAll('#riegoOptions input[type=checkbox]:checked').forEach(cb => {
        riegoOptions.push(cb.value);
      });
      const detalleRiego = document.getElementById('detalleRiego').value;
      const sustrato = document.getElementById('sustrato').value;

      const newBitacora = {
        id: Date.now().toString(),
        name,
        color,
        floraStart: null,
        isPublic: true,
        // Caracter√≠sticas de la bit√°cora
        cepas: [...cepas],
        tipoCultivo,
        numCarpas,
        soloSala,
        lamparasVege,
        wattsVege,
        lamparasFlora,
        wattsFlora,
        ventiladores,
        pulgadasVentilador,
        filtroAire,
        aireAcondicionado,
        frigorias,
        riegoOptions,
        detalleRiego,
        sustrato,
        tipoLuz,
        luces: [...luces],
        entries: {
          vege: [],
          flora: [],
          general: []
        }
      };

      bitacoras.push(newBitacora);
      localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
      
      const nameInput = document.getElementById('newBitacoraName');
      if (nameInput) nameInput.value = '';
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      const formElement = document.getElementById('newBitacoraForm');
      if (formElement) formElement.classList.remove('active');
      
      renderBitacoraSelector();
      selectBitacora(newBitacora.id);
    }

    function renderBitacoraSelector() {
      const container = document.getElementById('bitacoraSelector');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      container.innerHTML = '';
      
      const newButton = document.createElement('button');
      newButton.className = 'bitacora-card';
      newButton.style.backgroundColor = '#e5e7eb';
      newButton.style.color = '#374151';
      newButton.innerHTML = '+ Nueva Bit√°cora';
      newButton.id = 'btnNuevaBitacora';
      newButton.onclick = toggleNewBitacoraForm;
      container.appendChild(newButton);
      
      bitacoras.forEach(bitacora => {
        const div = document.createElement('div');
        div.className = `bitacora-card ${bitacora.id === selectedBitacora?.id ? 'active' : ''}`;
        div.style.backgroundColor = bitacora.color;
        div.style.color = '#fff';
        
        // Contenedor para el nombre y estado de visibilidad
        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `
          ${bitacora.name}
          <span class="visibility-indicator" title="${bitacora.isPublic ? 'P√∫blica: Cualquiera con el enlace puede ver y compartir esta bit√°cora.' : 'Privada: Solo t√∫ puedes ver esta bit√°cora.'}">
            ${bitacora.isPublic ? 'üåê' : 'üîí'}
          </span>
        `;
        div.appendChild(nameDiv);
        
        // Contenedor para los botones de acci√≥n
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'bitacora-actions';
        
        // Bot√≥n de editar
        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditBitacoraModal(bitacora);
        };
        
        // Bot√≥n de eliminar
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-btn delete-btn';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm('¬øEst√°s seguro de que quieres eliminar esta bit√°cora?')) {
            deleteBitacora(bitacora.id);
          }
        };
        
        // Bot√≥n de compartir
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share-btn';
        shareBtn.innerHTML = 'üì§';
        shareBtn.onclick = (e) => {
          e.stopPropagation();
          if (!bitacora.isPublic) {
            alert('Esta bit√°cora es privada. C√°mbiala a p√∫blica para poder compartirla.');
            return;
          }
          shareBitacora(bitacora);
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        actionsDiv.appendChild(shareBtn);
        div.appendChild(actionsDiv);
        
        div.onclick = () => selectBitacora(bitacora.id);
        container.appendChild(div);
      });
    }

    function showNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      if (!form) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      form.classList.add('active');
      const nameInput = document.getElementById('newBitacoraName');
      if (nameInput) nameInput.value = '';
      renderColorPicker();
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      
      // Limpiar cepas
      cepas = [];
      renderCepasList();
      const cepaNombre = document.getElementById('cepaNombre');
      if (cepaNombre) cepaNombre.value = '';
      const cepaCantidad = document.getElementById('cepaCantidad');
      if (cepaCantidad) cepaCantidad.value = 1;
      const cepaTipo = document.getElementById('cepaTipo');
      if (cepaTipo) cepaTipo.value = 'clon';
      const cepaGerminacion = document.getElementById('cepaGerminacion');
      if (cepaGerminacion) cepaGerminacion.value = '';
      const semillaFields = document.getElementById('semillaFields');
      if (semillaFields) semillaFields.style.display = 'none';
      
      // Limpiar tipo de cultivo
      document.getElementById('tipoCultivo').value = '';
      document.getElementById('interiorFields').style.display = 'none';
      document.getElementById('numCarpas').value = 0;
      document.getElementById('soloSala').checked = false;
      document.getElementById('carpasList').innerHTML = '';
      
      // Limpiar equipamiento interior
      document.getElementById('lamparasVege').value = 0;
      document.getElementById('wattsVege').value = '';
      document.getElementById('lamparasFlora').value = 0;
      document.getElementById('wattsFlora').value = '';
      document.getElementById('ventiladores').value = 0;
      document.getElementById('pulgadasVentilador').value = '';
      
      // Limpiar extractores
      extractores = [];
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      
      document.getElementById('filtroAire').value = 'no';
      document.getElementById('aireAcondicionado').value = 'no';
      document.getElementById('frigorias').value = '';
      document.getElementById('frigorias').style.display = 'none';
      
      // Limpiar riego
      document.querySelectorAll('#riegoOptions input[type=checkbox]').forEach(cb => cb.checked = false);
      document.getElementById('detalleRiego').value = '';
      document.getElementById('sustrato').value = '';
      
      // Limpiar luces
      tipoLuz = '';
      luces = [];
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
    }

    function renderColorPicker() {
      const colorPicker = document.getElementById('colorPicker');
      if (!colorPicker) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option" style="background-color: ${color}" onclick="selectColor(this)"></div>
      `).join('');
    }

    function selectColor(element) {
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
    }

    let cepas = [];
    function addCepa() {
      const nombre = document.getElementById('cepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('cepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('cepaTipo').value;
      const germinacion = document.getElementById('cepaGerminacion').value;
      
      if (!nombre) return;
      
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      
      cepas.push(cepa);
      renderCepasList();
      document.getElementById('cepaNombre').value = '';
      document.getElementById('cepaCantidad').value = 1;
      document.getElementById('cepaTipo').value = 'clon';
      document.getElementById('cepaGerminacion').value = '';
      document.getElementById('semillaFields').style.display = 'none';
      document.getElementById('cepaNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function removeCepa(index) {
      cepas.splice(index, 1);
      renderCepasList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.cepas = [...cepas];
        autoSave();
      }
    }
    
    function renderCepasList() {
      const list = document.getElementById('cepasList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      cepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo})`;
        if (cepa.germinacion) {
          info += ` - Germinaci√≥n: ${cepa.germinacion}`;
        }
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Funciones para extractores
    function addExtractor() {
      const cantidad = parseInt(document.getElementById('extractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('extractorPulgadas').value.trim();
      
      if (!pulgadas) return;
      
      extractores.push({ cantidad, pulgadas });
      renderExtractoresList();
      document.getElementById('extractorCantidad').value = 1;
      document.getElementById('extractorPulgadas').value = '';
      document.getElementById('extractorPulgadas').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function removeExtractor(index) {
      extractores.splice(index, 1);
      renderExtractoresList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.extractores = [...extractores];
        autoSave();
      }
    }
    
    function renderExtractoresList() {
      const list = document.getElementById('extractoresList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      extractores.forEach((extractor, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${extractor.cantidad} de ${extractor.pulgadas}"</span> <button class='extractor-remove' onclick='removeExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function selectBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      selectedBitacora = bitacoras.find(b => b.id === id);
      
      if (selectedBitacora) {
        document.getElementById('mainContent').style.display = 'block';
        renderBitacoraSelector();
        setStage('vege');
        renderMoodButtons();
        renderHistory();
        renderCalendar();
        updateWeeklySummary();
      }
    }

    // Funciones de estado y renderizado
    function setStage(stage) {
      selectedStage = stage;
      document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('stage-selected'));
      document.getElementById('btn-' + stage).classList.add('stage-selected');
      
      
      // Mostrar/ocultar elementos seg√∫n la etapa
      const floraStartContainer = document.getElementById('floraStartContainer');
      const bitacoraInfo = document.getElementById('bitacoraInfo');
      const entryForm = document.getElementById('entryForm');
      
      floraStartContainer.style.display = stage === 'flora' ? 'block' : 'none';
      
      if (stage === 'general') {
        bitacoraInfo.style.display = 'block';
        if (entryForm) entryForm.style.display = 'none';
        renderBitacoraInfo();
      } else {
        bitacoraInfo.style.display = 'none';
        if (entryForm) entryForm.style.display = 'block';
      }
      
      renderHistory();
      renderCalendar();
      updateWeeklySummary();
    }

    function setMood(m) {
      selectedMood = m;
      renderMoodButtons();
    }

    function renderMoodButtons() {
      const div = document.getElementById('moodOptions');
      if (!div) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      div.innerHTML = '';
      moodStates.forEach(state => {
        const span = document.createElement('span');
        span.className = 'mood-btn' + (selectedMood === state.value ? ' mood-selected' : '');
        span.innerText = `${state.icon} ${state.label}`;
        span.onclick = () => setMood(state.value);
        div.appendChild(span);
      });
    }

    function setWater(val) {
      didWater = val;
      document.getElementById('waterDetails').style.display = val ? 'block' : 'none';
    }

    function setFloraStart() {
      if (selectedBitacora) {
        selectedBitacora.floraStart = document.getElementById('floraStart').value;
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        const index = bitacoras.findIndex(b => b.id === selectedBitacora.id);
        if (index !== -1) {
          bitacoras[index] = selectedBitacora;
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        }
      }
    }

    function saveEntry() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }

      const date = document.getElementById('date').value;
      if (!date || !selectedMood) {
        alert('Eleg√≠ fecha y estado emocional.');
        return;
      }

      const entry = {
        date,
        mood: selectedMood,
        tasks: document.getElementById('tasks').value,
        issues: document.getElementById('issues').value,
        notes: document.getElementById('notes').value,
        didWater,
        waterAmount: document.getElementById('waterAmount').value,
        nutrients: document.getElementById('nutrients').value,
        ph: document.getElementById('ph').value,
        ec: document.getElementById('ec').value
      };

      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const bitacoraIndex = bitacoras.findIndex(b => b.id === selectedBitacora.id);
      
      if (bitacoraIndex !== -1) {
        let entries = bitacoras[bitacoraIndex].entries[selectedStage].filter(e => e.date !== date);
      entries.push(entry);
        bitacoras[bitacoraIndex].entries[selectedStage] = entries;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        selectedBitacora = bitacoras[bitacoraIndex];
        
      renderHistory();
      renderCalendar();
        updateWeeklySummary();
      }
    }

    function editEntry(date) {
      const modal = document.getElementById('editModal');
      modal.style.display = 'block';
      
      document.getElementById('editPassword').value = '';
      document.getElementById('editForm').style.display = 'none';
    }

    function verifyEditPassword() {
      const password = document.getElementById('editPassword').value;
      if (password === 'FUCK I MISS') {
        document.getElementById('editForm').style.display = 'block';
        // Aqu√≠ cargar√≠amos los datos de la entrada para editar
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function exportData() {
      if (!selectedBitacora) {
        alert('Por favor, selecciona una bit√°cora primero.');
        return;
      }
      
      const data = {
        bitacora: selectedBitacora,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bitacora_${selectedBitacora.name}_export.json`;
      a.click();
    }

    function showEditBitacoraModal(bitacora) {
      const modal = document.getElementById('editBitacoraModal');
      const nameInput = document.getElementById('editBitacoraName');
      const colorPicker = document.getElementById('editColorPicker');
      
      nameInput.value = bitacora.name;
      colorPicker.innerHTML = availableColors.map(color => `
        <div class="color-option ${color === bitacora.color ? 'selected' : ''}" 
             style="background-color: ${color}" 
             onclick="selectEditColor(this)"></div>
      `).join('');

      // Agregar el selector de visibilidad
      const visibilityDiv = document.createElement('div');
      visibilityDiv.className = 'visibility-selector';
      visibilityDiv.innerHTML = `
        <label>Visibilidad:</label>
        <select id="editBitacoraVisibility">
          <option value="false" ${!bitacora.isPublic ? 'selected' : ''}>Privada</option>
          <option value="true" ${bitacora.isPublic ? 'selected' : ''}>P√∫blica</option>
        </select>
      `;
      modal.querySelector('.edit-bitacora-content').insertBefore(
        visibilityDiv,
        modal.querySelector('.edit-bitacora-content button')
      );
      
      modal.dataset.bitacoraId = bitacora.id;
      modal.style.display = 'block';
    }

    function closeEditBitacoraModal() {
      document.getElementById('editBitacoraModal').style.display = 'none';
    }

    function selectEditColor(element) {
      document.querySelectorAll('#editColorPicker .color-option').forEach(opt => 
        opt.classList.remove('selected')
      );
      element.classList.add('selected');
    }

    function saveBitacoraEdit() {
      const modal = document.getElementById('editBitacoraModal');
      const bitacoraId = modal.dataset.bitacoraId;
      const newName = document.getElementById('editBitacoraName').value.trim();
      const selectedColor = document.querySelector('#editColorPicker .color-option.selected');
      const isPublic = document.getElementById('editBitacoraVisibility').value === 'true';
      
      if (!newName) {
        alert('Por favor, ingresa un nombre para la bit√°cora.');
        return;
      }
      
      if (!selectedColor) {
        alert('Por favor, selecciona un color para la bit√°cora.');
        return;
      }
      
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const index = bitacoras.findIndex(b => b.id === bitacoraId);
      
      if (index !== -1) {
        // Verificar si el nuevo nombre ya existe
        if (bitacoras.some(b => b.id !== bitacoraId && b.name.toLowerCase() === newName.toLowerCase())) {
          alert('Ya existe una bit√°cora con ese nombre. Por favor, elige otro.');
          return;
        }
        
        bitacoras[index].name = newName;
        bitacoras[index].color = selectedColor.style.backgroundColor;
        bitacoras[index].isPublic = isPublic;
        
        localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
        
        if (selectedBitacora?.id === bitacoraId) {
          selectedBitacora = bitacoras[index];
        }
        
        renderBitacoraSelector();
        closeEditBitacoraModal();
      }
    }

    function deleteBitacora(id) {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const newBitacoras = bitacoras.filter(b => b.id !== id);
      
      localStorage.setItem('bitacoras', JSON.stringify(newBitacoras));
      
      if (selectedBitacora?.id === id) {
        selectedBitacora = null;
        document.getElementById('mainContent').style.display = 'none';
      }
      
      renderBitacoraSelector();
    }

    function shareBitacora(bitacora) {
      // Crear un objeto con los datos necesarios para compartir
      const shareData = {
        id: bitacora.id,
        name: bitacora.name,
        entries: bitacora.entries
      };
      
      // Convertir a base64 para el link
      const encodedData = btoa(JSON.stringify(shareData));
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
      
      // Crear el mensaje para WhatsApp
      const message = `¬°Mira mi bit√°cora "${bitacora.name}"!\n${shareUrl}`;
      
      // Abrir WhatsApp con el mensaje
      window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    // Inicializaci√≥n
    (function init() {
      renderBitacoraSelector();
      
      // Verificar si hay un link compartido
      const urlParams = new URLSearchParams(window.location.search);
      const sharedData = urlParams.get('share');
      
      if (sharedData) {
        try {
          const decodedData = JSON.parse(atob(sharedData));
          // Crear una nueva bit√°cora con los datos compartidos
          const newBitacora = {
            id: Date.now().toString(),
            name: `${decodedData.name} (Compartida)`,
            color: availableColors[Math.floor(Math.random() * availableColors.length)],
            floraStart: null,
            isPublic: true,
            entries: decodedData.entries
          };
          
          const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
          bitacoras.push(newBitacora);
          localStorage.setItem('bitacoras', JSON.stringify(bitacoras));
          
          // Limpiar la URL
          window.history.replaceState({}, document.title, window.location.pathname);
          
          // Seleccionar la nueva bit√°cora
          selectBitacora(newBitacora.id);
        } catch (error) {
          console.error('Error al procesar datos compartidos:', error);
        }
      } else {
        const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
        if (bitacoras.length > 0) {
          selectBitacora(bitacoras[0].id);
        } else {
          showNewBitacoraForm();
        }
      }
    })();

    // Funciones de respaldo
    function createBackup() {
      const bitacoras = JSON.parse(localStorage.getItem('bitacoras') || '[]');
      const backup = {
        timestamp: new Date().toISOString(),
        data: bitacoras
      };
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.unshift(backup);
      
      // Mantener solo los √∫ltimos 10 respaldos
      if (backups.length > 10) {
        backups.pop();
      }
      
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      alert('Respaldo creado exitosamente');
    }

    function showBackups() {
      const modal = document.getElementById('backupModal');
      const backupList = document.getElementById('backupList');
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      
      backupList.innerHTML = backups.map((backup, index) => {
        const date = new Date(backup.timestamp);
        const formattedDate = date.toLocaleString();
        const bitacoraCount = backup.data.length;
        
        return `
          <div class="backup-item">
            <div class="backup-info">
              <div>${formattedDate}</div>
              <div>${bitacoraCount} bit√°cora${bitacoraCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="backup-actions">
              <button class="restore" onclick="restoreBackup(${index})">Restaurar</button>
              <button class="delete" onclick="deleteBackup(${index})">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
      
      modal.style.display = 'block';
    }

    function closeBackupModal() {
      document.getElementById('backupModal').style.display = 'none';
    }

    function restoreBackup(index) {
      if (!confirm('¬øEst√°s seguro de que quieres restaurar este respaldo? Se perder√°n los cambios no guardados.')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      const backup = backups[index];
      
      if (backup) {
        localStorage.setItem('bitacoras', JSON.stringify(backup.data));
        selectedBitacora = null;
        renderBitacoraSelector();
        closeBackupModal();
        
        // Seleccionar la primera bit√°cora si existe
        if (backup.data.length > 0) {
          selectBitacora(backup.data[0].id);
        } else {
          // Solo mostrar formulario si el elemento existe
          if (document.getElementById('newBitacoraForm')) {
            showNewBitacoraForm();
          }
        }
        
        alert('Respaldo restaurado exitosamente');
      }
    }

    function deleteBackup(index) {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar este respaldo?')) {
        return;
      }
      
      const backups = JSON.parse(localStorage.getItem('bitacora_backups') || '[]');
      backups.splice(index, 1);
      localStorage.setItem('bitacora_backups', JSON.stringify(backups));
      
      showBackups(); // Actualizar la lista
    }

    function showHelpModal() {
      document.getElementById('helpModal').style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    // L√≥gica para tipo de luz
    function selectLuz(tipo) {
      tipoLuz = tipo;
      document.getElementById('luzSolBtn').classList.remove('selected');
      document.getElementById('luzArtificialBtn').classList.remove('selected');
      document.getElementById('luzMixtoBtn').classList.remove('selected');
      document.getElementById('luzSolIcon').style.display = 'none';
      document.getElementById('luzArtificialFields').style.display = 'none';
      if (tipo === 'sol') {
        document.getElementById('luzSolBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
      } else if (tipo === 'luz') {
        document.getElementById('luzArtificialBtn').classList.add('selected');
        document.getElementById('luzArtificialFields').style.display = 'block';
      } else if (tipo === 'mixto') {
        document.getElementById('luzMixtoBtn').classList.add('selected');
        document.getElementById('luzSolIcon').style.display = 'block';
        document.getElementById('luzArtificialFields').style.display = 'block';
      }
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.tipoLuz = tipoLuz;
        autoSave();
      }
    }

    // Funci√≥n para mostrar/ocultar campo de germinaci√≥n
    function toggleGerminacionField() {
      const tipo = document.getElementById('cepaTipo').value;
      const semillaFields = document.getElementById('semillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }

    function addLuz() {
      const nombre = document.getElementById('luzNombre').value.trim();
      const cantidad = parseInt(document.getElementById('luzCantidad').value, 10) || 1;
      const watts = parseInt(document.getElementById('luzWatts').value, 10) || 0;
      if (!nombre || !watts) return;
      luces.push({ nombre, cantidad, watts });
      renderLucesList();
      document.getElementById('luzNombre').value = '';
      document.getElementById('luzCantidad').value = 1;
      document.getElementById('luzWatts').value = '';
      document.getElementById('luzNombre').focus();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function removeLuz(index) {
      luces.splice(index, 1);
      renderLucesList();
      
      // Guardado autom√°tico
      if (selectedBitacora) {
        selectedBitacora.luces = [...luces];
        autoSave();
      }
    }
    
    function renderLucesList() {
      const list = document.getElementById('lucesList');
      if (!list) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      list.innerHTML = '';
      luces.forEach((luz, idx) => {
        const div = document.createElement('div');
        div.className = 'luz-item';
        div.innerHTML = `<span>${luz.nombre}</span> <span>x${luz.cantidad}</span> <span>${luz.watts}W</span> <button class='luz-remove' onclick='removeLuz(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    function renderBitacoraInfo() {
      if (!selectedBitacora) return;
      
      const container = document.getElementById('bitacoraInfoContent');
      if (!container) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      container.innerHTML = '';
      
      // Verificar si la bit√°cora tiene caracter√≠sticas guardadas
      if (!selectedBitacora.cepas && !selectedBitacora.tipoCultivo) {
        container.innerHTML = '<div class="no-info">Esta bit√°cora no tiene caracter√≠sticas guardadas. Edita la bit√°cora para agregar informaci√≥n.</div>';
        return;
      }
      
      const infoGrid = document.createElement('div');
      infoGrid.className = 'info-grid';
      
      // Secci√≥n de Cepas
      if (selectedBitacora.cepas && selectedBitacora.cepas.length > 0) {
        const cepasSection = document.createElement('div');
        cepasSection.className = 'info-section';
        cepasSection.innerHTML = '<h4>üå± Cepas</h4>';
        selectedBitacora.cepas.forEach(cepa => {
          const item = document.createElement('div');
          item.className = 'info-item';
          let info = `<span class='info-label'>${cepa.nombre}</span> <span class='info-value cepa'>x${cepa.cantidad}</span> <span class='info-value'>(${cepa.tipo}`;
          if (cepa.tipo === 'semilla' && cepa.germinacion) {
            info += `, germinaci√≥n: ${cepa.germinacion}`;
          }
          info += ")</span>";
          item.innerHTML = info;
          cepasSection.appendChild(item);
        });
        infoGrid.appendChild(cepasSection);
      }
      
      // Secci√≥n de Tipo de Cultivo
      if (selectedBitacora.tipoCultivo) {
        const cultivoSection = document.createElement('div');
        cultivoSection.className = 'info-section';
        cultivoSection.innerHTML = '<h4>üè† Tipo de Cultivo</h4>';
        const cultivoItem = document.createElement('div');
        cultivoItem.className = 'info-item';
        const cultivoText = selectedBitacora.tipoCultivo.charAt(0).toUpperCase() + selectedBitacora.tipoCultivo.slice(1);
        cultivoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value ${selectedBitacora.tipoCultivo}">${cultivoText}</span>
        `;
        cultivoSection.appendChild(cultivoItem);
        // Informaci√≥n adicional para cultivo interior/invernadero
        if ((selectedBitacora.tipoCultivo === 'interior' || selectedBitacora.tipoCultivo === 'invernadero')) {
          if (selectedBitacora.numCarpas > 0) {
            const carpasItem = document.createElement('div');
            carpasItem.className = 'info-item';
            let carpasInfo = `${selectedBitacora.numCarpas}`;
            if (selectedBitacora.carpas && selectedBitacora.carpas.length > 0) {
              carpasInfo += ' (' + selectedBitacora.carpas.map((c, i) => `Carpa ${i+1}: ${c.metrosCuadrados} m¬≤`).join(', ') + ')';
            }
            carpasItem.innerHTML = `
              <span class="info-label">Carpas</span>
              <span class="info-value">${carpasInfo}</span>
            `;
            cultivoSection.appendChild(carpasItem);
          }
          if (selectedBitacora.soloSala) {
            const salaItem = document.createElement('div');
            salaItem.className = 'info-item';
            let salaInfo = 'Solo sala';
            if (selectedBitacora.carpas && selectedBitacora.carpas.length === 1) {
              salaInfo += ` (${selectedBitacora.carpas[0].metrosCuadrados} m¬≤)`;
            }
            salaItem.innerHTML = `
              <span class="info-label">Configuraci√≥n</span>
              <span class="info-value">${salaInfo}</span>
            `;
            cultivoSection.appendChild(salaItem);
          }
        }
        infoGrid.appendChild(cultivoSection);
      }
      // Secci√≥n de Extractores
      if (selectedBitacora.extractores && selectedBitacora.extractores.length > 0) {
        const extSection = document.createElement('div');
        extSection.className = 'info-section';
        extSection.innerHTML = '<h4>üí® Extractores</h4>';
        selectedBitacora.extractores.forEach((ext, idx) => {
          const extItem = document.createElement('div');
          extItem.className = 'info-item';
          extItem.innerHTML = `<span class='info-label'>Extractor ${idx+1}</span> <span class='info-value'>x${ext.cantidad} de ${ext.pulgadas}"</span>`;
          extSection.appendChild(extItem);
        });
        infoGrid.appendChild(extSection);
      }
      
      // Secci√≥n de Iluminaci√≥n
      if (selectedBitacora.tipoLuz || (selectedBitacora.luces && selectedBitacora.luces.length > 0)) {
        const luzSection = document.createElement('div');
        luzSection.className = 'info-section';
        luzSection.innerHTML = '<h4>üí° Iluminaci√≥n</h4>';
        
        if (selectedBitacora.tipoLuz) {
          const tipoLuzItem = document.createElement('div');
          tipoLuzItem.className = 'info-item';
          let tipoLuzText = '';
          switch (selectedBitacora.tipoLuz) {
            case 'sol': tipoLuzText = '‚òÄÔ∏è Sol'; break;
            case 'luz': tipoLuzText = 'üí° Artificial'; break;
            case 'mixto': tipoLuzText = 'üîÑ Mixto'; break;
          }
          tipoLuzItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value luz">${tipoLuzText}</span>
          `;
          luzSection.appendChild(tipoLuzItem);
        }
        
        if (selectedBitacora.luces && selectedBitacora.luces.length > 0) {
          selectedBitacora.luces.forEach(luz => {
            const luzItem = document.createElement('div');
            luzItem.className = 'info-item';
            luzItem.innerHTML = `
              <span class="info-label">${luz.nombre}</span>
              <span class="info-value">x${luz.cantidad} (${luz.watts}W)</span>
            `;
            luzSection.appendChild(luzItem);
          });
        }
        
        // Informaci√≥n de l√°mparas para cultivo interior
        if (selectedBitacora.tipoCultivo === 'interior') {
          if (selectedBitacora.lamparasVege > 0) {
            const vegeItem = document.createElement('div');
            vegeItem.className = 'info-item';
            vegeItem.innerHTML = `
              <span class="info-label">L√°mparas Vegetaci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasVege}${selectedBitacora.wattsVege ? ` (${selectedBitacora.wattsVege})` : ''}</span>
            `;
            luzSection.appendChild(vegeItem);
          }
          
          if (selectedBitacora.lamparasFlora > 0) {
            const floraItem = document.createElement('div');
            floraItem.className = 'info-item';
            floraItem.innerHTML = `
              <span class="info-label">L√°mparas Floraci√≥n</span>
              <span class="info-value">${selectedBitacora.lamparasFlora}${selectedBitacora.wattsFlora ? ` (${selectedBitacora.wattsFlora})` : ''}</span>
            `;
            luzSection.appendChild(floraItem);
          }
        }
        
        infoGrid.appendChild(luzSection);
      }
      
      // Secci√≥n de Riego
      if (selectedBitacora.riegoOptions && selectedBitacora.riegoOptions.length > 0) {
        const riegoSection = document.createElement('div');
        riegoSection.className = 'info-section';
        riegoSection.innerHTML = '<h4>üíß Riego</h4>';
        
        selectedBitacora.riegoOptions.forEach(riego => {
          const riegoItem = document.createElement('div');
          riegoItem.className = 'info-item';
          let riegoText = '';
          switch (riego) {
            case 'manual': riegoText = 'üëã Manual'; break;
            case 'goteo': riegoText = 'üíß Goteo'; break;
            case 'hidroponica': riegoText = 'üåä Hidrop√≥nica'; break;
          }
          riegoItem.innerHTML = `
            <span class="info-label">Tipo</span>
            <span class="info-value riego">${riegoText}</span>
          `;
          riegoSection.appendChild(riegoItem);
        });
        
        if (selectedBitacora.detalleRiego) {
          const detalleItem = document.createElement('div');
          detalleItem.className = 'info-item';
          detalleItem.innerHTML = `
            <span class="info-label">Detalles</span>
            <span class="info-value">${selectedBitacora.detalleRiego}</span>
          `;
          riegoSection.appendChild(detalleItem);
        }
        
        infoGrid.appendChild(riegoSection);
      }
      
      // Secci√≥n de Sustrato
      if (selectedBitacora.sustrato) {
        const sustratoSection = document.createElement('div');
        sustratoSection.className = 'info-section';
        sustratoSection.innerHTML = '<h4>üå± Sustrato</h4>';
        
        const sustratoItem = document.createElement('div');
        sustratoItem.className = 'info-item';
        sustratoItem.innerHTML = `
          <span class="info-label">Tipo</span>
          <span class="info-value">${selectedBitacora.sustrato}</span>
        `;
        sustratoSection.appendChild(sustratoItem);
        
        infoGrid.appendChild(sustratoSection);
      }
      
      // Secci√≥n de Equipamiento (solo para cultivo interior)
      if (selectedBitacora.tipoCultivo === 'interior') {
        const equipamientoSection = document.createElement('div');
        equipamientoSection.className = 'info-section';
        equipamientoSection.innerHTML = '<h4>‚öôÔ∏è Equipamiento</h4>';
        
        if (selectedBitacora.ventiladores > 0) {
          const ventiladoresItem = document.createElement('div');
          ventiladoresItem.className = 'info-item';
          ventiladoresItem.innerHTML = `
            <span class="info-label">Ventiladores</span>
            <span class="info-value">${selectedBitacora.ventiladores}${selectedBitacora.pulgadasVentilador ? ` (${selectedBitacora.pulgadasVentilador}")` : ''}</span>
          `;
          equipamientoSection.appendChild(ventiladoresItem);
        }
        
        if (selectedBitacora.filtroAire === 'si') {
          const filtroItem = document.createElement('div');
          filtroItem.className = 'info-item';
          filtroItem.innerHTML = `
            <span class="info-label">Filtro de Aire</span>
            <span class="info-value">‚úÖ S√≠</span>
          `;
          equipamientoSection.appendChild(filtroItem);
        }
        
        if (selectedBitacora.aireAcondicionado === 'si') {
          const aireItem = document.createElement('div');
          aireItem.className = 'info-item';
          aireItem.innerHTML = `
            <span class="info-label">Aire Acondicionado</span>
            <span class="info-value">‚úÖ S√≠${selectedBitacora.frigorias ? ` (${selectedBitacora.frigorias})` : ''}</span>
          `;
          equipamientoSection.appendChild(aireItem);
        }
        
        if (equipamientoSection.children.length > 1) { // M√°s de 1 porque incluye el h4
          infoGrid.appendChild(equipamientoSection);
        }
      }
      
      container.appendChild(infoGrid);
    }

    // Mostrar la fecha del √∫ltimo respaldo
    function setUltimoRespaldo(fecha) {
      const el = document.getElementById('ultimoRespaldo');
      if (!el) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      if (fecha) {
        el.textContent = '√öltimo respaldo: ' + fecha;
        localStorage.setItem('ultimoRespaldo', fecha);
      } else {
        const guardado = localStorage.getItem('ultimoRespaldo');
        el.textContent = '√öltimo respaldo: ' + (guardado || '-');
      }
    }
    // Llamar al cargar la p√°gina solo si el elemento existe
    if (document.getElementById('ultimoRespaldo')) {
      setUltimoRespaldo();
    }
    // Modificar createBackup para actualizar la fecha
    const originalCreateBackup = window.createBackup;
    window.createBackup = function() {
      if (originalCreateBackup) originalCreateBackup();
      const fecha = new Date().toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' });
      setUltimoRespaldo(fecha);
    }

    // Funciones auxiliares para el formulario
    function toggleInteriorFields() {
      const tipoCultivo = document.getElementById('tipoCultivo');
      const interiorFields = document.getElementById('interiorFields');
      if (!tipoCultivo || !interiorFields) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      interiorFields.style.display = tipoCultivo.value === 'interior' ? 'block' : 'none';
    }

    function toggleCarpasFields() {
      const numCarpasEl = document.getElementById('numCarpas');
      const soloSalaEl = document.getElementById('soloSala');
      const carpasList = document.getElementById('carpasList');
      
      if (!numCarpasEl || !soloSalaEl || !carpasList) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      
      const numCarpas = parseInt(numCarpasEl.value) || 0;
      const soloSala = soloSalaEl.checked;
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleFrigorias() {
      const aireAcondicionadoEl = document.getElementById('aireAcondicionado');
      const frigoriasList = document.getElementById('frigorias');
      
      if (!aireAcondicionadoEl || !frigoriasList) {
        // Salir silenciosamente si no encontramos los elementos
        return;
      }
      
      frigoriasList.style.display = aireAcondicionadoEl.value === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de bit√°cora
    function toggleEditInteriorFields() {
      const tipoCultivo = document.getElementById('editTipoCultivo').value;
      const interiorFields = document.getElementById('editInteriorFields');
      interiorFields.style.display = tipoCultivo === 'interior' ? 'block' : 'none';
    }

    function toggleEditCarpasFields() {
      const numCarpas = parseInt(document.getElementById('editNumCarpas').value) || 0;
      const soloSala = document.getElementById('editSoloSala').checked;
      const carpasList = document.getElementById('editCarpasList');
      
      carpasList.innerHTML = '';
      
      if (numCarpas > 0 && !soloSala) {
        for (let i = 1; i <= numCarpas; i++) {
          const div = document.createElement('div');
          div.className = 'carpa-item';
          div.innerHTML = `
            <span>Carpa ${i}</span>
            <input type="number" placeholder="Metros cuadrados (ej: 1x1 = 1)" min="0" step="0.1" />
            <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
          `;
          carpasList.appendChild(div);
        }
      } else if (soloSala) {
        const div = document.createElement('div');
        div.className = 'carpa-item';
        div.innerHTML = `
          <span>Sala √∫nica</span>
          <input type="number" placeholder="Metros cuadrados (ej: 2x3 = 6)" min="0" step="0.1" />
          <button class='carpa-remove' onclick='this.parentElement.remove()'>üóëÔ∏è</button>
        `;
        carpasList.appendChild(div);
      }
    }

    function toggleEditFrigorias() {
      const aireAcondicionado = document.getElementById('editAireAcondicionado').value;
      const frigorias = document.getElementById('editFrigorias');
      frigorias.style.display = aireAcondicionado === 'si' ? 'block' : 'none';
    }

    // Funciones para edici√≥n de cepas en modal de edici√≥n
    let editCepas = [];
    function addEditCepa() {
      const nombre = document.getElementById('editCepaNombre').value.trim();
      const cantidad = parseInt(document.getElementById('editCepaCantidad').value, 10) || 1;
      const tipo = document.getElementById('editCepaTipo').value;
      const germinacion = document.getElementById('editCepaGerminacion').value;
      if (!nombre) return;
      const cepa = { nombre, cantidad, tipo };
      if (tipo === 'semilla' && germinacion) {
        cepa.germinacion = germinacion;
      }
      editCepas.push(cepa);
      renderEditCepasList();
      document.getElementById('editCepaNombre').value = '';
      document.getElementById('editCepaCantidad').value = 1;
      document.getElementById('editCepaTipo').value = 'clon';
      document.getElementById('editCepaGerminacion').value = '';
      document.getElementById('editSemillaFields').style.display = 'none';
    }
    function removeEditCepa(index) {
      editCepas.splice(index, 1);
      renderEditCepasList();
    }
    function renderEditCepasList() {
      const list = document.getElementById('editCepasList');
      list.innerHTML = '';
      editCepas.forEach((cepa, idx) => {
        const div = document.createElement('div');
        div.className = 'cepa-item';
        let info = `${cepa.nombre} x${cepa.cantidad} (${cepa.tipo}`;
        if (cepa.tipo === 'semilla' && cepa.germinacion) {
          info += `, germinaci√≥n: ${cepa.germinacion}`;
        }
        info += ")";
        div.innerHTML = `<span>${info}</span> <button class='cepa-remove' onclick='removeEditCepa(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }
    function toggleEditGerminacionField() {
      const tipo = document.getElementById('editCepaTipo').value;
      const semillaFields = document.getElementById('editSemillaFields');
      semillaFields.style.display = tipo === 'semilla' ? 'block' : 'none';
    }
    // Funciones para extractores en edici√≥n
    let editExtractores = [];
    function addEditExtractor() {
      const cantidad = parseInt(document.getElementById('editExtractorCantidad').value, 10) || 1;
      const pulgadas = document.getElementById('editExtractorPulgadas').value.trim();
      if (!pulgadas) return;
      editExtractores.push({ cantidad, pulgadas });
      renderEditExtractoresList();
      document.getElementById('editExtractorCantidad').value = 1;
      document.getElementById('editExtractorPulgadas').value = '';
    }
    function removeEditExtractor(index) {
      editExtractores.splice(index, 1);
      renderEditExtractoresList();
    }
    function renderEditExtractoresList() {
      const list = document.getElementById('editExtractoresList');
      list.innerHTML = '';
      editExtractores.forEach((ext, idx) => {
        const div = document.createElement('div');
        div.className = 'extractor-item';
        div.innerHTML = `<span>x${ext.cantidad} de ${ext.pulgadas}"</span> <button class='extractor-remove' onclick='removeEditExtractor(${idx})'>üóëÔ∏è</button>`;
        list.appendChild(div);
      });
    }

    // Modo nocturno
    function toggleDarkMode() {
      const body = document.body;
      const btn = document.getElementById('toggleDarkMode');
      if (!btn) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      body.classList.toggle('dark-mode');
      if (body.classList.contains('dark-mode')) {
        btn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('darkMode', '1');
      } else {
        btn.textContent = 'üåô';
        localStorage.setItem('darkMode', '0');
      }
    }
    // Al cargar, aplicar modo guardado
    if (localStorage.getItem('darkMode') === '1') {
      document.body.classList.add('dark-mode');
      const toggleBtn = document.getElementById('toggleDarkMode');
      if (toggleBtn) toggleBtn.textContent = '‚òÄÔ∏è';
    }

    // Alternar formulario de nueva bit√°cora
    function toggleNewBitacoraForm() {
      const form = document.getElementById('newBitacoraForm');
      if (!form) {
        // Salir silenciosamente si no encontramos el elemento
        return;
      }
      const btn = document.getElementById('btnNuevaBitacora');
      if (form.style.display === 'block' || form.classList.contains('active')) {
        form.style.display = 'none';
        form.classList.remove('active');
        if (btn) btn.textContent = '+ Nueva Bit√°cora';
      } else {
        form.style.display = 'block';
        form.classList.add('active');
        if (btn) btn.textContent = 'Cerrar';
        showNewBitacoraForm();
      }
    }

    var formPacienteModal = document.getElementById('formPacienteModal');
    if (formPacienteModal) {
      formPacienteModal.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üìù Guardando paciente...');
        
        var nombreInput = document.getElementById('modalPacienteNombre');
        var dniInput = document.getElementById('modalPacienteDNI');
        var direccionInput = document.getElementById('modalPacienteDireccion');
        var telefonoInput = document.getElementById('modalPacienteTelefono');
        var obraSocialInput = document.getElementById('modalPacienteObraSocial');
        var patologiaInput = document.getElementById('modalPacientePatologia');
        var idInput = document.getElementById('modalPacienteId');
        
        if (!nombreInput || !dniInput) return;
        
        var nombre = nombreInput.value.trim();
        var dni = dniInput.value.trim();
        var direccion = direccionInput ? direccionInput.value.trim() : '';
        var telefono = telefonoInput ? telefonoInput.value.trim() : '';
        var obraSocial = obraSocialInput ? obraSocialInput.value.trim() : '';
        var patologia = patologiaInput ? patologiaInput.value.trim() : '';
        var id = idInput ? idInput.value : '';
        
        if (!nombre || !dni) {
          alert('‚ùå Nombre y DNI son obligatorios');
          return;
        }

        // Verificar DNI √∫nico
        const pacientesArray = window.allPacientes || allPacientes || [];
        const pacienteExistente = pacientesArray.find(p => p.dni === dni && p.id !== id);
        if (pacienteExistente) {
          alert('‚ùå Ya existe un paciente con este DNI');
          return;
        }

        const nuevoPaciente = {
          id: id || Date.now().toString(),
          nombre,
          dni,
          direccion,
          telefono,
          obraSocial,
          patologia,
          visitas: { primera: [], control: [], urgencia: [] },
          estudios: [],
          recordatorios: [],
          timestamp: new Date().toISOString()
        };

        try {
          // PASO 1: GUARDAR SIEMPRE EN localStorage PRIMERO (persistencia garantizada)
          console.log('üíæ Guardando en localStorage...');
          
          // ASEGURAR QUE EXISTAN LOS ARRAYS GLOBALES
          if (!window.allPacientes) window.allPacientes = [];
          if (!allPacientes) allPacientes = [];

          // Agregar/actualizar en AMBAS listas locales
          if (id) {
            // Editar existente
            const indexWindow = window.allPacientes.findIndex(p => p.id === id);
            const indexGlobal = allPacientes.findIndex(p => p.id === id);
            
            if (indexWindow !== -1) {
              window.allPacientes[indexWindow] = { ...window.allPacientes[indexWindow], ...nuevoPaciente };
            }
            if (indexGlobal !== -1) {
              allPacientes[indexGlobal] = { ...allPacientes[indexGlobal], ...nuevoPaciente };
            }
            console.log('‚úÖ Paciente actualizado localmente');
          } else {
            // Nuevo paciente
            window.allPacientes.push(nuevoPaciente);
            allPacientes.push(nuevoPaciente);
            console.log('‚úÖ Nuevo paciente agregado localmente');
          }
          
          // GUARDAR INMEDIATAMENTE EN localStorage (CR√çTICO PARA PERSISTENCIA)
          localStorage.setItem('allPacientes', JSON.stringify(window.allPacientes));
          console.log('üíæ ‚úÖ Pacientes guardados en localStorage');
          
          // BACKUP UNIFICADO TAMBI√âN
          const backupData = {
            pacientes: window.allPacientes,
            recordatorios: window.allRecordatorios || [],
            citas: window.allCitas || [],
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('clinicalDataBackup', JSON.stringify(backupData));
          console.log('üíæ ‚úÖ Backup unificado actualizado');
          
          selectedPaciente = nuevoPaciente;
          console.log('üìä Total pacientes despu√©s de agregar:', window.allPacientes.length);
          
          // PASO 2: Intentar guardar en Firebase (secundario, puede fallar)
          if (window.currentUser && window.setDoc) {
            try {
              console.log('‚òÅÔ∏è Intentando guardar en Firebase...');
              await window.setDoc(window.doc(window.db, 'users', window.currentUser.uid, 'pacientes', nuevoPaciente.id), nuevoPaciente);
              console.log('‚òÅÔ∏è ‚úÖ Paciente guardado en Firebase');
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Firebase no disponible, datos guardados solo localmente:', firebaseError);
            }
          } else {
            console.log('‚ö†Ô∏è Firebase no disponible, usando solo localStorage');
          }

          // Actualizar interfaz
          cerrarModalPaciente();
          renderPacienteSelector();
          
          alert('‚úÖ Paciente guardado exitosamente: ' + nombre);
          
        } catch (error) {
          console.error('‚ùå Error al guardar paciente:', error);
          alert('‚ùå Error al guardar paciente. Int√©ntalo de nuevo.');
        }
      });
    }

    var loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var userInput = document.getElementById('loginUser');
        var passInput = document.getElementById('loginPassword');
        if (!userInput || !passInput) return;
        var username = userInput.value.trim();
        var password = passInput.value;
        // ... resto del c√≥digo ...
      });
    }

    window.mostrarFormularioPaciente = function() {
      var modal = document.getElementById('modalPaciente');
      if (modal) modal.style.display = 'block';
      // Limpiar formulario
      const form = document.getElementById('formPacienteModal');
      if (form) form.reset();
      document.getElementById('modalPacienteId').value = '';
      document.getElementById('tituloModalPaciente').textContent = 'Nuevo Paciente';
    };

    window.cerrarModalPaciente = function() {
      var modal = document.getElementById('modalPaciente');
      if (modal) modal.style.display = 'none';
    };
    window.filtrarPacientes = function() {
      // Aqu√≠ deber√≠as poner la l√≥gica de filtrado de pacientes
      // Por ejemplo, si tienes una funci√≥n cargarPacientes(filtro)
      var input = document.getElementById('busquedaPaciente');
      if (!input) return;
      var filtro = input.value;
      if (typeof cargarPacientes === 'function') cargarPacientes(filtro);
    };
    function clearUserData() {
      var el = document.getElementById('userInfo');
      if (el && el.style) el.style.display = 'none';
      localStorage.removeItem('pacientes');
      localStorage.removeItem('pacientes_backups');
    }

    // ===== FUNCIONES DEL SISTEMA M√âDICO =====

    // Mostrar/ocultar formulario de nuevo paciente (con toggle)
    function showNewPacienteForm() {
      const form = document.getElementById('newPacienteForm');
      const selector = document.getElementById('pacienteSelector');
      const ficha = document.getElementById('fichaClinica');
      
      // Toggle: si el formulario ya est√° visible, lo ocultamos
      if (form && form.style.display === 'block') {
        hideNewPacienteForm();
        return;
      }
      
      // Mostrar formulario nuevo paciente
      if (form) form.style.display = 'block';
      if (selector) selector.style.display = 'none';
      if (ficha) ficha.style.display = 'none';
      
      clearPacienteForm();
      renderColorPicker();
      
      // Agregar logging para debug
      console.log('Formulario nuevo paciente abierto');
    }

    function hideNewPacienteForm() {
      const form = document.getElementById('newPacienteForm');
      const selector = document.getElementById('pacienteSelector');
      
      if (form) form.style.display = 'none';
      if (selector) selector.style.display = 'block';
      
      console.log('Formulario nuevo paciente cerrado');
      renderPacienteSelector();
    }

    // Limpiar formulario de paciente
    function clearPacienteForm() {
      const fields = ['pacienteNombre', 'pacienteDNI', 'pacienteDireccion', 
                      'pacienteTelefono', 'pacienteObraSocial', 'pacientePatologia'];
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }

    // Crear nuevo paciente
    async function createNewPaciente() {
      console.log('üîÑ Iniciando creaci√≥n de paciente...');
      
      try {
        // Obtener elementos del formulario
        const nombreEl = document.getElementById('pacienteNombre');
        const dniEl = document.getElementById('pacienteDNI');
        const direccionEl = document.getElementById('pacienteDireccion');
        const telefonoEl = document.getElementById('pacienteTelefono');
        const obraSocialEl = document.getElementById('pacienteObraSocial');
        const patologiaEl = document.getElementById('pacientePatologia');

        console.log('üìã Elementos del formulario:', {
          nombreEl: !!nombreEl,
          dniEl: !!dniEl,
          direccionEl: !!direccionEl,
          telefonoEl: !!telefonoEl,
          obraSocialEl: !!obraSocialEl,
          patologiaEl: !!patologiaEl
        });

        if (!nombreEl || !dniEl) {
          alert('‚ùå Error: No se encontraron los campos obligatorios del formulario');
          console.error('Elementos del formulario no encontrados');
          return;
        }

        const nombre = nombreEl.value?.trim();
        const dni = dniEl.value?.trim();
        const direccion = direccionEl?.value?.trim() || '';
        const telefono = telefonoEl?.value?.trim() || '';
        const obraSocial = obraSocialEl?.value?.trim() || '';
        const patologia = patologiaEl?.value?.trim() || '';

        console.log('üìù Datos del formulario:', { nombre, dni, direccion, telefono, obraSocial, patologia });

        // Validar datos obligatorios
        if (!nombre || !dni) {
          alert('‚ùå Nombre y DNI son obligatorios');
          console.log('‚ùå Validaci√≥n fallida: campos obligatorios vac√≠os');
          return;
        }

        // Verificar DNI √∫nico
        console.log('üîç Verificando DNI √∫nico...');
        console.log('üìä Total pacientes actuales:', allPacientes.length);
        
        const pacienteExistente = allPacientes.find(p => p.dni === dni);
        if (pacienteExistente) {
          alert('‚ùå Ya existe un paciente con este DNI');
          console.log('‚ùå DNI duplicado encontrado:', pacienteExistente);
          return;
        }

        // Verificar availableColors
        if (!availableColors || availableColors.length === 0) {
          console.error('‚ùå availableColors no est√° definido o est√° vac√≠o');
          alert('Error interno: colores no disponibles');
          return;
        }

        const colorIndex = Math.floor(Math.random() * availableColors.length);
        const color = availableColors[colorIndex];
        console.log('üé® Color asignado:', color);

        const nuevoPaciente = {
          id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          nombre,
          dni,
          direccion,
          telefono,
          obraSocial,
          patologia,
          color,
          fechaCreacion: new Date().toISOString(),
          visitas: {
            primera: [],
            seguimiento: [],
            urgencia: [],
            control: []
          }
        };

        console.log('üë§ Nuevo paciente creado:', nuevoPaciente);

        // Agregar a la lista local PRIMERO
        allPacientes.push(nuevoPaciente);
        selectedPaciente = nuevoPaciente;
        console.log('‚úÖ Paciente agregado a lista local');

        // FORZAR guardado en Firebase para sincronizaci√≥n
        if (currentUser) {
          console.log('‚òÅÔ∏è FORZANDO guardado en Firebase para sincronizaci√≥n...');
          try {
          await savePacienteToFirestore(nuevoPaciente);
            console.log('‚úÖ PACIENTE SINCRONIZADO - Disponible en todos los dispositivos');
            
            setTimeout(() => {
              alert('üåê Paciente sincronizado correctamente. Ahora est√° disponible en todos tus dispositivos.');
            }, 1000);
            
          } catch (firebaseError) {
            console.error('‚ùå Error sincronizando paciente con Firebase:', firebaseError);
            console.log('‚ö†Ô∏è Paciente guardado solo localmente. Intentando reintento...');
            
            // Reintento autom√°tico
            setTimeout(async () => {
              try {
                console.log('üîÑ Reintentando sincronizaci√≥n de paciente...');
                await savePacienteToFirestore(nuevoPaciente);
                console.log('‚úÖ REINTENTO EXITOSO - Paciente sincronizado');
                alert('‚úÖ Paciente sincronizado en segundo intento. Disponible en todos los dispositivos.');
              } catch (retryError) {
                console.error('‚ùå Reintento de paciente tambi√©n fall√≥:', retryError);
                alert('‚ö†Ô∏è Paciente guardado localmente pero no sincronizado. Se sincronizar√° cuando mejore la conexi√≥n.');
              }
            }, 3000);
          }
        } else {
          console.log('‚ö†Ô∏è No hay usuario autenticado');
          alert('‚ö†Ô∏è No est√°s autenticado. El paciente se guarda solo en este dispositivo.');
        }
        
        console.log('üìä Total pacientes despu√©s de agregar:', allPacientes.length);

        // CR√çTICO: Guardar INMEDIATAMENTE en localStorage con nuevo sistema
        const saveSuccess = saveToLocalStorage(STORAGE_KEYS.PACIENTES, allPacientes);
        if (saveSuccess) {
          console.log('‚úÖ Pacientes guardados exitosamente en localStorage');
        } else {
          console.error('‚ùå FALLO CR√çTICO: No se pudieron guardar los pacientes');
          alert('‚ö†Ô∏è Error guardando datos. Intenta de nuevo.');
        }

        // Actualizar interfaz
        hideNewPacienteForm();
        renderPacienteSelector();
        showFichaClinica();
        
        alert(`‚úÖ Paciente ${nombre} creado exitosamente`);
        console.log('üéâ Paciente creado exitosamente:', nombre);
        
      } catch (error) {
        console.error('‚ùå Error al crear paciente:', error);
        console.error('Stack trace:', error.stack);
        alert(`‚ùå Error al crear el paciente: ${error.message}. Revisa la consola para m√°s detalles.`);
      }
    }

    // Renderizar selector de pacientes
    window.renderPacienteSelector = function renderPacienteSelector() {
      console.log('üîÑ renderPacienteSelector llamado');
      const container = document.getElementById('pacienteSelector');
      if (!container) return;

      // SINCRONIZAR VARIABLES GLOBALES
      if (window.allPacientes && window.allPacientes.length > 0) {
        allPacientes = window.allPacientes;  // Sincronizar global con window
      } else if (allPacientes && allPacientes.length > 0) {
        window.allPacientes = allPacientes;  // Sincronizar window con global
      }
      
      const pacientesArray = window.allPacientes || allPacientes || [];
      console.log('üìä Pacientes disponibles para renderizar:', pacientesArray.length);

      const searchValue = document.getElementById('searchInput')?.value?.toLowerCase() || '';
      const filteredPacientes = pacientesArray.filter(p => 
        p.nombre.toLowerCase().includes(searchValue) ||
        p.dni.includes(searchValue) ||
        (p.patologia && p.patologia.toLowerCase().includes(searchValue))
      );

      if (filteredPacientes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay pacientes registrados</p>';
        container.style.display = 'block';
        return;
      }

      container.innerHTML = '';
      container.style.display = 'block';

      filteredPacientes.forEach(paciente => {
        const div = document.createElement('div');
        div.className = 'paciente-card';
        div.style.cssText = `
          background: var(--bg-secondary);
          border: 2px solid ${paciente.color};
          border-radius: 8px;
          padding: 16px;
          margin: 8px 0;
          cursor: pointer;
          transition: all 0.2s ease;
        `;

        const ultimaVisita = getUltimaVisita(paciente);
        const totalVisitas = getTotalVisitas(paciente);

        div.innerHTML = `
          <div style="display: flex; justify-content: between; align-items: center;">
            <div style="flex: 1;">
              <h4 style="margin: 0; color: var(--text);">${paciente.nombre}</h4>
              <p style="margin: 4px 0; color: var(--text-light);">DNI: ${paciente.dni}</p>
              ${paciente.patologia ? `<p style="margin: 4px 0; color: var(--text-light);">ü©∫ ${paciente.patologia}</p>` : ''}
            </div>
            <div style="text-align: right;">
              <div style="color: var(--text-light); font-size: 12px;">
                ${totalVisitas} visitas
              </div>
              <div style="color: var(--text-light); font-size: 12px;">
                ${ultimaVisita ? `√öltima: ${ultimaVisita}` : 'Sin visitas'}
              </div>
            </div>
          </div>
        `;

        div.addEventListener('click', () => window.selectPaciente(paciente));
        div.addEventListener('mouseenter', () => {
          div.style.transform = 'translateY(-2px)';
          div.style.boxShadow = `0 4px 12px ${paciente.color}40`;
        });
        div.addEventListener('mouseleave', () => {
          div.style.transform = 'translateY(0)';
          div.style.boxShadow = 'none';
        });

        container.appendChild(div);
      });
    }

    // Funci√≥n selectPaciente ya est√° definida globalmente arriba - esta es solo una referencia
    const selectPaciente = window.selectPaciente;

    // Mostrar ficha cl√≠nica del paciente
    function showFichaClinica() {
      if (!selectedPaciente) return;

      const ficha = document.getElementById('fichaClinica');
      const visitForm = document.getElementById('visitForm');
      const calendario = document.getElementById('calendarioSection');
      
      if (ficha) ficha.style.display = 'block';
      if (visitForm) visitForm.style.display = 'block';
      if (calendario) calendario.style.display = 'none';

      renderPacienteInfo();
      renderEstadisticasPaciente();
      initializeVisitForm();
      
      // Inicializar sistema de archivos
      initializeFileSystem();
      
      // Mostrar archivos guardados
      renderSavedFiles();
    }

    // Renderizar informaci√≥n del paciente
    function renderPacienteInfo() {
      const container = document.getElementById('pacienteInfo');
      if (!container || !selectedPaciente) return;

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div><strong>Nombre:</strong> ${selectedPaciente.nombre}</div>
          <div><strong>DNI:</strong> ${selectedPaciente.dni}</div>
          <div><strong>Direcci√≥n:</strong> ${selectedPaciente.direccion || 'No especificada'}</div>
          <div><strong>Tel√©fono:</strong> ${selectedPaciente.telefono || 'No especificado'}</div>
          <div><strong>Obra Social:</strong> ${selectedPaciente.obraSocial || 'No especificada'}</div>
          <div><strong>Patolog√≠a:</strong> ${selectedPaciente.patologia || 'No especificada'}</div>
        </div>
      `;
    }

    // Renderizar estad√≠sticas del paciente
    function renderEstadisticasPaciente() {
      const container = document.getElementById('estadisticasPaciente');
      if (!container || !selectedPaciente) return;

      const totalVisitas = getTotalVisitas(selectedPaciente);
      const ultimaVisita = getUltimaVisita(selectedPaciente);
      const promedioVisitas = getPromedioEntreVisitas(selectedPaciente);

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
          <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
            <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${totalVisitas}</div>
            <div style="font-size: 12px; color: var(--text-light);">Total visitas</div>
          </div>
          <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
            <div style="font-size: 14px; font-weight: bold; color: var(--primary);">${ultimaVisita || 'Nunca'}</div>
            <div style="font-size: 12px; color: var(--text-light);">√öltima visita</div>
          </div>
          <div style="text-align: center; padding: 8px; background: var(--bg); border-radius: 6px;">
            <div style="font-size: 14px; font-weight: bold; color: var(--primary);">${promedioVisitas}</div>
            <div style="font-size: 12px; color: var(--text-light);">Promedio entre visitas</div>
          </div>
        </div>
      `;
    }

    // Funciones auxiliares para estad√≠sticas
    function getTotalVisitas(paciente) {
      if (!paciente.visitas) return 0;
      return Object.values(paciente.visitas).reduce((total, visits) => total + visits.length, 0);
    }

    function getUltimaVisita(paciente) {
      if (!paciente.visitas) return null;
      
      let ultimaFecha = null;
      Object.values(paciente.visitas).forEach(visits => {
        visits.forEach(visit => {
          const fecha = new Date(visit.date);
          if (!ultimaFecha || fecha > ultimaFecha) {
            ultimaFecha = fecha;
          }
        });
      });

      if (!ultimaFecha) return null;
      
      const hoy = new Date();
      const diferencia = Math.floor((hoy - ultimaFecha) / (1000 * 60 * 60 * 24));
      
      if (diferencia === 0) return 'Hoy';
      if (diferencia === 1) return 'Ayer';
      if (diferencia < 7) return `Hace ${diferencia} d√≠as`;
      return ultimaFecha.toLocaleDateString('es-ES');
    }

    function getPromedioEntreVisitas(paciente) {
      if (!paciente.visitas) return 'N/A';
      
      const todasLasVisitas = [];
      Object.values(paciente.visitas).forEach(visits => {
        visits.forEach(visit => todasLasVisitas.push(new Date(visit.date)));
      });

      if (todasLasVisitas.length < 2) return 'N/A';

      todasLasVisitas.sort((a, b) => a - b);
      
      const diferencias = [];
      for (let i = 1; i < todasLasVisitas.length; i++) {
        const diff = (todasLasVisitas[i] - todasLasVisitas[i-1]) / (1000 * 60 * 60 * 24);
        diferencias.push(diff);
      }

      const promedio = diferencias.reduce((a, b) => a + b) / diferencias.length;
      return `${Math.round(promedio)} d√≠as`;
    }

    // Inicializar formulario de visita MEJORADO
    function initializeVisitForm() {
      console.log('üìã Inicializando formulario de visita...');
      
      // Establecer fecha de hoy por defecto
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('date');
      if (dateInput) {
        dateInput.value = today;
        console.log('üìÖ Fecha establecida:', today);
      }
      
      // Establecer hora actual por defecto
      const now = new Date();
      const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                         now.getMinutes().toString().padStart(2, '0');
      const timeInput = document.getElementById('visitTime');
      if (timeInput) {
        timeInput.value = currentTime;
        console.log('‚è∞ Hora establecida:', currentTime);
      }
      
      // Establecer estado por defecto
      const estadoSelect = document.getElementById('estadoSelect');
      if (estadoSelect) {
        estadoSelect.value = 'estable';
        console.log('üè• Estado establecido: estable');
      }
      
      // Limpiar todos los campos de texto
      const fieldsToClean = ['sintomas', 'observaciones', 'tratamiento', 'estudios'];
      fieldsToClean.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.value = '';
        }
      });
      
      // Limpiar archivo
      const fileInput = document.getElementById('archivoEstudio');
      if (fileInput) {
        fileInput.value = '';
      }
      
      console.log('‚úÖ Formulario de visita inicializado correctamente');
    }

    // Cambiar tipo de visita
    function setStage(visitType) {
      selectedVisitType = visitType;
      
      // Actualizar botones activos
      document.querySelectorAll('.stage-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeBtn = document.getElementById(`btn-${visitType}`);
      if (activeBtn) activeBtn.classList.add('active');

      renderHistory();
    }

    // Buscar pacientes
    function searchPacientes() {
      renderPacienteSelector();
    }

    // ===== SISTEMA DE ARCHIVOS DE ESTUDIOS =====

    // Inicializar el sistema de archivos
    function initializeFileSystem() {
      const fileInput = document.getElementById('archivoEstudio');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelection);
        console.log('‚úÖ Sistema de archivos inicializado');
      }
    }

    // Manejar selecci√≥n de archivos
    function handleFileSelection(event) {
      const files = event.target.files;
      const fileCount = document.getElementById('fileCount');
      const selectedFilesDiv = document.getElementById('selectedFiles');
      const fileList = document.getElementById('fileList');

      console.log('üìÅ Archivos seleccionados:', files.length);

      if (files.length === 0) {
        fileCount.textContent = 'Ning√∫n archivo seleccionado';
        selectedFilesDiv.style.display = 'none';
        return;
      }

      // Actualizar contador
      fileCount.textContent = `${files.length} archivo${files.length > 1 ? 's' : ''} seleccionado${files.length > 1 ? 's' : ''}`;
      
      // Mostrar lista de archivos
      selectedFilesDiv.style.display = 'block';
      fileList.innerHTML = '';

      Array.from(files).forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = `
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 8px;
          margin: 4px 0;
          background: var(--bg);
          border-radius: 4px;
          border: 1px solid var(--border);
        `;

        const fileInfo = document.createElement('div');
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileIcon = getFileIcon(file.type);
        
        fileInfo.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${fileIcon}</span>
            <div>
              <div style="font-weight: 500; color: var(--text);">${file.name}</div>
              <div style="font-size: 12px; color: var(--text-light);">${fileSize} MB ‚Ä¢ ${file.type || 'Tipo desconocido'}</div>
            </div>
          </div>
        `;

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '‚ùå';
        removeBtn.style.cssText = `
          background: none;
          border: none;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          color: var(--danger);
        `;
        removeBtn.onclick = () => removeFile(index);

        fileDiv.appendChild(fileInfo);
        fileDiv.appendChild(removeBtn);
        fileList.appendChild(fileDiv);
      });
    }

    // Obtener icono seg√∫n tipo de archivo
    function getFileIcon(fileType) {
      if (fileType.includes('pdf')) return 'üìÑ';
      if (fileType.includes('image')) return 'üñºÔ∏è';
      if (fileType.includes('document') || fileType.includes('word')) return 'üìù';
      if (fileType.includes('text')) return 'üìÉ';
      return 'üìé';
    }

    // Remover archivo de la selecci√≥n
    function removeFile(index) {
      const fileInput = document.getElementById('archivoEstudio');
      const dt = new DataTransfer();
      
      Array.from(fileInput.files).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
      });
      
      fileInput.files = dt.files;
      handleFileSelection({ target: fileInput });
    }

    // Procesar archivos para guardar
    async function processFilesForSave(files) {
      console.log('üîÑ Procesando archivos para guardar...');
      const processedFiles = [];

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Validar tama√±o (10MB m√°ximo)
        if (file.size > 10 * 1024 * 1024) {
          alert(`‚ùå El archivo "${file.name}" es demasiado grande. M√°ximo 10MB.`);
          continue;
        }

        try {
          const fileData = await readFileAsBase64(file);
          processedFiles.push({
            id: Date.now() + '_' + i,
            name: file.name,
            type: file.type,
            size: file.size,
            data: fileData,
            uploadDate: new Date().toISOString()
          });
          console.log(`‚úÖ Archivo procesado: ${file.name}`);
        } catch (error) {
          console.error(`‚ùå Error procesando ${file.name}:`, error);
          alert(`‚ùå Error procesando el archivo "${file.name}"`);
        }
      }

      return processedFiles;
    }

    // Leer archivo como Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Mostrar archivos guardados del paciente
    function renderSavedFiles() {
      const savedFilesList = document.getElementById('savedFilesList');
      if (!savedFilesList || !selectedPaciente) return;

      // Recopilar todos los archivos de todas las visitas
      const allFiles = [];
      if (selectedPaciente.visitas) {
        Object.values(selectedPaciente.visitas).forEach(visits => {
          visits.forEach(visit => {
            if (visit.files && Array.isArray(visit.files)) {
              visit.files.forEach(file => {
                allFiles.push({
                  ...file,
                  visitDate: visit.date,
                  visitType: visit.visitType
                });
              });
            }
          });
        });
      }

      if (allFiles.length === 0) {
        savedFilesList.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No hay archivos guardados</p>';
        return;
      }

      savedFilesList.innerHTML = '';
      allFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = `
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 8px;
          margin: 4px 0;
          background: var(--bg);
          border-radius: 4px;
          border: 1px solid var(--border);
        `;

        const fileInfo = document.createElement('div');
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileIcon = getFileIcon(file.type);
        const visitDate = new Date(file.visitDate).toLocaleDateString('es-ES');
        
        fileInfo.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${fileIcon}</span>
            <div>
              <div style="font-weight: 500; color: var(--text);">${file.name}</div>
              <div style="font-size: 12px; color: var(--text-light);">${fileSize} MB ‚Ä¢ ${visitDate} ‚Ä¢ ${file.visitType}</div>
            </div>
          </div>
        `;

        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '4px';

        // Bot√≥n ver/descargar
        const viewBtn = document.createElement('button');
        viewBtn.innerHTML = 'üëÅÔ∏è';
        viewBtn.title = 'Ver archivo';
        viewBtn.style.cssText = `
          background: var(--primary);
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
        `;
        viewBtn.onclick = () => viewFile(file);

        actionsDiv.appendChild(viewBtn);
        fileDiv.appendChild(fileInfo);
        fileDiv.appendChild(actionsDiv);
        savedFilesList.appendChild(fileDiv);
      });
    }

    // Ver archivo
    function viewFile(file) {
      const newWindow = window.open();
      newWindow.document.write(`
        <html>
          <head><title>${file.name}</title></head>
          <body style="margin: 0; padding: 20px; font-family: Arial, sans-serif;">
            <h2>üìÑ ${file.name}</h2>
            <p><strong>Tama√±o:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            <p><strong>Tipo:</strong> ${file.type}</p>
            <p><strong>Fecha de subida:</strong> ${new Date(file.uploadDate).toLocaleString('es-ES')}</p>
            <hr>
            ${file.type.includes('image') ? 
              `<img src="${file.data}" style="max-width: 100%; height: auto;">` :
              `<iframe src="${file.data}" style="width: 100%; height: 80vh; border: none;"></iframe>`
            }
          </body>
        </html>
      `);
    }

    // Guardar visita m√©dica MEJORADA
    async function saveVisit() {
      console.log('ü©∫ Iniciando guardado de visita...');
      
      if (!selectedPaciente) {
        alert('‚ùå No hay paciente seleccionado');
        console.error('No hay paciente seleccionado');
        return;
      }

      if (!selectedVisitType) {
        alert('‚ùå Selecciona el tipo de consulta primero');
        console.error('No hay tipo de visita seleccionado');
        return;
      }

      // Obtener todos los campos del formulario
      const date = document.getElementById('date')?.value;
      const time = document.getElementById('visitTime')?.value;
      const estado = document.getElementById('estadoSelect')?.value;
      const sintomas = document.getElementById('sintomas')?.value?.trim();
      const observaciones = document.getElementById('observaciones')?.value?.trim();
      const tratamiento = document.getElementById('tratamiento')?.value?.trim();
      const estudios = document.getElementById('estudios')?.value?.trim();
      const archivos = document.getElementById('archivoEstudio')?.files;

      console.log('üìù Datos del formulario:', {
        date, time, estado, sintomas: sintomas?.length, 
        observaciones: observaciones?.length, tratamiento: tratamiento?.length,
        estudios: estudios?.length, selectedVisitType
      });

      // Validaciones
      if (!date) {
        alert('‚ùå La fecha es obligatoria');
        document.getElementById('date')?.focus();
        return;
      }

      if (!sintomas && !observaciones && !tratamiento) {
        if (!confirm('‚ö†Ô∏è No has completado ning√∫n campo cl√≠nico. ¬øDeseas guardar la visita vac√≠a?')) {
          return;
        }
      }

      // Procesar archivos si los hay
      let processedFiles = [];
      if (archivos && archivos.length > 0) {
        console.log('üìÅ Procesando archivos adjuntos...');
        try {
          processedFiles = await processFilesForSave(archivos);
          console.log(`‚úÖ ${processedFiles.length} archivos procesados correctamente`);
        } catch (error) {
          console.error('‚ùå Error procesando archivos:', error);
          alert('‚ö†Ô∏è Algunos archivos no se pudieron procesar, pero la visita se guardar√°.');
        }
      }

      // Crear objeto de visita
      const visit = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        date,
        time: time || '09:00',
        visitType: selectedVisitType,
        estado: estado || 'estable',
        sintomas: sintomas || '',
        observaciones: observaciones || '',
        tratamiento: tratamiento || '',
        estudios: estudios || '',
        files: processedFiles, // Archivos procesados con datos Base64
        timestamp: new Date().toISOString(),
        pacienteId: selectedPaciente.id,
        pacienteNombre: selectedPaciente.nombre
      };

      console.log('üë§ Visita creada:', visit);

      try {
        // Asegurar que existe la estructura de visitas
        if (!selectedPaciente.visitas) {
          selectedPaciente.visitas = {
            primera: [],
            seguimiento: [],
            urgencia: [],
            control: []
          };
        }

        if (!selectedPaciente.visitas[selectedVisitType]) {
          selectedPaciente.visitas[selectedVisitType] = [];
        }
        
        // Agregar la visita
        selectedPaciente.visitas[selectedVisitType].push(visit);
        console.log('‚úÖ Visita agregada al paciente');

        // CR√çTICO: Actualizar la lista global de pacientes
        const pacienteIndex = allPacientes.findIndex(p => p.id === selectedPaciente.id);
        if (pacienteIndex >= 0) {
          allPacientes[pacienteIndex] = selectedPaciente;
          console.log('‚úÖ Paciente actualizado en lista global');
        } else {
          console.error('‚ùå Paciente no encontrado en lista global');
        }

        // Guardar SIEMPRE en localStorage primero
        const saveSuccess = saveToLocalStorage(STORAGE_KEYS.PACIENTES, allPacientes);
        if (saveSuccess) {
          console.log('üíæ Visita guardada en localStorage');
        } else {
          console.error('‚ùå FALLO CR√çTICO: No se pudo guardar en localStorage');
          alert('‚ùå Error guardando datos localmente. Intenta de nuevo.');
          return;
        }

        // FORZAR guardado en Firebase para sincronizaci√≥n
        if (currentUser) {
          console.log('‚òÅÔ∏è FORZANDO guardado en Firebase para sincronizaci√≥n...');
          try {
          await savePacienteToFirestore(selectedPaciente);
            console.log('‚úÖ SINCRONIZACI√ìN EXITOSA - Datos disponibles en todos los dispositivos');
            
            // Confirmar sincronizaci√≥n
            setTimeout(() => {
              console.log('üåê Verificando sincronizaci√≥n...');
              alert('‚úÖ Datos sincronizados correctamente con la nube. Ahora est√°n disponibles en todos tus dispositivos.');
            }, 500);
            
          } catch (firebaseError) {
            console.error('‚ùå Error en sincronizaci√≥n con Firebase:', firebaseError);
            console.log('‚ö†Ô∏è Datos guardados solo localmente. Intentando reintento autom√°tico...');
            
            // Intentar servicio alternativo inmediatamente
            console.log('üîÑ Intentando servicio alternativo...');
            const alternativeSuccess = await syncWithAlternativeService();
            
            if (alternativeSuccess) {
              console.log('‚úÖ SINCRONIZACI√ìN ALTERNATIVA EXITOSA');
              alert('‚úÖ Datos sincronizados con servicio alternativo!\nüì± Disponibles en todos tus dispositivos.\n\nüí° Firebase tiene problemas pero tus datos est√°n seguros.');
            } else {
              console.log('‚ùå Todos los servicios fallaron');
              alert('‚ö†Ô∏è No se pudo sincronizar con ning√∫n servicio.\nüíæ Los datos est√°n guardados localmente.\nüîÑ Usa el bot√≥n "üåê Sincronizar Datos" m√°s tarde.');
            }
          }
        } else {
          console.log('‚ö†Ô∏è No hay usuario autenticado, guardando solo localmente');
          alert('‚ö†Ô∏è No est√°s autenticado. Los datos se guardan solo en este dispositivo.');
        }

        // LIMPIAR TODOS LOS CAMPOS DEL FORMULARIO
        console.log('üßπ Limpiando formulario...');
        
        // Campos de texto
        const fieldsToClean = ['sintomas', 'observaciones', 'tratamiento', 'estudios'];
        fieldsToClean.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.value = '';
            console.log(`‚úÖ Campo ${id} limpiado`);
          }
        });
        
        // Archivo
        const fileInput = document.getElementById('archivoEstudio');
        if (fileInput) {
          fileInput.value = '';
          console.log('‚úÖ Campo archivo limpiado');
        }
        
        // Limpiar interfaz de archivos
        const fileCount = document.getElementById('fileCount');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        if (fileCount) fileCount.textContent = 'Ning√∫n archivo seleccionado';
        if (selectedFilesDiv) selectedFilesDiv.style.display = 'none';
        
        // Actualizar archivos guardados
        renderSavedFiles();

        // Restablecer estado por defecto
        const estadoSelect = document.getElementById('estadoSelect');
        if (estadoSelect) {
          estadoSelect.value = 'estable';
          console.log('‚úÖ Estado restablecido a "estable"');
        }

        // Actualizar interfaz
        renderEstadisticasPaciente();
        renderHistory();
        
        // MENSAJE DE CONFIRMACI√ìN MEJORADO
        const visitTypeLabel = visitTypes.find(v => v.value === selectedVisitType)?.label || selectedVisitType;
        const mensaje = `‚úÖ VISITA GUARDADA CORRECTAMENTE\n\n` +
                       `üë§ Paciente: ${selectedPaciente.nombre}\n` +
                       `ü©∫ Tipo: ${visitTypeLabel}\n` +
                       `üìÖ Fecha: ${date}\n` +
                       `‚è∞ Hora: ${time}\n\n` +
                       `Los campos han sido limpiados para la pr√≥xima visita.`;
        
        alert(mensaje);
        console.log('üéâ Visita guardada exitosamente');
        
      } catch (error) {
        console.error('‚ùå Error al guardar visita:', error);
        console.error('Stack trace:', error.stack);
        alert(`‚ùå Error al guardar la visita: ${error.message}\n\nRevisa la consola para m√°s detalles.`);
      }
    }

    // Renderizar historial de visitas
    function renderHistory() {
      const container = document.getElementById('history');
      if (!container || !selectedPaciente) return;

      const visitas = selectedPaciente.visitas[selectedVisitType] || [];
      
      if (visitas.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay visitas registradas de este tipo</p>';
        return;
      }

      const visitasOrdenadas = [...visitas].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      container.innerHTML = `
        <div class="form-section">
          <h4>üìã Historial de ${visitTypes.find(v => v.value === selectedVisitType)?.label}</h4>
          ${visitasOrdenadas.map(visita => `
            <div style="background: var(--bg); padding: 12px; border-radius: 6px; margin: 8px 0; border-left: 4px solid ${estadosClinicosColors[visita.estado] || '#gray'};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong>${new Date(visita.date).toLocaleDateString('es-ES')} ${visita.time}</strong>
                <span style="background: ${estadosClinicosColors[visita.estado]}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                  ${document.getElementById('estadoSelect')?.querySelector(`option[value="${visita.estado}"]`)?.textContent || visita.estado}
                </span>
              </div>
              ${visita.sintomas ? `<p><strong>S√≠ntomas:</strong> ${visita.sintomas}</p>` : ''}
              ${visita.observaciones ? `<p><strong>Observaciones:</strong> ${visita.observaciones}</p>` : ''}
              ${visita.tratamiento ? `<p><strong>Tratamiento:</strong> ${visita.tratamiento}</p>` : ''}
              ${visita.estudios ? `<p><strong>Estudios:</strong> ${visita.estudios}</p>` : ''}
              ${visita.archivos && visita.archivos.length > 0 ? `<p><strong>Archivos:</strong> ${visita.archivos.join(', ')}</p>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    // ===== FUNCIONES DE GESTI√ìN DE PACIENTES =====
    
    // Editar paciente
    function editPaciente() {
      if (!selectedPaciente) return;
      
      // Cargar datos actuales en el modal
      document.getElementById('editPacienteNombre').value = selectedPaciente.nombre;
      document.getElementById('editPacienteDNI').value = selectedPaciente.dni;
      document.getElementById('editPacienteDireccion').value = selectedPaciente.direccion || '';
      document.getElementById('editPacienteTelefono').value = selectedPaciente.telefono || '';
      document.getElementById('editPacienteObraSocial').value = selectedPaciente.obraSocial || '';
      document.getElementById('editPacientePatologia').value = selectedPaciente.patologia || '';
      
      document.getElementById('editPacienteModal').style.display = 'block';
    }

    function closeEditPacienteModal() {
      document.getElementById('editPacienteModal').style.display = 'none';
    }

    async function saveEditPaciente() {
      const nombre = document.getElementById('editPacienteNombre').value.trim();
      const direccion = document.getElementById('editPacienteDireccion').value.trim();
      const telefono = document.getElementById('editPacienteTelefono').value.trim();
      const obraSocial = document.getElementById('editPacienteObraSocial').value.trim();
      const patologia = document.getElementById('editPacientePatologia').value.trim();

      if (!nombre) {
        alert('El nombre es obligatorio');
        return;
      }

      // Actualizar datos del paciente
      selectedPaciente.nombre = nombre;
      selectedPaciente.direccion = direccion;
      selectedPaciente.telefono = telefono;
      selectedPaciente.obraSocial = obraSocial;
      selectedPaciente.patologia = patologia;

      try {
        if (currentUser) {
          await savePacienteToFirestore(selectedPaciente);
        }

        // Actualizar en la lista local
        const index = allPacientes.findIndex(p => p.id === selectedPaciente.id);
        if (index !== -1) {
          allPacientes[index] = selectedPaciente;
        }

        renderPacienteInfo();
        renderPacienteSelector();
        closeEditPacienteModal();
        
        alert('‚úÖ Paciente actualizado exitosamente');
      } catch (error) {
        console.error('Error al actualizar paciente:', error);
        alert('Error al actualizar el paciente. Intenta de nuevo.');
      }
    }

    // Exportar historia cl√≠nica en JSON
    function exportHistoriaJSON() {
      if (!selectedPaciente) return;
      
      const data = {
        paciente: selectedPaciente,
        exportDate: new Date().toISOString(),
        totalVisitas: getTotalVisitas(selectedPaciente),
        ultimaVisita: getUltimaVisita(selectedPaciente),
        promedioEntreVisitas: getPromedioEntreVisitas(selectedPaciente)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Historia_Clinica_${selectedPaciente.nombre.replace(/\s+/g, '_')}_${selectedPaciente.dni}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Exportar historia cl√≠nica en PDF
    function exportHistoriaPDF() {
      if (!selectedPaciente) return;
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // T√≠tulo
        doc.setFontSize(20);
        doc.text('HISTORIA CL√çNICA', 20, 20);
        
        // Datos del paciente
        doc.setFontSize(14);
        doc.text('DATOS DEL PACIENTE', 20, 40);
        doc.setFontSize(12);
        
        let y = 50;
        doc.text(`Nombre: ${selectedPaciente.nombre}`, 20, y);
        doc.text(`DNI: ${selectedPaciente.dni}`, 20, y + 10);
        doc.text(`Direcci√≥n: ${selectedPaciente.direccion || 'No especificada'}`, 20, y + 20);
        doc.text(`Tel√©fono: ${selectedPaciente.telefono || 'No especificado'}`, 20, y + 30);
        doc.text(`Obra Social: ${selectedPaciente.obraSocial || 'No especificada'}`, 20, y + 40);
        doc.text(`Patolog√≠a: ${selectedPaciente.patologia || 'No especificada'}`, 20, y + 50);
        
        // Estad√≠sticas
        y += 70;
        doc.setFontSize(14);
        doc.text('ESTAD√çSTICAS', 20, y);
        doc.setFontSize(12);
        y += 10;
        
        doc.text(`Total de visitas: ${getTotalVisitas(selectedPaciente)}`, 20, y);
        doc.text(`√öltima visita: ${getUltimaVisita(selectedPaciente) || 'Nunca'}`, 20, y + 10);
        doc.text(`Promedio entre visitas: ${getPromedioEntreVisitas(selectedPaciente)}`, 20, y + 20);
        
        // Historial de visitas
        y += 40;
        doc.setFontSize(14);
        doc.text('HISTORIAL DE VISITAS', 20, y);
        doc.setFontSize(10);
        y += 10;
        
        if (selectedPaciente.visitas) {
          Object.keys(selectedPaciente.visitas).forEach(tipoVisita => {
            const visitas = selectedPaciente.visitas[tipoVisita];
            if (visitas && visitas.length > 0) {
              y += 10;
              doc.setFontSize(12);
              doc.text(`${visitTypes.find(v => v.value === tipoVisita)?.label || tipoVisita}:`, 20, y);
              doc.setFontSize(10);
              
              visitas.forEach(visita => {
                y += 8;
                if (y > 270) { // Nueva p√°gina si es necesario
                  doc.addPage();
                  y = 20;
                }
                
                const fecha = new Date(visita.date).toLocaleDateString('es-ES');
                doc.text(`‚Ä¢ ${fecha} - ${visita.estado}`, 25, y);
                
                if (visita.sintomas) {
                  y += 6;
                  doc.text(`  S√≠ntomas: ${visita.sintomas.substring(0, 80)}${visita.sintomas.length > 80 ? '...' : ''}`, 25, y);
                }
                
                if (visita.tratamiento) {
                  y += 6;
                  doc.text(`  Tratamiento: ${visita.tratamiento.substring(0, 80)}${visita.tratamiento.length > 80 ? '...' : ''}`, 25, y);
                }
              });
            }
          });
        }
        
        // Pie de p√°gina
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`Exportado el ${new Date().toLocaleString('es-ES')} - P√°gina ${i} de ${pageCount}`, 20, 285);
        }
        
        doc.save(`Historia_Clinica_${selectedPaciente.nombre.replace(/\s+/g, '_')}_${selectedPaciente.dni}.pdf`);
        
      } catch (error) {
        console.error('Error al generar PDF:', error);
        alert('Error al generar el PDF. Intenta de nuevo.');
      }
    }

    function deletePaciente() {
      if (!selectedPaciente) return;
      
      if (confirm(`¬øEst√°s seguro de eliminar al paciente ${selectedPaciente.nombre}? Esta acci√≥n no se puede deshacer.`)) {
        allPacientes = allPacientes.filter(p => p.id !== selectedPaciente.id);
        selectedPaciente = null;
        
        // CR√çTICO: Guardar cambios inmediatamente en localStorage
        const saveSuccess = saveToLocalStorage(STORAGE_KEYS.PACIENTES, allPacientes);
        if (!saveSuccess) {
          console.error('‚ùå FALLO CR√çTICO: No se pudieron guardar cambios tras eliminaci√≥n');
          alert('‚ö†Ô∏è Error guardando cambios. Los datos pueden no persistir.');
        }
        
        document.getElementById('fichaClinica').style.display = 'none';
        document.getElementById('visitForm').style.display = 'none';
        renderPacienteSelector();
        
        alert('Paciente eliminado exitosamente');
      }
    }

    // Funciones de Firebase para pacientes - SINCRONIZACI√ìN POR USUARIO
    async function savePacienteToFirestore(paciente) {
      if (!currentUser || !paciente) {
        console.error('‚ùå No hay usuario autenticado o paciente inv√°lido');
        return;
      }
      
      console.log('üîê Guardando para usuario:', currentUser.email);
      console.log('üë§ Guardando paciente:', paciente.nombre);
      
      try {
        // Estructura: users/{userId}/pacientes/{pacienteId}
        const docRef = db.collection('users').doc(currentUser.uid).collection('pacientes').doc(paciente.id);
        
        // Agregar metadatos de usuario para verificaci√≥n
        const pacienteConMetadata = {
          ...paciente,
          ownerUserId: currentUser.uid,
          ownerEmail: currentUser.email,
          lastModified: new Date().toISOString(),
          syncVersion: Date.now()
        };
        
        await docRef.set(pacienteConMetadata, { merge: true });
        
        console.log('‚úÖ PACIENTE SINCRONIZADO EXITOSAMENTE');
        console.log('üåê Disponible para usuario:', currentUser.email);
        console.log('üì± Accesible desde cualquier dispositivo');
        
        return true;
        
      } catch (error) {
        console.error('‚ùå ERROR CR√çTICO en Firebase:', error);
        console.error('üîç Detalles del error:', {
          code: error.code,
          message: error.message,
          userId: currentUser.uid,
          userEmail: currentUser.email
        });
        
        // No usar fallback aqu√≠ - dejar que se maneje arriba
        throw error;
      }
    }

    async function loadPacientesFromFirestore() {
      if (!currentUser) {
        console.log('‚ö†Ô∏è No hay usuario autenticado, cargando datos locales...');
        loadLocalData();
        return;
      }
      
      console.log('üîê Cargando datos para usuario:', currentUser.email);
      
      try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                 .collection('pacientes').get();
        
        allPacientes = [];
        let pacientesFromFirebase = 0;
        
        snapshot.forEach(doc => {
          const pacienteData = doc.data();
          // Verificar que el paciente pertenece al usuario actual
          if (pacienteData.ownerUserId === currentUser.uid) {
            allPacientes.push(pacienteData);
            pacientesFromFirebase++;
          } else {
            console.warn('‚ö†Ô∏è Paciente no pertenece al usuario actual:', pacienteData.nombre);
          }
        });
        
        // Sincronizar con variables globales
        window.allPacientes = allPacientes;
        
        console.log('‚úÖ DATOS CARGADOS DESDE FIREBASE (SINCRONIZADOS)');
        console.log('üîê Usuario:', currentUser.email);
        console.log('üìä Pacientes sincronizados:', pacientesFromFirebase);
        
        // Si no hay datos en Firebase, intentar cargar desde localStorage y sincronizar
        if (pacientesFromFirebase === 0) {
          console.log('üì¶ No hay datos en Firebase, verificando localStorage...');
          const pacientesLocal = loadFromLocalStorage(STORAGE_KEYS.PACIENTES);
          
          if (pacientesLocal && Array.isArray(pacientesLocal) && pacientesLocal.length > 0) {
            console.log('üîÑ Encontrados datos locales, sincronizando con Firebase...');
            allPacientes = pacientesLocal;
            window.allPacientes = allPacientes;
            
            // Sincronizar datos locales con Firebase
            for (const paciente of pacientesLocal) {
              try {
                await savePacienteToFirestore(paciente);
                console.log('‚úÖ Paciente local sincronizado:', paciente.nombre);
              } catch (syncError) {
                console.error('‚ùå Error sincronizando paciente local:', paciente.nombre, syncError);
              }
            }
            
            console.log('üéâ Sincronizaci√≥n de datos locales completada');
          }
        }
        
        renderPacienteSelector();
        
      } catch (error) {
        console.error('‚ùå Error al cargar pacientes desde Firebase:', error);
        console.log('üíæ Cargando desde localStorage como fallback...');
        
        // FALLBACK: Cargar desde localStorage si Firebase falla
        const pacientesLocal = loadFromLocalStorage(STORAGE_KEYS.PACIENTES);
        if (pacientesLocal && Array.isArray(pacientesLocal)) {
          allPacientes = pacientesLocal;
          window.allPacientes = allPacientes;
          console.log('‚úÖ Pacientes cargados desde localStorage:', allPacientes.length);
          console.log('‚ö†Ô∏è MODO OFFLINE - Los datos se sincronizar√°n cuando Firebase funcione');
        } else {
          console.log('‚ÑπÔ∏è No hay pacientes en localStorage');
          allPacientes = [];
          window.allPacientes = [];
        }
        renderPacienteSelector();
      }
    }

    // Funci√≥n ROBUSTA para sincronizar con Firebase usando REST API como alternativa
    async function syncWithFirebaseREST(paciente) {
      if (!currentUser) return false;
      
      try {
        console.log('üîÑ Intentando sincronizaci√≥n con REST API...');
        
        // Obtener token de autenticaci√≥n
        const idToken = await currentUser.getIdToken();
        
        // URL de la REST API de Firestore
        const url = `https://firestore.googleapis.com/v1/projects/clinical-70644/databases/(default)/documents/users/${currentUser.uid}/pacientes/${paciente.id}`;
        
        const response = await fetch(url, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: convertToFirestoreFormat(paciente)
          })
        });
        
        if (response.ok) {
          console.log('‚úÖ Sincronizaci√≥n REST exitosa para:', paciente.nombre);
          return true;
        } else {
          console.error('‚ùå Error REST:', response.status, response.statusText);
          return false;
        }
        
      } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n REST:', error);
        return false;
      }
    }

    // Convertir objeto a formato Firestore
    function convertToFirestoreFormat(obj) {
      const result = {};
      
      for (const [key, value] of Object.entries(obj)) {
        if (value === null || value === undefined) {
          result[key] = { nullValue: null };
        } else if (typeof value === 'string') {
          result[key] = { stringValue: value };
        } else if (typeof value === 'number') {
          result[key] = { doubleValue: value };
        } else if (typeof value === 'boolean') {
          result[key] = { booleanValue: value };
        } else if (Array.isArray(value)) {
          result[key] = { 
            arrayValue: { 
              values: value.map(item => ({ stringValue: JSON.stringify(item) }))
            }
          };
        } else if (typeof value === 'object') {
          result[key] = { stringValue: JSON.stringify(value) };
        } else {
          result[key] = { stringValue: String(value) };
        }
      }
      
      return result;
    }

    // Funci√≥n MEJORADA para sincronizar datos locales con Firebase
    async function syncLocalDataToFirebase() {
      if (!currentUser) {
        console.log('‚ö†Ô∏è No hay usuario para sincronizar');
        return;
      }
      
      console.log('üîÑ INICIANDO SINCRONIZACI√ìN COMPLETA...');
      console.log('üîê Usuario:', currentUser.email);
      
      try {
        const pacientesLocal = loadFromLocalStorage(STORAGE_KEYS.PACIENTES) || [];
        
        if (pacientesLocal.length > 0) {
          console.log(`üìä Sincronizando ${pacientesLocal.length} pacientes locales...`);
          
          let sincronizados = 0;
          let errores = 0;
          
          for (const paciente of pacientesLocal) {
            try {
              // Intentar m√©todo normal de Firebase primero
              await savePacienteToFirestore(paciente);
              sincronizados++;
              console.log(`‚úÖ [${sincronizados}/${pacientesLocal.length}] Sincronizado (Firebase):`, paciente.nombre);
            } catch (firebaseError) {
              console.log('‚ö†Ô∏è Firebase fall√≥, intentando REST API...');
              
              // Intentar con REST API como alternativa
              const restSuccess = await syncWithFirebaseREST(paciente);
              if (restSuccess) {
                sincronizados++;
                console.log(`‚úÖ [${sincronizados}/${pacientesLocal.length}] Sincronizado (REST):`, paciente.nombre);
              } else {
                errores++;
                console.error(`‚ùå [${errores}] Ambos m√©todos fallaron para:`, paciente.nombre);
              }
            }
          }
          
          console.log('üéâ SINCRONIZACI√ìN COMPLETADA');
          console.log(`‚úÖ Exitosos: ${sincronizados}`);
          console.log(`‚ùå Errores: ${errores}`);
          
          if (sincronizados > 0) {
            alert(`üåê Sincronizaci√≥n completada:\n‚úÖ ${sincronizados} pacientes sincronizados\nüì± Ahora disponibles en todos tus dispositivos\n\nüîë Para ver en celular:\n1. Abre https://clinical-data.vercel.app/\n2. Inicia sesi√≥n con la MISMA cuenta\n3. Los datos aparecer√°n autom√°ticamente`);
          } else {
            alert('‚ùå No se pudo sincronizar ning√∫n paciente. Verifica tu conexi√≥n a internet y las reglas de Firebase.');
          }
          
        } else {
          console.log('‚ÑπÔ∏è No hay datos locales para sincronizar');
          alert('‚ÑπÔ∏è No hay datos locales para sincronizar');
        }
      } catch (error) {
        console.error('‚ùå Error cr√≠tico en sincronizaci√≥n:', error);
        alert('‚ùå Error cr√≠tico en sincronizaci√≥n. Revisa la consola para detalles.');
      }
    }

    // Funci√≥n para sincronizar con servicio alternativo
    async function syncWithAlternativeService() {
      if (!currentUser) {
        console.log('‚ùå No hay usuario para sincronizar');
        return false;
      }

      try {
        console.log('üåê Sincronizando con servicio alternativo...');
        
        const dataToSync = {
          pacientes: allPacientes || [],
          recordatorios: allRecordatorios || [],
          citas: allCitas || []
        };

        const success = await window.syncService.saveUserData(currentUser.email, dataToSync);
        
        if (success) {
          console.log('‚úÖ SINCRONIZACI√ìN ALTERNATIVA EXITOSA');
          return true;
        } else {
          console.error('‚ùå Fall√≥ sincronizaci√≥n alternativa');
          return false;
        }

      } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n alternativa:', error);
        return false;
      }
    }

    // Funci√≥n para cargar desde servicio alternativo
    async function loadFromAlternativeService() {
      if (!currentUser) {
        console.log('‚ùå No hay usuario para cargar');
        return false;
      }

      try {
        console.log('üì• Cargando desde servicio alternativo...');
        
        const data = await window.syncService.loadUserData(currentUser.email);
        
        if (data && data.pacientes) {
          allPacientes = data.pacientes || [];
          allRecordatorios = data.recordatorios || [];
          allCitas = data.citas || [];
          
          // Sincronizar variables globales
          window.allPacientes = allPacientes;
          window.allRecordatorios = allRecordatorios;
          window.allCitas = allCitas;
          
          console.log('‚úÖ DATOS CARGADOS DESDE SERVICIO ALTERNATIVO');
          console.log('üìä Pacientes:', allPacientes.length);
          
          renderPacienteSelector();
          return true;
        } else {
          console.log('‚ÑπÔ∏è No hay datos en servicio alternativo');
          return false;
        }

      } catch (error) {
        console.error('‚ùå Error cargando desde servicio alternativo:', error);
        return false;
      }
    }

    // Funci√≥n para forzar sincronizaci√≥n manual MEJORADA
    window.forceSyncData = async function() {
      if (!currentUser) {
        alert('‚ùå Debes estar autenticado para sincronizar');
        return;
      }
      
      console.log('üîÑ FORZANDO SINCRONIZACI√ìN COMPLETA...');
      alert('üîÑ Iniciando sincronizaci√≥n completa...\n\n‚è≥ Esto puede tardar unos segundos...');
      
      let firebaseSuccess = false;
      let alternativeSuccess = false;
      
      // Intentar Firebase primero
      try {
        await syncLocalDataToFirebase();
        firebaseSuccess = true;
        console.log('‚úÖ Sincronizaci√≥n Firebase exitosa');
      } catch (error) {
        console.log('‚ùå Firebase fall√≥, intentando servicio alternativo...');
        
        // Intentar servicio alternativo
        alternativeSuccess = await syncWithAlternativeService();
      }
      
      // Mensaje final
      if (firebaseSuccess) {
        alert('‚úÖ Sincronizaci√≥n completada con Firebase!\nüì± Los datos est√°n disponibles en todos tus dispositivos.');
      } else if (alternativeSuccess) {
        alert('‚úÖ Sincronizaci√≥n completada con servicio alternativo!\nüì± Los datos est√°n disponibles en todos tus dispositivos.\n\nüí° Firebase tiene problemas, pero tus datos est√°n seguros.');
      } else {
        alert('‚ùå No se pudo sincronizar con ning√∫n servicio.\nüíæ Los datos est√°n guardados localmente.\nüîÑ Intenta m√°s tarde cuando mejore la conexi√≥n.');
      }
    };

    // Funci√≥n para cargar datos desde todos los servicios
    window.loadAllData = async function() {
      if (!currentUser) {
        console.log('‚ö†Ô∏è No hay usuario, cargando solo datos locales');
        loadLocalData();
        return;
      }

      console.log('üì• Cargando datos desde todos los servicios...');
      
      let firebaseLoaded = false;
      let alternativeLoaded = false;
      
      // Intentar cargar desde Firebase
      try {
        await loadPacientesFromFirestore();
        if (allPacientes.length > 0) {
          firebaseLoaded = true;
          console.log('‚úÖ Datos cargados desde Firebase');
        }
      } catch (error) {
        console.log('‚ùå Firebase fall√≥ para carga');
      }
      
      // Si Firebase no tiene datos, intentar servicio alternativo
      if (!firebaseLoaded) {
        console.log('üîÑ Intentando cargar desde servicio alternativo...');
        alternativeLoaded = await loadFromAlternativeService();
      }
      
      // Si ning√∫n servicio tiene datos, cargar desde localStorage
      if (!firebaseLoaded && !alternativeLoaded) {
        console.log('üì¶ Cargando desde localStorage como √∫ltimo recurso...');
        loadLocalData();
      }
      
      console.log('üìä Datos finales cargados:', {
        pacientes: allPacientes.length,
        fuente: firebaseLoaded ? 'Firebase' : alternativeLoaded ? 'Servicio alternativo' : 'localStorage'
      });
    };

    // Cargar datos cuando el usuario se autentica
    const originalLoadUserData = loadUserData;
    loadUserData = async function() {
      if (originalLoadUserData) await originalLoadUserData();
      
      // Usar la nueva funci√≥n de carga completa
      await window.loadAllData();
      
      // Intentar sincronizaci√≥n autom√°tica despu√©s de cargar
      setTimeout(async () => {
        if (allPacientes.length > 0) {
          console.log('üîÑ Sincronizaci√≥n autom√°tica iniciada...');
          await window.forceSyncData();
        }
      }, 3000);
    };

    // Sistema robusto de localStorage
    const STORAGE_KEYS = {
      PACIENTES: 'clinical_data_pacientes_v2',
      RECORDATORIOS: 'clinical_data_recordatorios_v2',
      CITAS: 'clinical_data_citas_v2',
      LAST_SAVE: 'clinical_data_last_save'
    };

    // Funci√≥n para guardar datos en localStorage de forma segura
    function saveToLocalStorage(key, data) {
      try {
        const dataToSave = {
          data: data,
          timestamp: new Date().toISOString(),
          version: '2.0'
        };
        localStorage.setItem(key, JSON.stringify(dataToSave));
        localStorage.setItem(STORAGE_KEYS.LAST_SAVE, new Date().toISOString());
        console.log(`üíæ Guardado en localStorage [${key}]:`, Array.isArray(data) ? data.length : 'objeto', 'elementos');
        return true;
      } catch (error) {
        console.error(`‚ùå Error guardando en localStorage [${key}]:`, error);
        return false;
      }
    }

    // Funci√≥n para cargar datos desde localStorage de forma segura
    function loadFromLocalStorage(key) {
      try {
        const stored = localStorage.getItem(key);
        if (!stored) {
          console.log(`‚ÑπÔ∏è No hay datos en localStorage para [${key}]`);
          return null;
        }

        const parsed = JSON.parse(stored);
        
        // Verificar formato nuevo
        if (parsed.data && parsed.timestamp) {
          console.log(`‚úÖ Datos cargados desde localStorage [${key}]:`, Array.isArray(parsed.data) ? parsed.data.length : 'objeto', 'elementos');
          return parsed.data;
        }
        
        // Formato antiguo (compatibilidad)
        if (Array.isArray(parsed)) {
          console.log(`‚úÖ Datos legacy cargados desde localStorage [${key}]:`, parsed.length, 'elementos');
          return parsed;
        }

        return null;
      } catch (error) {
        console.error(`‚ùå Error cargando desde localStorage [${key}]:`, error);
        return null;
      }
    }

    // Cargar datos desde localStorage al inicializar
    function loadLocalData() {
      console.log('üì¶ Cargando datos desde localStorage...');
      
      // Cargar pacientes
      const pacientesLocal = loadFromLocalStorage(STORAGE_KEYS.PACIENTES);
      if (pacientesLocal && Array.isArray(pacientesLocal)) {
        allPacientes = pacientesLocal;
        console.log('‚úÖ Pacientes cargados:', allPacientes.length);
      } else {
        allPacientes = [];
        console.log('‚ÑπÔ∏è No hay pacientes en localStorage');
      }
      
      // Cargar recordatorios
      const recordatoriosLocal = loadFromLocalStorage(STORAGE_KEYS.RECORDATORIOS);
      if (recordatoriosLocal && Array.isArray(recordatoriosLocal)) {
        allRecordatorios = recordatoriosLocal;
        console.log('‚úÖ Recordatorios cargados:', allRecordatorios.length);
      } else {
        allRecordatorios = [];
        console.log('‚ÑπÔ∏è No hay recordatorios en localStorage');
      }
      
      // Cargar citas
      const citasLocal = loadFromLocalStorage(STORAGE_KEYS.CITAS);
      if (citasLocal && Array.isArray(citasLocal)) {
        allCitas = citasLocal;
        console.log('‚úÖ Citas cargadas:', allCitas.length);
      } else {
        allCitas = [];
        console.log('‚ÑπÔ∏è No hay citas en localStorage');
      }

      // Mostrar resumen
      console.log('üìä Resumen de datos locales cargados:', {
        pacientes: allPacientes.length,
        recordatorios: allRecordatorios.length,
        citas: allCitas.length
      });
    }

    // Inicializar la aplicaci√≥n m√©dica
    function initMedicalApp() {
      console.log('üöÄ Inicializando aplicaci√≥n m√©dica...');
      
      // Verificar variables globales cr√≠ticas
      if (typeof allPacientes === 'undefined') {
        console.log('‚ö†Ô∏è allPacientes no definido, inicializando...');
        window.allPacientes = [];
      }
      
      if (typeof allRecordatorios === 'undefined') {
        console.log('‚ö†Ô∏è allRecordatorios no definido, inicializando...');
        window.allRecordatorios = [];
      }
      
      if (typeof allCitas === 'undefined') {
        console.log('‚ö†Ô∏è allCitas no definido, inicializando...');
        window.allCitas = [];
      }
      
      if (typeof availableColors === 'undefined') {
        console.error('‚ùå availableColors no definido - error cr√≠tico');
        return;
      }
      
      // CR√çTICO: Cargar datos locales SIEMPRE al inicializar
      loadLocalData();
      
      console.log('üìä Estado inicial:', {
        pacientes: allPacientes.length,
        recordatorios: allRecordatorios.length,
        citas: allCitas.length,
        colores: availableColors.length,
        currentUser: !!currentUser,
        isAuthenticated
      });
      
      renderPacienteSelector();
      renderColorPicker();
      
      console.log('‚úÖ Aplicaci√≥n m√©dica inicializada correctamente');
    }

    // ===== SISTEMA DE GR√ÅFICOS =====
    
    function renderEvolutionChart() {
      if (!selectedPaciente) return;
      
      const ctx = document.getElementById('chartEvolucion');
      if (!ctx) return;

      // Destruir gr√°fico anterior si existe
      if (currentChart) {
        currentChart.destroy();
      }

      // Recopilar datos de evoluci√≥n
      const visitasData = [];
      if (selectedPaciente.visitas) {
        Object.values(selectedPaciente.visitas).forEach(visits => {
          visits.forEach(visit => {
            visitasData.push({
              date: visit.date,
              estado: visit.estado,
              tipo: visit.visitType
            });
          });
        });
      }

      visitasData.sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = visitasData.map(v => new Date(v.date).toLocaleDateString('es-ES'));
      const estadoValues = visitasData.map(v => {
        switch(v.estado) {
          case 'critico': return 1;
          case 'observacion': return 2;
          case 'estable': return 3;
          case 'mejoria': return 4;
          case 'alta': return 5;
          default: return 3;
        }
      });

      const tipoColors = visitasData.map(v => visitTypes.find(t => t.value === v.tipo)?.color || '#gray');

      currentChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Evoluci√≥n del Estado Cl√≠nico',
            data: estadoValues,
            borderColor: '#4ade80',
            backgroundColor: tipoColors.map(color => color + '20'),
            tension: 0.1,
            pointBackgroundColor: tipoColors,
            pointBorderColor: tipoColors,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: 6,
              ticks: {
                stepSize: 1,
                callback: function(value) {
                  const estados = ['', 'Cr√≠tico', 'Observaci√≥n', 'Estable', 'Mejor√≠a', 'Alta'];
                  return estados[value] || '';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const estados = ['', 'Cr√≠tico', 'Observaci√≥n', 'Estable', 'Mejor√≠a', 'Alta'];
                  const visit = visitasData[context.dataIndex];
                  return `${estados[context.parsed.y]} - ${visitTypes.find(t => t.value === visit.tipo)?.label}`;
                }
              }
            }
          }
        }
      });
    }

    // ===== SISTEMA DE RECORDATORIOS =====
    
    function showRecordatorios() {
      populateRecordatoriosPacientes();
      renderRecordatoriosList();
      document.getElementById('recordatoriosModal').style.display = 'block';
    }

    function closeRecordatoriosModal() {
      document.getElementById('recordatoriosModal').style.display = 'none';
    }

    // ===== FUNCIONES DEL MODAL DE INFORMACI√ìN =====
    
    function showSoftwareInfo() {
      document.getElementById('softwareInfoModal').style.display = 'block';
    }

    function closeSoftwareInfoModal() {
      document.getElementById('softwareInfoModal').style.display = 'none';
    }

    // Cerrar modal de informaci√≥n al hacer click fuera de √©l
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('softwareInfoModal');
      if (event.target === modal) {
        closeSoftwareInfoModal();
      }
    });

    function populateRecordatoriosPacientes() {
      const select = document.getElementById('recordatorioPaciente');
      select.innerHTML = '<option value="">Seleccionar paciente...</option>';
      
      allPacientes.forEach(paciente => {
        const option = document.createElement('option');
        option.value = paciente.id;
        option.textContent = `${paciente.nombre} (${paciente.dni})`;
        select.appendChild(option);
      });
    }

    async function crearRecordatorio() {
      const pacienteId = document.getElementById('recordatorioPaciente').value;
      const fecha = document.getElementById('recordatorioFecha').value;
      const hora = document.getElementById('recordatorioHora').value;
      const nota = document.getElementById('recordatorioNota').value.trim();

      if (!pacienteId || !fecha || !nota) {
        alert('Todos los campos son obligatorios');
        return;
      }

      const paciente = allPacientes.find(p => p.id === pacienteId);
      if (!paciente) return;

      const recordatorio = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        pacienteId,
        pacienteNombre: paciente.nombre,
        fecha,
        hora,
        nota,
        completado: false,
        timestamp: new Date().toISOString()
      };

      try {
        if (currentUser) {
          await db.collection('users').doc(currentUser.uid)
                   .collection('recordatorios').doc(recordatorio.id)
                   .set(recordatorio);
        }

        allRecordatorios.push(recordatorio);
        
        // Limpiar formulario
        document.getElementById('recordatorioPaciente').value = '';
        document.getElementById('recordatorioFecha').value = '';
        document.getElementById('recordatorioHora').value = '09:00';
        document.getElementById('recordatorioNota').value = '';
        
        renderRecordatoriosList();
        renderProximosRecordatorios();
        
        // Programar notificaci√≥n
        scheduleNotification(recordatorio);
        
        alert('‚úÖ Recordatorio creado exitosamente');
      } catch (error) {
        console.error('Error al crear recordatorio:', error);
        alert('Error al crear el recordatorio. Intenta de nuevo.');
      }
    }

    function renderRecordatoriosList() {
      const container = document.getElementById('recordatoriosList');
      if (!container) return;

      const recordatoriosPendientes = allRecordatorios
        .filter(r => !r.completado)
        .sort((a, b) => new Date(a.fecha + ' ' + a.hora) - new Date(b.fecha + ' ' + b.hora));

      if (recordatoriosPendientes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay recordatorios pendientes</p>';
        return;
      }

      container.innerHTML = recordatoriosPendientes.map(recordatorio => {
        const fechaRecordatorio = new Date(recordatorio.fecha + ' ' + recordatorio.hora);
        const hoy = new Date();
        const esHoy = fechaRecordatorio.toDateString() === hoy.toDateString();
        const esUrgente = fechaRecordatorio < hoy;
        
        let className = 'recordatorio-item';
        if (esUrgente) className += ' urgent';
        else if (esHoy) className += ' today';

        return `
          <div class="${className}">
            <div>
              <strong>${recordatorio.pacienteNombre}</strong><br>
              <small>${new Date(recordatorio.fecha).toLocaleDateString('es-ES')} ${recordatorio.hora}</small><br>
              ${recordatorio.nota}
            </div>
            <div>
              <button onclick="completarRecordatorio('${recordatorio.id}')" class="btn-secondary">‚úÖ</button>
              <button onclick="eliminarRecordatorio('${recordatorio.id}')" class="btn-danger">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderProximosRecordatorios() {
      const container = document.getElementById('proximosRecordatorios');
      if (!container || !selectedPaciente) return;

      const recordatoriosPaciente = allRecordatorios
        .filter(r => r.pacienteId === selectedPaciente.id && !r.completado)
        .sort((a, b) => new Date(a.fecha + ' ' + a.hora) - new Date(b.fecha + ' ' + b.hora))
        .slice(0, 3);

      if (recordatoriosPaciente.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">No hay recordatorios pendientes para este paciente</p>';
        return;
      }

      container.innerHTML = recordatoriosPaciente.map(recordatorio => `
        <div class="recordatorio-item" style="margin: 4px 0;">
          <div>
            <strong>${new Date(recordatorio.fecha).toLocaleDateString('es-ES')} ${recordatorio.hora}</strong><br>
            <small>${recordatorio.nota}</small>
          </div>
        </div>
      `).join('');
    }

    async function completarRecordatorio(recordatorioId) {
      const recordatorio = allRecordatorios.find(r => r.id === recordatorioId);
      if (!recordatorio) return;

      recordatorio.completado = true;

      try {
        if (currentUser) {
          await db.collection('users').doc(currentUser.uid)
                   .collection('recordatorios').doc(recordatorioId)
                   .update({ completado: true });
        }

        renderRecordatoriosList();
        renderProximosRecordatorios();
      } catch (error) {
        console.error('Error al completar recordatorio:', error);
      }
    }

    async function eliminarRecordatorio(recordatorioId) {
      if (!confirm('¬øEliminar este recordatorio?')) return;

      try {
        if (currentUser) {
          await db.collection('users').doc(currentUser.uid)
                   .collection('recordatorios').doc(recordatorioId)
                   .delete();
        }

        allRecordatorios = allRecordatorios.filter(r => r.id !== recordatorioId);
        renderRecordatoriosList();
        renderProximosRecordatorios();
      } catch (error) {
        console.error('Error al eliminar recordatorio:', error);
      }
    }

    function scheduleNotification(recordatorio) {
      if ('Notification' in window && Notification.permission === 'granted') {
        const fechaRecordatorio = new Date(recordatorio.fecha + ' ' + recordatorio.hora);
        const ahora = new Date();
        const tiempoHasta = fechaRecordatorio.getTime() - ahora.getTime();

        if (tiempoHasta > 0) {
          setTimeout(() => {
            new Notification('Recordatorio M√©dico', {
              body: `${recordatorio.pacienteNombre}: ${recordatorio.nota}`,
              icon: '/favicon.svg'
            });
          }, tiempoHasta);
        }
      }
    }

    // ===== SISTEMA DE CALENDARIO Y CITAS =====
    
    function showCalendario() {
      populateCitasPacientes();
      renderCalendario();
      renderCitasList();
      document.getElementById('calendarioSection').style.display = 'block';
      document.getElementById('pacienteSelector').style.display = 'none';
      document.getElementById('fichaClinica').style.display = 'none';
      document.getElementById('visitForm').style.display = 'none';
    }

    function backToPacientes() {
      document.getElementById('calendarioSection').style.display = 'none';
      document.getElementById('pacienteSelector').style.display = 'block';
      
      if (selectedPaciente) {
        showFichaClinica();
      }
    }

    function populateCitasPacientes() {
      const select = document.getElementById('citaPaciente');
      select.innerHTML = '<option value="">Seleccionar paciente...</option>';
      
      allPacientes.forEach(paciente => {
        const option = document.createElement('option');
        option.value = paciente.id;
        option.textContent = `${paciente.nombre} (${paciente.dni})`;
        select.appendChild(option);
      });
    }

    function renderCalendario() {
      const container = document.getElementById('calendarioGrid');
      if (!container) return;

      const hoy = new Date();
      const a√±o = hoy.getFullYear();
      const mes = hoy.getMonth();
      
      const primerDia = new Date(a√±o, mes, 1);
      const ultimoDia = new Date(a√±o, mes + 1, 0);
      const primerDiaSemana = primerDia.getDay();

      container.innerHTML = '';

      // Headers de d√≠as de la semana
      ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].forEach(dia => {
        const header = document.createElement('div');
        header.textContent = dia;
        header.style.fontWeight = 'bold';
        header.style.padding = '8px';
        header.style.textAlign = 'center';
        header.style.background = 'var(--primary)';
        header.style.color = 'white';
        container.appendChild(header);
      });

      // D√≠as vac√≠os del mes anterior
      for (let i = 0; i < primerDiaSemana; i++) {
        const dia = document.createElement('div');
        dia.className = 'calendar-day other-month';
        container.appendChild(dia);
      }

      // D√≠as del mes actual
      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const diaElement = document.createElement('div');
        diaElement.className = 'calendar-day';
        diaElement.textContent = dia;

        const fechaDia = new Date(a√±o, mes, dia);
        const fechaString = fechaDia.toISOString().split('T')[0];

        // Marcar d√≠a actual
        if (fechaDia.toDateString() === hoy.toDateString()) {
          diaElement.classList.add('today');
        }

        // Verificar si hay citas este d√≠a
        const citasDelDia = allCitas.filter(c => c.fecha === fechaString);
        if (citasDelDia.length > 0) {
          diaElement.classList.add('has-cita');
          const dot = document.createElement('div');
          dot.className = 'cita-dot';
          diaElement.appendChild(dot);
        }

        diaElement.addEventListener('click', () => {
          document.getElementById('citaFecha').value = fechaString;
        });

        container.appendChild(diaElement);
      }
    }

    async function crearCita() {
      const pacienteId = document.getElementById('citaPaciente').value;
      const fecha = document.getElementById('citaFecha').value;
      const hora = document.getElementById('citaHora').value;

      if (!pacienteId || !fecha) {
        alert('Paciente y fecha son obligatorios');
        return;
      }

      const paciente = allPacientes.find(p => p.id === pacienteId);
      if (!paciente) return;

      const cita = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        pacienteId,
        pacienteNombre: paciente.nombre,
        fecha,
        hora,
        timestamp: new Date().toISOString()
      };

      try {
        if (currentUser) {
          await db.collection('users').doc(currentUser.uid)
                   .collection('citas').doc(cita.id)
                   .set(cita);
        }

        allCitas.push(cita);
        
        // Limpiar formulario
        document.getElementById('citaPaciente').value = '';
        document.getElementById('citaFecha').value = '';
        document.getElementById('citaHora').value = '09:00';
        
        renderCalendario();
        renderCitasList();
        
        alert('‚úÖ Cita creada exitosamente');
      } catch (error) {
        console.error('Error al crear cita:', error);
        alert('Error al crear la cita. Intenta de nuevo.');
      }
    }

    function renderCitasList() {
      const container = document.getElementById('citasList');
      if (!container) return;

      const citasOrdenadas = [...allCitas]
        .sort((a, b) => new Date(a.fecha + ' ' + a.hora) - new Date(b.fecha + ' ' + b.hora));

      if (citasOrdenadas.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay citas programadas</p>';
        return;
      }

      const hoy = new Date();
      container.innerHTML = citasOrdenadas.map(cita => {
        const fechaCita = new Date(cita.fecha + ' ' + cita.hora);
        const esHoy = fechaCita.toDateString() === hoy.toDateString();
        const esPasada = fechaCita < hoy;
        
        let className = 'cita-item';
        if (esPasada) className += ' past';
        else if (esHoy) className += ' today';

        return `
          <div class="${className}">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${cita.pacienteNombre}</strong><br>
                <small>${new Date(cita.fecha).toLocaleDateString('es-ES')} ${cita.hora}</small>
              </div>
              <button onclick="eliminarCita('${cita.id}')" class="btn-danger">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function eliminarCita(citaId) {
      if (!confirm('¬øEliminar esta cita?')) return;

      try {
        if (currentUser) {
          await db.collection('users').doc(currentUser.uid)
                   .collection('citas').doc(citaId)
                   .delete();
        }

        allCitas = allCitas.filter(c => c.id !== citaId);
        renderCalendario();
        renderCitasList();
      } catch (error) {
        console.error('Error al eliminar cita:', error);
      }
    }

    // ===== CARGA DE DATOS DESDE FIREBASE =====
    
    async function loadRecordatoriosFromFirestore() {
      if (!currentUser) return;
      
      try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                 .collection('recordatorios').get();
        
        allRecordatorios = [];
        snapshot.forEach(doc => {
          allRecordatorios.push(doc.data());
        });
      } catch (error) {
        console.error('Error al cargar recordatorios:', error);
      }
    }

    async function loadCitasFromFirestore() {
      if (!currentUser) return;
      
      try {
        const snapshot = await db.collection('users').doc(currentUser.uid)
                                 .collection('citas').get();
        
        allCitas = [];
        snapshot.forEach(doc => {
          allCitas.push(doc.data());
        });
      } catch (error) {
        console.error('Error al cargar citas:', error);
      }
    }

    // Actualizar showFichaClinica para incluir gr√°ficos y recordatorios
    const originalShowFichaClinica = showFichaClinica;
    showFichaClinica = function() {
      originalShowFichaClinica();
      setTimeout(() => {
        renderEvolutionChart();
        renderProximosRecordatorios();
      }, 100);
    };

    // Actualizar loadUserData para cargar todos los datos
    const originalLoadUserData2 = loadUserData;
    loadUserData = async function() {
      if (originalLoadUserData2) await originalLoadUserData2();
      await loadPacientesFromFirestore();
      await loadRecordatoriosFromFirestore();
      await loadCitasFromFirestore();
    };

    // Solicitar permisos de notificaci√≥n
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Funci√≥n para inicializar datos sin autenticaci√≥n
    function initOfflineMode() {
      console.log('üîÑ Iniciando modo offline...');
      loadLocalData();
      renderPacienteSelector();
      console.log('‚úÖ Modo offline inicializado');
    }

    // Ejecutar cuando se carga la app
    setTimeout(initMedicalApp, 1000);
    
    // Tambi√©n cargar datos locales inmediatamente al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM cargado, iniciando datos locales...');
      initOfflineMode();
    });
    
    // Fallback si DOMContentLoaded ya pas√≥
    if (document.readyState === 'loading') {
      // DOM a√∫n se est√° cargando
    } else {
      // DOM ya est√° listo
      console.log('üìÑ DOM ya estaba listo, iniciando datos locales...');
      setTimeout(initOfflineMode, 100);
    }

    // Enganches de respaldo local tras cargas de Firestore
    const _loadUserData = window.loadUserData;
    window.loadUserData = async function(){
      try { if (_loadUserData) await _loadUserData(); } catch {}
      try {
        window.backupAfterAction({
          pacientes: (window.allPacientes || []),
          recordatorios: (window.allRecordatorios || []),
          citas: (window.allCitas || [])
        });
      } catch {}
    };
  </script>

  <script>
    // ===== RESPALDO LOCAL Y SINCRONIZACI√ìN =====
    (function(){
      const KEY_PACIENTES = 'backup_pacientes';
      const KEY_RECORDATORIOS = 'backup_recordatorios';
      const KEY_CITAS = 'backup_citas';

      function safeGet(key, fallback) {
        try { return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback; } catch { return fallback; }
      }
      function safeSet(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.warn('No se pudo escribir backup local', key, e); }
      }

      // Hook de guardado inmediato tras cada acci√≥n
      window.backupAfterAction = function(state){
        if (!state) return;
        if (state.pacientes) safeSet(KEY_PACIENTES, state.pacientes);
        if (state.recordatorios) safeSet(KEY_RECORDATORIOS, state.recordatorios);
        if (state.citas) safeSet(KEY_CITAS, state.citas);
      };

      // Restaurar de backup local al iniciar si Firestore no est√° disponible
      window.restoreFromBackupIfNeeded = function(){
        try {
          const offline = typeof firebase === 'undefined' || !window.db || !window.auth || (firebase.firestore && firebase.firestore._isTerminated);
          if (offline) {
            window.allPacientes = safeGet(KEY_PACIENTES, window.allPacientes || []);
            window.allRecordatorios = safeGet(KEY_RECORDATORIOS, window.allRecordatorios || []);
            window.allCitas = safeGet(KEY_CITAS, window.allCitas || []);
            console.log('‚úîÔ∏è Datos restaurados desde backup local (modo offline)');
          }
        } catch (e) {
          console.warn('No se pudo restaurar backup local:', e);
        }
      };

      // Sincronizar cuando vuelve la conexi√≥n
      window.addEventListener('online', async () => {
        if (!window.db || !window.auth || !window.auth.currentUser) return;
        const uid = window.auth.currentUser.uid;
        try {
          const pacientes = safeGet(KEY_PACIENTES, null);
          if (Array.isArray(pacientes)) {
            for (const p of pacientes) {
              await db.collection('users').doc(uid).collection('pacientes').doc(p.id).set(p, { merge: true });
            }
          }
          const recordatorios = safeGet(KEY_RECORDATORIOS, null);
          if (Array.isArray(recordatorios)) {
            for (const r of recordatorios) {
              await db.collection('users').doc(uid).collection('recordatorios').doc(r.id).set(r, { merge: true });
            }
          }
          const citas = safeGet(KEY_CITAS, null);
          if (Array.isArray(citas)) {
            for (const c of citas) {
              await db.collection('users').doc(uid).collection('citas').doc(c.id).set(c, { merge: true });
            }
          }
          console.log('üîÑ Sincronizaci√≥n de backups locales completada');
        } catch (e) {
          console.warn('Fallo al sincronizar backups locales:', e);
        }
      });

      // Intentar restaurar en el arranque temprano
      try { window.restoreFromBackupIfNeeded(); } catch {}
    })();
  </script>

  <!-- Modal para crear/editar paciente -->
  <div id="modalPaciente" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal" onclick="cerrarModalPaciente()">&times;</span>
      <h3 id="tituloModalPaciente">Nuevo Paciente</h3>
      <form id="formPacienteModal">
        <input type="hidden" id="modalPacienteId">
        <input type="text" id="modalPacienteNombre" placeholder="Nombre completo" required>
        <input type="text" id="modalPacienteDNI" placeholder="DNI" required>
        <input type="text" id="modalPacienteDireccion" placeholder="Direcci√≥n">
        <input type="tel" id="modalPacienteTelefono" placeholder="Tel√©fono">
        <input type="text" id="modalPacienteObraSocial" placeholder="Obra Social">
        <input type="text" id="modalPacientePatologia" placeholder="Patolog√≠a principal">
        <button type="submit" class="btn-primary">Guardar Paciente</button>
        <button type="button" onclick="cerrarModalPaciente()" class="btn-secondary">Cancelar</button>
      </form>
    </div>
  </div>
</body>
</html>

